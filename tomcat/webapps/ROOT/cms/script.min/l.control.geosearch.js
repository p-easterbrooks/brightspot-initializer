L.GeoSearch={},L.GeoSearch.Provider={},L.GeoSearch.Result=function(e,t,o,s){this.X=e,this.Y=t,this.Label=o,this.bounds=s},L.Control.GeoSearch=L.Control.extend({options:{position:"topcenter",showMarker:!0,retainZoomLevel:!1,draggable:!1},_config:{country:"",searchLabel:"search for address ...",notFoundMessage:"Sorry, that address could not be found.",messageHideDelay:3e3,zoomLevel:18},initialize:function(e){L.Util.extend(this.options,e),L.Util.extend(this._config,e)},onAdd:function(e){for(var t=e._controlContainer,o=t.childNodes,s=!1,n=0,i=o.length;i>n;n++){var r=o[n].className;if(/leaflet-top/.test(r)&&/leaflet-center/.test(r)){s=!0;break}}if(!s){var a=document.createElement("div");a.className+="leaflet-top leaflet-center",t.appendChild(a),e._controlCorners.topcenter=a}this._map=e,this._container=L.DomUtil.create("div","leaflet-control-geosearch");var c=document.createElement("input");c.id="leaflet-control-geosearch-qry",c.type="text",c.placeholder=this._config.searchLabel,this._searchbox=c;var l=document.createElement("div");l.id="leaflet-control-geosearch-msg",l.className="leaflet-control-geosearch-msg",this._msgbox=l;var h=document.createElement("ul");return h.id="leaflet-control-geosearch-results",this._resultslist=h,this._msgbox.appendChild(this._resultslist),this._container.appendChild(this._searchbox),this._container.appendChild(this._msgbox),L.DomEvent.addListener(this._container,"click",L.DomEvent.stop).addListener(this._searchbox,"keypress",this._onKeyUp,this),L.DomEvent.disableClickPropagation(this._container),this._container},geosearch:function(e){var t=this;try{var o=this._config.provider;if("function"==typeof o.GetLocations){o.GetLocations(e,function(e){t._processResults(e)})}else{var s=o.GetServiceUrl(e);this.sendRequest(o,s)}}catch(n){this._printError(n)}},sendRequest:function(e,t){function o(e){e+="&callback=parseLocation";var t=document.createElement("script");t.id="getJsonP",t.src=e,t.async=!0,document.body.appendChild(t)}var s=this;if(window.parseLocation=function(t){var o=e.ParseJSON(t);s._processResults(o),document.body.removeChild(document.getElementById("getJsonP")),delete window.parseLocation},XMLHttpRequest){var n=new XMLHttpRequest;if("withCredentials"in n){var n=new XMLHttpRequest;n.onreadystatechange=function(){if(4==n.readyState)if(200==n.status){var i=JSON.parse(n.responseText),r=e.ParseJSON(i);s._processResults(r)}else 0==n.status||400==n.status?o(t):s._printError(n.responseText)},n.open("GET",t,!0),n.send()}else if(XDomainRequest){var i=new XDomainRequest;i.onerror=function(e){s._printError(e)},i.onload=function(){var t=JSON.parse(i.responseText),o=e.ParseJSON(t);s._processResults(o)},i.open("GET",t),i.send()}else o(t)}},_processResults:function(e){e.length>0?(this._map.fireEvent("geosearch_foundlocations",{Locations:e}),this._showLocation(e[0])):this._printError(this._config.notFoundMessage)},_showLocation:function(e){1==this.options.showMarker&&("undefined"==typeof this._positionMarker?this._positionMarker=L.marker([e.Y,e.X],{draggable:this.options.draggable}).addTo(this._map):this._positionMarker.setLatLng([e.Y,e.X])),!this.options.retainZoomLevel&&e.bounds&&e.bounds.isValid()?this._map.fitBounds(e.bounds):this._map.setView([e.Y,e.X],this._getZoomLevel(),!1),this._map.fireEvent("geosearch_showlocation",{Location:e,Marker:this._positionMarker})},_printError:function(e){var t=this._resultslist;t.innerHTML="<li>"+e+"</li>",t.style.display="block",this._map.fireEvent("geosearch_error",{message:e}),setTimeout(function(){t.style.display="none"},3e3)},_onKeyUp:function(e){var t=27,o=13;e.keyCode===t?(this._searchbox.value="",this._map._container.focus()):e.keyCode===o&&(e.preventDefault(),e.stopPropagation(),this.geosearch(this._searchbox.value))},_getZoomLevel:function(){return this.options.retainZoomLevel?this._map.zoom:this._config.zoomLevel}});