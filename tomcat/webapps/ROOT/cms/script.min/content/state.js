define(["jquery","bsp-utils"],function(t,e){t(window);e.onDomInsert(document,".message",{insert:function(e){var a=t(e);""===a.text()&&a.find("[data-dynamic-html], [data-dynamic-text]").length>0&&a.hide()}}),e.onDomInsert(document,".contentForm, .enhancementForm, .standardForm",{insert:function(e){var a,n,i,d,o=t(e);a=function(e,n){if(o.find(".repeatableForm:not(.plugin-repeatable),.repeatableInputs:not(.plugin-repeatable),.repeatableLayout:not(.plugin-repeatable),.repeatableObjectId:not(.plugin-repeatable),.repeatableText:not(.plugin-repeatable)").length>0)return void setTimeout(function(){a(e,n)},100);var i,d,c,r,l;if(i=o.attr("action"),d=i.indexOf("?"),r=+new Date+1e3,l=o.find('[data-dynamic-text][data-dynamic-text != ""],[data-dynamic-html][data-dynamic-html != ""],[data-dynamic-placeholder][data-dynamic-placeholder != ""]'),l=l.filter(function(){return 0===t(this).closest(".collapsed").length}),t.ajax({type:"post",url:CONTEXT_PATH+"contentState?idle="+!!e+(d>-1?"&"+i.substring(d+1):""),cache:!1,dataType:"json",data:o.serialize()+l.map(function(){var e=t(this);return"&_dti="+(e.closest("[data-object-id]").attr("data-object-id")||"")+"&_dtt="+(e.attr("data-dynamic-text")||e.attr("data-dynamic-html")||e.attr("data-dynamic-placeholder")||"")+"&_dtf="+e.attr("data-dynamic-field-name")||""}).get().join(""),success:function(e){o.trigger("cms-updateContentState",[e]),l.each(function(a){var n=t(this),i=e._dynamicTexts[a];null!==i&&(n.closest(".message").toggle(""!==i),n.is("[data-dynamic-text]")?n.text(i):n.is("[data-dynamic-html]")?n.html(i):n.is("[data-dynamic-placeholder]")&&n.prop("placeholder",i))}),o.resize()},complete:function(){c=!0}}),n)for(;!(c||+new Date>r););},n=t.throttle(200,a),n(),o.bind("change input",function(){n(),clearTimeout(d),i=!0,d=setTimeout(function(){n(!0)},5e3)}),t(window).bind("beforeunload",function(){i&&a(!0,!0)})}})});