define(["jquery","bsp-utils","atmosphere"],function(e,t,n){function o(t){var n=JSON.parse(t),o=i[n.broadcast];o&&e.each(o,function(e,t){t(n.data)})}if(DISABLE_RTC)return{restore:function(){},receive:function(){},execute:function(){}};var s,a={url:"/_rtc",contentType:"application/json",fallbackTransport:"sse",maxReconnectOnClose:0,trackMessageLength:!0,transport:"sse"},c=t.throttle(5e3,function(){s=n.subscribe(a)}),r=[],i={},u=!1,l=[],f={push:function(e){s.push(JSON.stringify(e))}};return a.onOpen=function(){if(u=!0,e.each(r,function(e,t){f.push(t.message);var n=t.callback;n&&n()}),e.each(l,function(e,t){f.push(t)}),l=[],localStorage){var t="brightspot.rtc.socket.",n=1e3;setInterval(function(){localStorage.setItem(t+s.getUUID(),""+e.now());for(var o=0,a=localStorage.length;a>o;++o){var c=localStorage.key(o);c&&0===c.indexOf(t)&&parseInt(localStorage.getItem(c),10)+5*n<e.now()&&(localStorage.removeItem(c),(u?f:l).push({type:"disconnect",sessionId:c.substring(t.length)}))}},n)}},a.onClose=function(){u=!1},a.onError=function(){u=!1,c()},a.onMessage=function(e){o(e.responseBody)},a.onMessagePublished=function(t){e.each(t.messages,function(e,t){o(t)})},c(),{restore:function(e,t,n){r.push({callback:n,message:{type:"state",className:e,data:t}})},receive:function(e,t){(i[e]=i[e]||[]).push(t)},execute:function(e,t){(u?f:l).push({type:"action",className:e,data:t})}}});