define(["jquery","jquery.extra","v3/plugin/popup"],function(t){var e,a="objectId-shadow",d="objectId-target",r=0;e=function(e){e.each(function(){var e,d,r,i,s,n,o,l,c,p,f,h,u,b=t(this),m=t.data(this,a);if(m){if(e=m.$select,d=m.$edit,r=m.$clear,i=b.attr("data-preview"),n=b.attr("data-label"),s=b.attr("data-visibility"),p=b.val(),i){var v=t("<figcaption>",{text:n});e.html(t("<figure/>",{html:[t("<img/>",{src:i}),v]})),s&&(v.prepend(" "),v.prepend(t("<span/>",{"class":"visibilityLabel",text:s})))}else n?(e.text(n),s&&(e.prepend(" "),e.prepend(t("<span/>",{"class":"visibilityLabel",text:s})))):(o=b.attr("data-dynamic-placeholder"),l=b.attr("data-dynamic-field-name"),c=b.attr("placeholder"),o?e.html(t("<span/>",{type:"text","class":"objectId-placeholder","data-dynamic-text":o,"data-dynamic-field-name":l})):c?e.html(t("<span/>",{"class":"objectId-placeholder",text:c})):e.text("Â "));f=e.attr("href"),h=f.indexOf("aq"),u="aq="+encodeURIComponent(b.attr("data-additional-query")||""),-1===h?f+="&"+u:f=f.substr(0,h)+u+f.substr(f.indexOf("&",h)),e.attr("href",f),d.toggle("false"!==b.attr("data-editable")&&!!p),r.toggle(r.is(".restore")||"false"!==b.attr("data-clearable")&&0===b.closest(".repeatableObjectId").length&&!!p&&!r.hasClass("state-disabled")),d.attr("href",CONTEXT_PATH+"content/edit.jsp?id="+(p||"")+"&"+((/[&?](variationId=[^&]+)/.exec(window.location.search)||[])[1]||""))}})},t.plugin2("objectId",{_init:function(a){this.$caller.on("change.objectId",a,function(){e(t(this))}),this.$caller.on("refresh.objectId",a,function(){e(t(this))})},_create:function(e){var i,s,n,o,l,c,p,f,h,u;if(!t.data(e,a)){i=t(e),s=e.form?t(e.form):i.closest("form"),n=t.data(s[0],d),n||(++r,n="objectId-"+r,t.data(s[0],d,n));var b=i.attr("data-generic-argument-index"),m=i.closest("[data-generic-arguments]").attr("data-generic-arguments");b&&m&&(o=m.split(",")[b]),o||(o=i.attr("data-typeIds")),l=s.attr("action"),c=i.attr("data-searcher-path")||CONTEXT_PATH+"content/objectId.jsp",p=t("<a/>",{"class":"objectId-select",target:n,click:function(){return!t(this).is(".state-disabled")},href:c+(c.indexOf("?")>-1?"&":"?")+"pt="+encodeURIComponent((/id=([^&]+)/.exec(l)||[])[1]||"")+"&py="+encodeURIComponent((/typeId=([^&]+)/.exec(l)||[])[1]||"")+"&p="+encodeURIComponent(i.attr("data-pathed"))+"&"+(o?t.map(o.split(","),function(t){return"rt="+t}).join("&"):"")+"&aq="+encodeURIComponent(i.attr("data-additional-query")||"")+"&sg="+encodeURIComponent(i.attr("data-suggestions")||"")}),f=t("<a/>",{"class":"objectId-edit",target:n,text:"Edit"}),h=t("<a/>",{"class":"objectId-clear",text:"Clear",click:function(){var e=t(this),d=t.data(e[0],a),r=d.$select,s=d.$edit;return i.val()?("false"===i.attr("data-restorable")?(i.removeAttr("data-label"),i.removeAttr("data-preview")):(r.addClass("toBeRemoved"),s.addClass("toBeRemoved"),e.addClass("restore"),e.text("Restore")),i.val("")):(r.removeClass("toBeRemoved"),s.removeClass("toBeRemoved"),e.removeClass("restore"),e.text("Clear"),i.val(i[0].defaultValue)),i.change(),!1}}),u={$input:i,$select:p,$edit:f,$clear:h},t.data(e,a,u),t.data(p[0],a,u),t.data(f[0],a,u),t.data(h[0],a,u)}},_createAll:function(d,r){var i=t(d).find(r);i.each(function(){var e=t(this),d=t.data(this,a);e.hide(),e.after(d.$clear),e.after(d.$edit),e.after(d.$select)}),i.bind("input-disable",function(e,d){var r=(t(this),t.data(this,a));r&&(r.$clear.toggleClass("state-disabled",d),r.$select.toggleClass("state-disabled",d))}),e(i)}}),t(document).onCreate("[data-o-id]",function(){var e,a=t(this),d=a.popup("source");d&&(d.is(".objectId-select")||d.is(".objectId-edit"))&&(e=d.parent().find(":input.objectId"),e.attr("data-label",a.attr("data-o-label")),e.attr("data-preview",a.attr("data-o-preview")),e.val(a.attr("data-o-id")),e.change())})});