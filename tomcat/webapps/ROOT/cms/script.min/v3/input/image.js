define(["jquery","bsp-utils","v3/input/richtext2","pixastic/pixastic.core","pixastic/actions/blurfast","pixastic/actions/brightness","pixastic/actions/crop","pixastic/actions/desaturate","pixastic/actions/fliph","pixastic/actions/flipv","pixastic/actions/invert","pixastic/actions/rotate","pixastic/actions/sepia","pixastic/actions/sharpen"],function(t,e,i){var o;return o={inputNames:"x y width height texts textSizes textXs textYs textWidths".split(" "),textDelimiter:"aaaf7c5a9e604daaa126f11e23e321d8",tabNames:{image:"Focus",edit:"Edit",sizes:"Sizes & Texts",hotspots:"Hotspots"},init:function(e,i){var o=this;o.$element=t(e),i&&t.extend(o,i),o.initDOM().done(function(){o.tabsInit(),o.focusInit(),o.editInit(),o.sizesInit(),o.textInit(),o.hotspotInit(),o.adjustmentProcess(),o.tabsReady(),o.adjustmentProcessTimerStart()})},initDOM:function(){var t,e,i,o;return o=this,e=o.$element,t={},o.dom=t,t.$form=e.closest("form"),t.$imageContainer=e.find(".imageEditor-image"),t.$image=t.$imageContainer.find("img"),t.imageSrc=t.$image.attr("src"),t.$imageClone=t.$image.clone(),t.imageClone=t.$imageClone[0],i=t.$image.attr("data-scale"),(void 0===i||""===i)&&(i=1),o.scale=i,t.$aside=e.find("> .imageEditor-aside"),t.$tools=e.find(".imageEditor-tools ul"),t.$edit=e.find(".imageEditor-edit"),t.$sizes=e.find(".imageEditor-sizes"),t.$sizesTable=t.$sizes.find("table"),o.dataName=e.closest(".inputContainer").attr("data-name"),t.$focusInputX=t.$imageContainer.find('input[name$=".focusX"]'),t.$focusInputY=t.$imageContainer.find('input[name$=".focusY"]'),o.getImageSize(t.$image).done(function(t,e){o.dom.imageCloneWidth=t,o.dom.imageCloneHeight=e})},tabsInit:function(){var t;t=this,t.dom.tabs={}},tabsCreate:function(e,i){var o;o=this,o.dom.tabs=o.dom.tabs||{},o.tabNames[e]&&(o.dom.tabs[e]=t("<div/>",{"class":i||"","data-tab":o.tabNames[e],style:"position:relative"}))},tabsReady:function(){var e;e=this,t.each(e.dom.tabs,function(){var i=t(this);i.appendTo(e.$element)}),e.$element.addClass("tabbed"),e.$element.tabbed()},editInit:function(){var e,i,o,s,n;n=this,n.tabsCreate("edit"),n.dom.$editImage=n.dom.$imageClone.clone(),n.dom.$originalImage=n.dom.$editImage,t("<div/>",{"class":"imageEditor-image",html:n.dom.$editImage}).appendTo(n.dom.tabs.edit),n.dom.$aside.appendTo(n.dom.tabs.edit),n.dom.$editInputs=t("<div/>").appendTo(n.dom.$edit),n.dom.$edit.find("table").hide(),e=t('<div class="imageEditor-adjustment"><div class="imageEditor-adjustment-heading">Brightness <span class="imageEditor-value">0</span></div></div>').appendTo(n.dom.$edit),n.dom.$editBrightnessValue=e.find(".imageEditor-value"),n.dom.$editBrightness=n.dom.$edit.find('table :input[name$=".brightness"]').on("change input",function(){n.dom.$editBrightnessValue.text(t(this).val())}).trigger("change").appendTo(e),i=t('<div class="imageEditor-adjustment"><div class="imageEditor-adjustment-heading">Contrast <span class="imageEditor-value">0</span></div></div>').appendTo(n.dom.$edit),n.dom.$editContrastValue=i.find(".imageEditor-value"),n.dom.$editContrast=n.dom.$edit.find('table :input[name$=".contrast"]').on("change input",function(){n.dom.$editContrastValue.text(t(this).val())}).trigger("change").appendTo(i),s=t('<div class="imageEditor-adjustment"><div class="imageEditor-adjustment-heading">Rotate/Flip</div><ul class="imageEditor-adjustment-icons"></ul></div>').appendTo(n.dom.$edit).find("ul"),t("<li/>").append(t("<a/>",{title:"Rotate Left",text:"","class":"imageEditor-rotate-left"}).on("click",function(){return n.editRotateLeft(),!1})).appendTo(s),t("<li/>").append(t("<a/>",{title:"Rotate Right",text:"","class":"imageEditor-rotate-right"}).on("click",function(){return n.editRotateRight(),!1})).appendTo(s),t("<li/>").append(t("<a/>",{title:"Flip Horizontally",text:"","class":"imageEditor-flip-h"}).on("click",function(){return n.editFlipH(),!1})).appendTo(s),t("<li/>").append(t("<a/>",{title:"Flip Vertically",text:"","class":"imageEditor-flip-v"}).on("click",function(){return n.editFlipV(),!1})).appendTo(s),n.dom.$edit.find('table :input[name$=".rotate"]').attr({min:"-270",max:"270"}),o=t('<div class="imageEditor-adjustment"><div class="imageEditor-adjustment-heading">Filters</div><ul></ul></div>').appendTo(n.dom.$edit).find("ul"),n.dom.$editInvert=n.dom.$edit.find('table :input[name$=".invert"]'),t("<li/>",{html:t("<label>Invert</label>").prepend(n.dom.$editInvert)}).appendTo(o),n.dom.$editSepia=n.dom.$edit.find('table :input[name$=".sepia"]'),t("<li/>",{html:t("<label>Sepia</label>").prepend(n.dom.$editSepia)}).appendTo(o),n.dom.$editGrayscale=n.dom.$edit.find('table :input[name$=".grayscale"]'),t("<li/>",{html:t("<label>Grayscale</label>").prepend(n.dom.$editGrayscale)}).appendTo(o),n.dom.$editResetButton=t("<button/>",{type:"button",text:"Reset",click:function(){return n.editReset(),!1}}).appendTo(n.dom.$edit),n.dom.$edit.on("change",":input",function(){var e;e=n.editParseName(t(this).attr("name")),n.$element.trigger("imageAdjustment",[this,e])})},editInitInputs:function(){var e;e=this,e.dom.$editInputs=t("<div/>").appendTo(e.dom.$editButton)},editOpenAdjustments:function(){var t,e;e=this,t=e.dom.$edit,t.popup("source",e.dom.$editButton).popup("open"),e.adjustmentBlurShow()},editReset:function(){var e;e=this,e.dom.$edit.find(":input:not([type=button])").each(function(){var i,o,s;i=t(this),s=0,i.is(":checkbox")?(s=1,i.removeAttr("checked")):(s=parseFloat(i.val()),i.val(0)),0!==s&&(o=e.editParseName(i.attr("name")),i.trigger("change"),e.$element.trigger("imageAdjustment",[i.get(0),o]))}),e.$element.find(".imageEditor-blurOverlay").remove(),e.adjustmentProcess()},editParseName:function(t){return t=t||"",t.replace(/.*\./,"")},editRotateLeft:function(){var t;t=this,t.adjustmentRotateSet(t.adjustmentRotateGet()-90)},editRotateRight:function(){var t;t=this,t.adjustmentRotateSet(t.adjustmentRotateGet()+90)},editFlipH:function(){var t,e;e=this,t=Math.abs(e.adjustmentRotateGet()),0===t||180===t?e.adjustmentFlipHToggle():e.adjustmentFlipVToggle()},editFlipV:function(){var t,e;e=this,t=Math.abs(e.adjustmentRotateGet()),0===t||180===t?e.adjustmentFlipVToggle():e.adjustmentFlipHToggle()},adjustmentProcessTimerStart:function(){var t;t=this,t.adjustmentProcessTimerStop(),t.$element.closest("body").length&&t.adjustmentProcess().always(function(){t.adjustmentProcessTimer=setTimeout(function(){t.adjustmentProcessTimerStart()},100)})},adjustmentProcessTimerStop:function(){var t;t=this,clearTimeout(t.adjustmentProcessTimer)},adjustmentProcess:function(){var e,i,o,s;return s=this,e=s.adjustmentGetOperations(),i=JSON.stringify(e),i!==s.operationsPrevious&&(s.operationsPrevious=i,s.adjustmentSetInputs(),o=s.adjustmentProcessExecuteAll(e),o.done(function(){s.dom.$editImage!==s.dom.$originalImage&&s.dom.$editImage.remove(),s.dom.$originalImage.hide().before(s.dom.processedImage),s.dom.$editImage=t(s.dom.processedImage),s.$element.trigger("imageUpdated",[s.dom.$editImage])})),t.Deferred().resolve().promise()},adjustmentProcessExecuteAll:function(e){var i,o;return o=this,i=t.Deferred().resolve().promise(),o.dom.processedImage=o.dom.$imageClone.clone().get(0),t.each(e,function(e,s){var n;n=s.data||[s],t.each(n,function(t,s){var n;n=i,i=n.then(function(){return o.adjustmentProcessExecuteSingle(e,s)})})}),i},adjustmentProcessExecuteSingle:function(e,i){var o,s;return s=this,o=t.Deferred(),Pixastic.process(s.dom.processedImage,e,i,function(t){s.dom.processedImage=t,o.resolve()}),o.promise()},adjustmentSetInputs:function(){var e;e=this,e.dom.$editInputs.empty(),e.dom.$edit.find(":input:not([type=button])").each(function(){var i=t(this);(!i.is(":checkbox")||i.is(":checked"))&&e.dom.$editInputs.append(t("<input/>",{type:"hidden",name:i.attr("name"),value:i.val()}))})},adjustmentGetOperations:function(){var e;return e=this,e.operations={},e.dom.$edit.find(":input:not([type=hidden])").each(function(){var i,o,s,n;i=t(this),o=e.editParseName(i.attr("name")),o&&(s=i.is(":checkbox")?i.is(":checked"):parseFloat(i.val()),s===!1||isNaN(s)||0===s||(n="adjustmentGetOperation_"+o,e[n]&&e[n](s)))}),e.operations},adjustmentGetOperation_brightness:function(t){var e,i;i=this,e=i.operations,e.brightness=e.brightness||{},e.brightness.brightness=150*t,e.brightness.legacy=!0},adjustmentGetOperation_contrast:function(t){var e,i;i=this,e=i.operations,e.brightness=e.brightness||{},e.brightness.contrast=0>t?t:3*t},adjustmentGetOperation_flipH:function(){var t,e;e=this,t=e.operations,t.fliph=t.fliph||{}},adjustmentGetOperation_flipV:function(){var t,e;e=this,t=e.operations,t.flipv=t.flipv||{}},adjustmentGetOperation_grayscale:function(){var t,e;e=this,t=e.operations,t.desaturate=t.desaturate||{}},adjustmentGetOperation_sepia:function(){var t,e;e=this,t=e.operations,t.sepia=t.sepia||{}},adjustmentGetOperation_invert:function(){var t,e;e=this,t=e.operations,t.invert=t.desaturate||{}},adjustmentGetOperation_rotate:function(t){var e,i;i=this,e=i.operations,e.rotate=e.rotate||{},e.rotate.angle=-t},adjustmentGetOperation_sharpen:function(t){var e,i;i=this,e=i.operations,e.sharpen=e.sharpen||{},e.sharpen.amount=t},adjustmentGetOperation_blur:function(t){var e,i,o,s;o=this,e=o.operations,e.blurfast=e.blurfast||{count:0,data:[]},s=t.split("x"),i={left:s[0],top:s[1],width:s[2],height:s[3]},e.blurfast.data[e.blurfast.count]={amount:1,rect:i},e.blurfast.count++},adjustmentRotateGet:function(){var t,e;return t=this,e=parseInt(t.dom.$edit.find(":input[name$='.rotate']").val()||0,10)},adjustmentRotateSet:function(t){var e;e=this,Math.abs(t)>=360&&(t=0),-180===t&&(t=180),270===t?t=-90:-270===t&&(t=90),e.dom.$edit.find(":input[name$='.rotate']").val(t).trigger("change")},adjustmentFlipHGet:function(){var t,e;return t=this,e=t.dom.$edit.find(":input[name$='.flipH']").is(":checked")},adjustmentFlipHSet:function(t){var e;e=this,e.dom.$edit.find(":input[name$='.flipH']").prop("checked",t)},adjustmentFlipHToggle:function(){var t;t=this,t.adjustmentFlipHSet(!t.adjustmentFlipHGet())},adjustmentFlipVGet:function(){var t,e;return t=this,e=t.dom.$edit.find(":input[name$='.flipV']").is(":checked")},adjustmentFlipVSet:function(t){var e;e=this,e.dom.$edit.find(":input[name$='.flipV']").prop("checked",t)},adjustmentFlipVToggle:function(){var t;t=this,t.adjustmentFlipVSet(!t.adjustmentFlipVGet())},adjustmentBlurShow:function(){var e;e=this,e.dom.$edit.find("input[name='"+e.dataName+".blur']").each(function(){var e;e=t(this).val().split("x")})},sizesInit:function(){var e;e=this,e.tabsCreate("sizes"),e.$element.find(".imageEditor-image").appendTo(e.dom.tabs.sizes),e.dom.$sizesAside=t("<div/>",{"class":"imageEditor-aside"}).appendTo(e.dom.tabs.sizes),e.dom.$sizes.appendTo(e.dom.$sizesAside),e.coverInit(),e.sizesGetSizeInfo(),e.dom.$sizeSelectors=t("<ul/>",{"class":"imageEditor-sizeSelectors"}),t.each(e.sizeGroups,function(i,o){var s,n,a;n=t("<li/>",{"class":"imageEditor-sizeButton"}).appendTo(e.dom.$sizeSelectors),n.attr("data-group-name",i),o.$element=n,s=t("<span/>",{"class":"imageEditor-sizeLabel"}).appendTo(n),o.$groupLabel=s,t.each(o.sizeInfos,function(e,i){a?s.append("<br/>"):a=!0,t("<span/>",{title:i.description+" ("+i.width+" x "+i.height+")",html:i.description}).appendTo(s)}),t("<div/>",{"class":"imageEditor-sizePreview",html:t("<img/>",{alt:s.text(),src:e.dom.imageSrc,load:function(){e.sizesUpdatePreview(i)}})}).appendTo(n),n.on("click",function(){return e.sizesIsSelected(i)?e.sizesUnselect():e.sizesSelect(i),!1}),e.sizeBoxInit(i)}),e.dom.$sizesTable.before(e.dom.$sizeSelectors).hide(),e.sizesSelectSingle(),e.scrollFix(e.dom.$sizesAside),e.$element.on("imageAdjustment",function(t,i,o){"rotate"===o&&e.sizesResetAll()}),e.$element.on("imageUpdated",t.throttle(2e3,function(i,o){var s;s=t(e.cloneCanvas(o.get(0))),e.dom.$image.before(s),e.dom.$image.remove(),e.dom.$image=s,e.sizesNeedsUpdate=!0})),e.dom.tabs.sizes.on("tabbedShow",function(){e.sizesNeedsUpdate&&(e.sizesNeedsUpdate=!1,setTimeout(function(){var t;t=e.sizesGetSelected(),t&&e.sizesSelect(t),e.sizesUpdatePreview()},100))})},sizesGetSizeInfo:function(){var e,i;i=this,i.sizeInfos={},i.sizeGroups={},e={},i.dom.$sizesTable.find("th").each(function(){var o,s,n,a,d,r,h,p,u,c,l,m,g,f;g=t(this),f=g.closest("tr"),u=f.attr("data-size-name"),r=g.text(),s="true"===f.attr("data-size-independent"),c=parseFloat(f.attr("data-size-width")),h=parseFloat(f.attr("data-size-height")),a=c/h,(0===c||0===h)&&(a=0,s=!0),m=g.popup("source"),m&&(l=m.closest(".inputContainer").attr("data-standard-image-sizes"),l&&t.inArray(u,l.split(" "))<0)||(n={},t.each(i.inputNames,function(t,e){n[e]=f.find(':input[name$=".'+e+'"]')}),p=i.sizeInfos[u]={name:u,description:r,inputs:n,independent:s,width:c,height:h,aspectRatio:a},s?o=i.sizesCreateGroup(u):(d=Math.floor(100*a)/100,o=e[""+d],o||(o=i.sizesCreateGroup(d),e[d]=o,e[d-.02]=e[d-.02]||o,e[d-.01]=e[d-.01]||o,e[d+.01]=e[d+.01]||o,e[d+.02]=e[d+.02]||o)),o.sizeInfos[u]=p)})},sizesSelect:function(t){var e;e=this,e.sizesUnselect(),e.sizeGroups[t].$element.addClass("imageEditor-sizeSelected"),e.sizeBoxShow(t),e.textSelectGroup(t),e.resetCropShow(t)},sizesUnselect:function(){var t;t=this,t.dom.$sizeSelectors.find("li").removeClass("imageEditor-sizeSelected"),t.sizeBoxHide(),t.textUnselect(),t.resetCropHide()},sizesIsSelected:function(t){var e;return e=this,e.sizeGroups[t].$element.hasClass("imageEditor-sizeSelected")},sizesSelectSingle:function(){var e;e=this,1===e.sizeGroups.length&&t.each(e.sizeGroups,function(t){return e.sizesSelect(t),!1})},sizesGetSelected:function(){var t;return t=this,t.dom.$sizeSelectors.find(".imageEditor-sizeSelected").attr("data-group-name")||""},sizesCreateGroup:function(e){var i;return i=this,i.sizeGroups[e]={$element:t(),sizeInfos:{}}},sizesUpdatePreview:function(e){var i,o,s;s=this,e?(i={},i[e]=s.sizeGroups[e]):i=s.sizeGroups,t.each(i,function(t,e){var i,n,a,d,r,h;r=s.sizesGetGroupFirstSizeInfo(t),a=e.$element.find(".imageEditor-sizePreview"),d=s.adjustmentRotateGet(),90===d||-90===d?(h=s.dom.imageCloneHeight,n=s.dom.imageCloneWidth):(h=s.dom.imageCloneWidth,n=s.dom.imageCloneHeight),i=s.sizesGetSizeBounds(h,n,r),o=s.adjustmentGetOperations(),o.crop=i,s.adjustmentProcessExecuteAll(o).done(function(){a.empty().append(s.dom.processedImage)})})},sizesGetSizeBounds:function(t,e,i){var o,s,n,a,d,r;return a=this,n=parseFloat(i.inputs.x.val())||0,d=parseFloat(i.inputs.y.val())||0,r=parseFloat(i.inputs.width.val())||0,s=parseFloat(i.inputs.height.val())||0,o=i.aspectRatio,0===r||0===s?o?(r=e*o,s=t/o,r>t?r=s*o:s=r/o,n=(t-r)/2,d=0):(n=0,d=0,r=t,s=e):(n*=t,d*=e,r*=t,s*=e),{left:n,top:d,width:r,height:s}},sizesSetGroupBounds:function(e,i){var o,s;o=this,s=o.sizeGroups[e],t.each(s.sizeInfos,function(){var e=this;t.each(i,function(t,i){e.inputs[t].val(i)})})},sizesResetAll:function(){var e;e=this,t.each(e.sizeGroups,function(t){e.sizesResetGroup(t)})},sizesResetGroup:function(e){var i,o;o=this,i=o.sizeGroups[e],t.each(i.sizeInfos,function(){var t=this;t.inputs.x.val("0.0"),t.inputs.y.val("0.0"),t.inputs.width.val("0.0"),t.inputs.height.val("0.0")})},sizesGetGroupFirstSizeInfo:function(e){var i,o,s;return o=this,i=o.sizeGroups[e],t.each(i.sizeInfos,function(t,e){return s=e,!1}),s},sizesGetGroupAspectRatio:function(t){var e;return e=this,e.sizesGetGroupFirstSizeInfo(t).aspectRatio},coverInit:function(){var e,i;i=this,e=t("<div/>",{"class":"imageEditor-cover",css:{display:"none",left:"0",position:"absolute",top:"0"}}),i.dom.$coverTop=e,i.dom.$coverLeft=e.clone(!0),i.dom.$coverRight=e.clone(!0),i.dom.$coverBottom=e.clone(!0),i.dom.$covers=t().add(i.dom.$coverTop).add(i.dom.$coverLeft).add(i.dom.$coverRight).add(i.dom.$coverBottom).appendTo(i.dom.tabs.sizes)},coverUpdate:function(t){var e,i,o,s,n;e=this,i=e.dom.$image.width(),o=e.dom.$image.height(),s=t.left+t.width,n=t.top+t.height,e.dom.$coverTop.css({height:t.top,width:i}),e.dom.$coverLeft.css({height:t.height,top:t.top,width:t.left}),e.dom.$coverRight.css({height:t.height,left:s,top:t.top,width:i-s}),e.dom.$coverBottom.css({height:o-n,top:n,width:i}),e.coverShow()},coverHide:function(){var t;t=this,t.dom.$covers.hide()},coverShow:function(){var t;t=this,t.dom.$covers.show()},sizeBoxInit:function(e){var i,o,s,n,a;o=this,i=o.sizeGroups[e],s=t("<div/>",{"class":"imageEditor-sizeBox",css:{position:"absolute"}}).hide().appendTo(o.dom.tabs.sizes),i.$sizeBox=s,n=t("<div/>",{"class":"imageEditor-resizer imageEditor-resizer-topLeft"}).appendTo(s),a=t("<div/>",{"class":"imageEditor-resizer imageEditor-resizer-bottomRight"}).appendTo(s),n.on("mousedown",o.sizeBoxMousedownDragHandler(e,function(t,e,i){return{left:e.left+i.constrainedX,top:e.top+i.constrainedY,width:e.width-i.constrainedX,height:e.height-i.constrainedY}})),a.on("mousedown",o.sizeBoxMousedownDragHandler(e,function(t,e,i){return{width:e.width+i.constrainedX,height:e.height+i.constrainedY}})),s.on("mousedown",o.sizeBoxMousedownDragHandler(e,function(t,e,i){return{moving:!0,left:e.left+i.x,top:e.top+i.y}}))},sizeBoxShow:function(t){var e,i,o;i=this,o=i.sizesGetGroupFirstSizeInfo(t),e=i.sizesGetSizeBounds(i.dom.$image.width(),i.dom.$image.height(),o),i.coverUpdate(e),i.coverShow(),i.sizeBoxUpdate(t,e),i.sizeGroups[t].$sizeBox.show()},sizeBoxUpdate:function(t,e){var i;i=this,i.sizeGroups[t].$sizeBox.css(e)},sizeBoxHide:function(){var e;e=this,e.coverHide(),t.each(e.sizeGroups,function(t,e){e.$sizeBox.hide()})},sizeBoxRefresh:function(t){var e;e=this,e.sizeBoxHide(),e.sizeBoxShow(t)},sizeBoxMousedownDragHandler:function(e,i){var o,s,n;return s=this,n=s.sizeGroups[e].$sizeBox,o=function(o){var a,d,r,h,p,u;return d=this,a=s.sizesGetGroupAspectRatio(e),u=n.position(),p={left:u.left,top:u.top,width:n.width(),height:n.height(),pageX:o.pageX,pageY:o.pageY},r=s.dom.$image.width(),h=s.dom.$image.height(),t.drag(d,o,function(){},function(o){var d,u,c,l;u=o.pageX-p.pageX,c=o.pageY-p.pageY,d=i(o,p,{x:u,y:c,constrainedX:a?Math.max(u,c*a):u,constrainedY:a?Math.max(c,u/a):c}),d=t.extend({},p,d),d.moving?(d.left<0&&(d.left=0),d.top<0&&(d.top=0),l=d.left+d.width-r,l>0&&(d.left-=l),l=d.top+d.height-h,l>0&&(d.top-=l)):((d.width<10||d.height<10)&&(a>1?(d.width=10*a,d.height=10):(d.width=10,d.height=a?10/a:10)),d.left<0&&(d.width+=d.left,a&&(d.height=d.width/a,d.top-=d.left/a),d.left=0),d.top<0&&(d.height+=d.top,a&&(d.width=d.height*a,d.left-=d.top*a),d.top=0),l=d.left+d.width-r,l>0&&(d.width-=l,a&&(d.height=d.width/a)),l=d.top+d.height-h,l>0&&(d.height-=l,a&&(d.width=d.height*a))),s.coverUpdate(d),s.sizeBoxUpdate(e,d),d.moving||n.trigger("sizeBoxResize")},function(){var t,i,o;i=n.position(),o=n.width(),t=n.height(),s.sizesSetGroupBounds(e,{x:i.left/r,y:i.top/h,width:o/r,height:t/h}),s.sizesUpdatePreview(e),n.trigger("sizeBoxResize")}),!1}},focusInit:function(){var e,i;e=this,e.tabsCreate("image","imageEditor-focus"),e.dom.$focusImage=e.dom.$imageClone.clone(),t("<div/>",{"class":"imageEditor-image",html:e.dom.$focusImage}).appendTo(e.dom.tabs.image),e.dom.$focusAside=t("<div/>",{"class":"imageEditor-aside"}).appendTo(e.dom.tabs.image),""!==e.dom.$focusInputX.val()&&""!==e.dom.$focusInputY.val()&&e.insertFocusPoint(e.dom.$focusImage,100*e.dom.$focusInputX.val(),100*e.dom.$focusInputY.val()),i="<p>Click inside the image to set a focus point for all image sizes.</p>",e.dom.$focusMessage=t("<div/>",{"class":"imageEditor-focus-message",html:i}).appendTo(e.dom.$focusAside),e.$element.on("imageUpdated",function(i,o){var s;s=t(e.cloneCanvas(o.get(0))),e.dom.$focusImage.before(s),e.dom.$focusImage.remove(),e.dom.$focusImage=s}),e.dom.$focusImage.parent().on("click","img,canvas",function(i){var o,s,n,a,d;s=t(this),d=s.width(),a=s.height(),n={width:d,height:a},o=e.getClickPositionInElement(s,i),t.each(e.sizeGroups,function(t){var i,s,a;a=e.sizesGetGroupFirstSizeInfo(t),i={width:a.width,height:a.height},s=e.focusGetCrop({x:o.xPercent,y:o.yPercent},n,i),e.sizesSetGroupBounds(t,s),e.sizesUpdatePreview(t)}),e.sizesNeedsUpdate=!0,e.dom.$focusInputX.val(o.xPercent),e.dom.$focusInputY.val(o.yPercent),e.insertFocusPoint(e.dom.$focusImage,100*o.xPercent,100*o.yPercent),e.dom.$focusPoint.css({left:100*o.xPercent+"%",top:100*o.yPercent+"%"}),e.$element.trigger("change")})},insertFocusPoint:function(e,i,o){var s=this;s.dom.$focusPoint||(s.dom.$focusPoint=t("<div/>",{"class":"imageEditor-focus-point"}).appendTo(s.dom.$focusImage.parent())),s.dom.$focusPoint.css({left:i+"%",top:o+"%"})},focusGetCrop:function(t,e,i){var o,s,n,a,d,r,h;return n={x:0,y:0,width:1,height:1},o=e.width/e.height,s=0===i.width||0===i.height?0:i.width/i.height,0===s||(o>s?(a=e.height*s,d=e.width-a,r=d/e.width,n.width=1-r,n.x=r/2,h=n.x-(.5-t.x),0>h?h=0:h+n.width>1&&(h=1-n.width),n.x=h):s>o&&(a=e.width/s,d=e.height-a,r=d/e.height,n.height=1-r,n.y=r/2,h=n.y-(.5-t.y),0>h?h=0:h+n.height>1&&(h=1-n.height),n.y=h)),n},resetCropShow:function(e){var i;i=this,t("<a/>",{"class":"imageEditor-resetCrop",text:"Reset Crop",click:function(){return i.sizesResetGroup(e),i.sizesUpdatePreview(e),i.sizeBoxRefresh(e),!1}}).insertAfter(i.sizeGroups[e].$groupLabel)},resetCropHide:function(){var t;t=this,t.$element.find(".imageEditor-resetCrop").remove()},textInit:function(){var e;e=this,e.textInfoIndex=1,t.each(e.sizeGroups,function(i,o){o.textInfos=e.textGetTextInfo(i),t.each(o.textInfos,function(t){e.textOverlayAdd(i,t)}),o.$sizeBox.on("sizeBoxResize",function(){e.textOverlaySetFont(i)})}),e.dom.$form.submit(function(){t.each(e.sizeGroups,function(t){e.textSetTextInfo(t)})})},textSelectGroup:function(t){var e;e=this,e.textButtonCreate(t),e.textOverlaySetFont(t)},textUnselect:function(){var t;t=this,t.textButtonRemove()},textButtonCreate:function(e){var i;i=this,t("<a/>",{"class":"imageEditor-addTextOverlay",text:"Add Text",click:function(){return i.textAdd(e),!1}}).insertAfter(i.sizeGroups[e].$groupLabel)},textButtonRemove:function(){var t;t=this,t.$element.find(".imageEditor-addTextOverlay").remove()},textGetTextInfo:function(e){var i,o,s,n,a,d,r,h,p;return o=this,i=o.sizeGroups[e],s=o.sizesGetGroupFirstSizeInfo(e),s.inputs.texts.val()?(a=s.inputs.texts.val().split(o.textDelimiter),h=s.inputs.textXs.val().split(o.textDelimiter),p=s.inputs.textYs.val().split(o.textDelimiter),r=s.inputs.textWidths.val().split(o.textDelimiter),d=s.inputs.textSizes.val().split(o.textDelimiter),n={},t.each(a,function(t){0!==t&&(n[o.textInfoIndex++]={text:o.htmlDecode(a[t]),x:h[t],y:p[t],width:r[t],size:d[t]})}),n):{}},textSetTextInfo:function(e){var i;i=this,t.each(i.sizeGroups[e].sizeInfos,function(o,s){var n,a,d,r,h;n="",a="",d="",r="",h="",t.each(i.sizeGroups[e].textInfos,function(t,e){var o,p,u;p=e.$textOverlay.find(".imageEditor-textOverlayInput"),p.length&&(u=p.data("rte2"),e.text=u?u.toHTML():p.val()),n+=i.textDelimiter+e.text,a+=i.textDelimiter+parseFloat(e.x).toFixed(3),d+=i.textDelimiter+parseFloat(e.y).toFixed(3),r+=i.textDelimiter+parseFloat(e.width).toFixed(3),o=e.originalFontSize||16,e.size=o/(s.height?s.height:s.width),h+=i.textDelimiter+e.size.toFixed(3)}),s.inputs.texts.val(n||""),s.inputs.textXs.val(a||""),s.inputs.textYs.val(d||""),s.inputs.textWidths.val(r||""),s.inputs.textSizes.val(h||"")})},textAdd:function(t){var e,i,o;i=this,e=i.sizeGroups[t],o=i.textInfoIndex++,e.textInfos[o]={text:"",x:.25,y:.25,width:.5,size:0},i.textOverlayAdd(t,o,!0)},textOverlayAdd:function(e,o,s){var n,a,d,r,h,p,u;a=this,n=a.sizeGroups[e],r=n.textInfos[o],r&&(d=n.$sizeBox,h=t("<div/>",{"class":"imageEditor-textOverlay",css:{left:100*r.x+"%",position:"absolute",top:100*r.y+"%",width:100*r.width+"%","z-index":1}}).appendTo(d),h.data("textInfoKey",o),h.data("groupName",e),r.$textOverlay=h,t("<div/>",{"class":"imageEditor-textOverlayLabel",text:"Text #"+o}).on("mousedown",a.textMousedownDragHandler(function(t,e,i){return{moving:!0,left:e.left+i.x,top:e.top+i.y}})).appendTo(h),t("<div/>",{"class":"imageEditor-resizer imageEditor-resizer-left",mousedown:a.textMousedownDragHandler(function(t,e,i){return{left:e.left+i.x,width:e.width-i.x}})}).appendTo(h),t("<div/>",{"class":"imageEditor-resizer imageEditor-resizer-right",mousedown:a.textMousedownDragHandler(function(t,e,i){return{left:e.left,width:e.width+i.x}})}).appendTo(h),t("<div/>",{"class":"imageEditor-textOverlayRemove",text:"Remove",click:function(){return h.remove(),a.textOverlayRemove(e,o),!1}}).appendTo(h),p=t("<input/>",{"class":"imageEditor-textOverlayInput",type:"text",value:r.text||""}).appendTo(h),u=t("<div/>",{"class":"imageEditor-text-toolbar"}).hide(),a.dom.tabs.sizes.before(u),p.on("rteFocus",function(){return a.$element.find(".imageEditor-text-toolbar").hide(),u.show(),!1}),rte=Object.create(i),rte.init(p,{inline:!0,toolbarLocation:u}),r.rte=rte,r.$toolbar=u,a.textOverlaySetFont(e,o),s&&(p.focus(),a.$element.find(".imageEditor-text-toolbar").hide(),u.show()))},textOverlaySetFont:function(e,i){var o,s,n,a,d;a=this,o=a.sizeGroups[e],d=o.$sizeBox,t.each(o.sizeInfos,function(t,e){return 0===e.height?(n="width",s=e.width,!1):void((void 0===s||e.height>s)&&(n="height",s=e.height))}),d.is(":visible")&&(d.find(".imageEditor-textOverlay").each(function(){var r,h,p,u,c,l,m,g;l=t(this),m=l.data("textInfoKey"),i&&m!==i||(g=o.textInfos[m],u=a.sizesGetGroupFirstSizeInfo(e).height,c=a.sizesGetGroupFirstSizeInfo(e).width,r=l.data("imageEditor-originalFontSize"),h=t(l),r||(r=parseFloat(h.css("font-size")),t.data(this,"imageEditor-originalFontSize",r)),r>0&&(h.css({"font-size":("height"===n?d.height():d.width())*(r/s),"line-height":1.2}),g.originalFontSize=r),p=l.find(".imageEditor-textOverlayInput").data("rte2"),p&&p.refresh())}),a.textSetTextInfo(e))},textOverlayRemove:function(t,e){var i,o;i=this,o=i.sizeGroups[t].textInfos,o[e].$toolbar.remove(),delete o[e],i.textSetTextInfo(t)},textMousedownDragHandler:function(e){var i,o;return o=this,i=function(i){var s,n,a,d,r,h,p,u,c,l,m;return s=this,h=t(s).closest(".imageEditor-textOverlay"),a=h.data("groupName")||"",u=h.data("textInfoKey")||"",n=o.sizeGroups[a],c=n.$sizeBox,p=n.textInfos[u],d=h.position(),l=c.width(),m=c.height(),r={left:d.left,top:d.top,width:h.width(),height:h.height(),pageX:i.pageX,pageY:i.pageY},i.dragImmediately=!0,t.drag(this,i,function(){},function(i){var o,s,n;o=i.pageX-r.pageX,s=i.pageY-r.pageY,n=e(i,r,{x:o,y:s}),n=t.extend({},r,n),n.left<0&&(n.left=0),n.top<0&&(n.top=0),n.top+r.height>m&&(n.top=m-r.height),n.moving?n.left+n.width>l&&(n.left=l-n.width):n.left+n.width>l&&(n.width=l-n.left),p.x=n.left/l,p.y=n.top/m,p.width=n.width/l,n.left=100*p.x+"%",n.top=100*p.y+"%",n.width=100*p.width+"%",n.height="auto",h.css(n)},function(){o.textSetTextInfo(a,n.textInfos)}),!1}},hotspotInit:function(){var e,i;i=this,i.dom.$hotspots=i.$element.closest(".inputContainer").find(".hotSpots"),0!==i.dom.$hotspots.length&&(i.tabsCreate("hotspots"),i.dom.$hotspotPopups=t("<div/>",{"class":"imageEditor-hotSpotPopups"}).appendTo(i.dom.$hotspots.closest("form")),i.dom.$hotspotImage=i.dom.$imageClone.clone(),i.dom.$hotspotImageWrapper=t("<div/>",{"class":"imageEditor-image",style:"position:relative",html:i.dom.$hotspotImage}).appendTo(i.dom.tabs.hotspots),e=i.dom.$hotspots.closest(".inputContainer"),i.dom.$hotspots.appendTo(i.dom.tabs.hotspots),e.hide(),i.dom.$hotspots.find("> ul").first().hide(),i.hotspotOverlayResetAll(),i.dom.$hotspots.on("create change",function(t){i.hotspotInputSetDefaults(),i.hotspotOverlayResetAll(),"change"===t.type&&i.hotspotEdit(t.target.closest("li"))}),i.$element.on("imageUpdated",function(e,o){var s;s=t(i.cloneCanvas(o.get(0))),i.dom.$hotspotImage.before(s),i.dom.$hotspotImage.remove(),i.dom.$hotspotImage=s,i.hotspotOverlayResetAll()}),i.dom.tabs.hotspots.on("tabbedShow",function(){i.hotspotOverlayResetAll()}))},hotspotOverlayResetAll:function(){var e;e=this,e.hotspotOverlayRemoveAll(),e.dom.$hotspots.find("> ul > li > .objectInputs").each(function(){var i,o;o=t(this),o.find(':input[name$="cms.image.x"], :input[name$="cms.image.y"], :input[name$="cms.image.width"], :input[name$="cms.image.height"]').closest(".inputContainer").hide(),i=t("<ul/>").append(o.closest("li")),i.popup({parent:e.dom.$hotspotPopups}).popup("close")}),e.dom.$hotspotPopups.find("ul > li > .objectInputs").each(function(){var i,o;o=t(this),i=e.hotspotInputGet(o),e.hotspotOverlayAdd(o.closest("li"),i)})},hotspotInputGet:function(e){var i,o,s,n,a,d,r,h;switch(r=this,a=t(e),h=r.dom.imageCloneWidth/r.scale,n=r.dom.imageCloneHeight/r.scale,o=h,i=n,s={x:Math.abs(parseInt(a.find(':input[name$="x"]').val())||1),y:Math.abs(parseInt(a.find(':input[name$="y"]').val())||1),width:Math.abs(parseInt(a.find(':input[name$="width"]').val())||0),height:Math.abs(parseInt(a.find(':input[name$="height"]').val())||0)},d=r.adjustmentRotateGet()){case-90:case 270:o=n,i=h,s={width:s.height,height:s.width,x:s.y,y:h-s.x-s.width};break;case 90:case-270:o=n,i=h,s={width:s.height,height:s.width,x:n-s.y-s.height,y:s.x};break;case 180:case-180:s={width:s.width,height:s.height,x:h-s.x-s.width,y:n-s.y-s.height}}return r.adjustmentFlipHGet()&&(90===d||-90===d?s.y=i-s.y-s.height:s.x=o-s.x-s.width),r.adjustmentFlipVGet()&&(90===d||-90===d?s.x=o-s.x-s.width:s.y=i-s.y-s.height),s.xPercent=s.x/o*100,s.yPercent=s.y/i*100,0===s.width?s.widthPercent=0:s.widthPercent=s.width/o*100,0===s.height?s.heightPercent=0:s.heightPercent=s.height/i*100,s},hotspotInputSet:function(e,i){var o,s,n,a,d,r,h,p,u,c;r=this,a=t(e),u=r.dom.$hotspotImage.width(),s=r.dom.$hotspotImage.height(),c=r.dom.imageCloneWidth/r.scale,n=r.dom.imageCloneHeight/r.scale,p=c,o=n,h=r.adjustmentRotateGet(),d=90===h||-90===h?u/n:u/c,t.each(i,function(t,e){i[t]=e/d}),90===h?(p=n,o=c,i={width:i.height,height:i.width,x:i.y,y:n-i.x-i.width}):-90===h&&(p=n,o=c,i={width:i.height,height:i.width,x:c-i.y-i.height,y:i.x}),r.adjustmentFlipHGet()&&(i.x=p-i.x-i.width),r.adjustmentFlipVGet()&&(i.y=o-i.y-i.height),a.find(':input[name$="x"]').val(parseInt(i.x)),a.find(':input[name$="y"]').val(parseInt(i.y)),a.find(':input[name$="width"]').val(parseInt(i.width)),a.find(':input[name$="height"]').val(parseInt(i.height))},hotspotInputSetDefaults:function(){var e,i,o,s,n,a,d;a=this,d=a.dom.imageCloneWidth/a.scale,n=a.dom.imageCloneHeight/a.scale,e=parseInt(d/4),i=parseInt(n/4),o=parseInt(d/2),s=parseInt(n/2),a.dom.$hotspots.find(".objectInputs").each(function(){var n;n=t(this),n.find(':input[name$="x"]').val(function(t,i){return""===i?e:i}),n.find(':input[name$="y"]').val(function(t,e){return""===e?i:e}),n.find(':input[name$="width"]').val(function(t,e){return""===e?o:e}),n.find(':input[name$="height"]').val(function(t,e){return""===e?s:e})})},hotspotOverlayAdd:function(e,i){var o,s,n,a;a=this,n=t(e),o=t("<div/>",{"class":"imageEditor-hotSpotOverlay",css:{height:i.heightPercent+"%",left:i.xPercent+"%",position:"absolute",top:i.yPercent+"%",width:i.widthPercent+"%","z-index":1},click:function(){return a.hotspotEdit(n),!1}}).appendTo(a.dom.$hotspotImageWrapper),n.data("hotspotOverlay",o),o.data("hotspotInput",n),o.toggleClass("toBeRemoved",n.hasClass("toBeRemoved")),s=t("<div/>",{"class":"imageEditor-hotSpotOverlayBox",css:{height:"100%",position:"absolute",width:"100%","z-index":1}}).appendTo(o),t("<div/>",{"class":"imageEditor-textOverlayLabel",text:"HotSpot",mousedown:a.hotspotMousedownDragHandler(function(t,e,i){return n.addClass("state-focus"),a.hotspotSelect(n),{moving:!0,left:e.left+i.x,top:e.top+i.y}})}).appendTo(o),t("<div/>",{"class":"imageEditor-textOverlayRemove",text:"Remove",click:function(){return a.hotspotRemove(o),!1}}).appendTo(o),0===i.width?(o.css("width","10px"),o.css("height","10px")):t("<div/>",{"class":"imageEditor-resizer imageEditor-resizer-bottomRight",mousedown:a.hotspotMousedownDragHandler(function(t,e,i){return n.addClass("state-focus"),a.hotspotSelect(n),{width:e.width+i.x,height:e.height+i.y}})}).appendTo(s)},hotspotEdit:function(e){var i,o,s;s=this,o=t(e),s.hotspotSelect(o),i=o.data("hotspotOverlay"),s.$element.find(".state-focus").removeClass("state-focus"),o.addClass("state-focus"),o.popup("source",i).popup("open"),o.find(":input:not(:hidden):not([disabled])").length||o.popup("close")},hotspotSelect:function(e){var i,o;o=this,o.hotspotUnselect(),i=t(e),$hotspotOverlay=i.data("hotspotOverlay"),$hotspotOverlay.addClass("selected"),$hotspotOverlay.appendTo($hotspotOverlay.parent());
},hotspotUnselect:function(){var t;t=this,t.$element.find(".imageEditor-hotSpotOverlay").removeClass("selected")},hotspotRemove:function(e){var i,o,s,n,a,d,r;a=this,s=t(e),n=[s],o=s.css("left"),d=s.css("top"),r=s.css("width"),i=s.css("height"),a.$element.find(".imageEditor-hotSpotOverlay").not(s).each(function(){var e;e=t(this),e.css("left")===o&&e.css("top")===d&&e.css("width")===r&&e.css("height")===i&&n.push(e)}),t.each(n,function(t,e){var i,o;o=!e.hasClass("toBeRemoved"),i=e.data("hotspotInput"),o?(e.addClass("toBeRemoved"),a.hotspotInputMarkToBeRemoved(i)):(e.removeClass("toBeRemoved"),a.hotspotInputRestore(i),a.hotspotEdit(i))})},hotspotInputMarkToBeRemoved:function(e){var i;i=t(e),i.addClass("toBeRemoved"),i.find(":input").prop("disabled","disabled")},hotspotInputRestore:function(e){var i;i=t(e),i.removeClass("toBeRemoved"),i.find(":input").prop("disabled",!1)},hotspotOverlayRemoveAll:function(){var t;t=this,t.$element.find(".imageEditor-hotSpotOverlay").remove()},hotspotMousedownDragHandler:function(e){var i,o;return o=this,i=function(i){var s,n,a,d,r,h,p,u;return d=t(this),h=d.closest(".imageEditor-hotSpotOverlay"),p=h.find(".imageEditor-hotSpotOverlayBox"),a=h.data("hotspotInput"),u=h.position(),r={left:u.left,top:u.top,width:p.width(),height:p.height(),pageX:i.pageX,pageY:i.pageY},n=o.dom.$hotspotImage.width(),s=o.dom.$hotspotImage.height(),t.drag(this,event,function(){},function(i){var o,a,d,p;a=i.pageX-r.pageX,d=i.pageY-r.pageY,o=e(i,r,{x:a,y:d}),o=t.extend({},r,o),o.moving?(o.left<0&&(o.left=0),o.top<0&&(o.top=0),0===o.width&&(o.width=10),p=o.left+o.width-n,p>0&&(o.left-=p),p=o.top+o.height-s,p>0&&(o.top-=p)):(o.width<10&&(o.width=10),o.height<10&&(o.height=10),o.left<0&&(o.width+=o.left,o.left=0),o.top<0&&(o.height+=o.top,o.top=0),p=o.left+o.width-n,p>0&&(o.width-=p),p=o.top+o.height-s,p>0&&(o.height-=p)),h.css(o)},function(){var t;t=h.position(),o.hotspotInputSet(a,{x:t.left,y:t.top,width:p.width(),height:p.height()})}),!1}},scrollFix:function(e){var i;i=this,t(e).bind("mouswheel",function(t,e,o,s){i.elementIsScrolledToMax(this,s)&&t.preventDefault()})},elementIsScrolledToMax:function(e,i){var o,s,n,a,d;return o=this,s=t(e),n="imageEditor-maxScrollTop",a=s.data(n),d=s.scrollTop(),"undefined"==typeof a&&(a=s.prop("scrollHeight")-s.innerHeight(),s.data(n,a)),i>0&&0===d||0>i&&d>=a?!0:!1},getCanvasWidth:function(){var t,e;return t=this,e=t.dom.$image.parent().find("canvas").width()},getCanvasHeight:function(){var t,e;return t=this,e=t.dom.$image.parent().find("canvas").height()},getClickPositionInElement:function(e,i){var o,s,n,a,d,r;return o=t(e),a=o.width(),s=o.height(),n=o.offset(),d=Math.ceil(i.pageX-n.left)||1,r=Math.ceil(i.pageY-n.top)||1,0>=d&&(d=1),0>=r&&(r=1),{x:d,y:r,xPercent:d/a,yPercent:r/s,width:a,height:s}},cloneCanvas:function(e){var i,o;return t(e).is("canvas")?(o=document.createElement("canvas"),i=o.getContext("2d"),o.width=e.width,o.height=e.height,i.drawImage(e,0,0),o):t(e).clone()},getImageSize:function(e){var i,o,s,n;return i=t.Deferred(),s=t(e),n=s.prop("naturalWidth"),o=s.prop("naturalHeight"),n||o?i.resolve(n,o):(t("<img/>").on("load",function(){var e,o,s;o=t(this),s=o.prop("naturalWidth")||o.prop("width")||0,e=o.prop("naturalHeight")||o.prop("height")||0,i.resolve(s,e)}).on("error",function(){i.resolve(0,0)}).attr("src",s.attr("src")),setTimeout(function(){i.resolve(0,0)},1e4)),i.promise()},htmlDecode:function(t){return String(t).replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&amp;/g,"&").replace(/&quot;/g,'"')}},e.onDomInsert(document,".imageEditor",{insert:function(e){if(!ENABLE_PADDED_CROPS){var i;i=Object.create(o),i.init(e),t(e).data("imageEditor",i)}}}),o});