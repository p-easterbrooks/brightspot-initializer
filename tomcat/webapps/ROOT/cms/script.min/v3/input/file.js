define(["jquery","bsp-utils","bsp-uploader"],function(e,a,t){function i(){var a=this,t=a.el;if(a.isMultiple)t.hide();else{var i=t.closest(".fileSelector"),n=i.find("select").first();n.find('option[value="keep"]').size()<1&&n.prepend(e("<option/>",{"data-hide":".fileSelectorItem","data-show":".fileSelectorExisting",value:"keep",text:"Keep Existing"})),n.val("keep")}}function n(e,a,t){var i=this,n=i.el,a=i.files[t],l=n.closest(".inputSmall");l.append(f());var d=l.find(".upload-preview").eq(t);a.type.match("image.*")&&!i.isMultiple?o(d.find("img").first(),a):(c(d),d.addClass("loading"))}function l(e,a){var t=this,i=t.el.closest(".inputSmall").find("[data-progress]").eq(a);i.attr("data-progress",Math.min(Math.round(100*e.loaded/e.total),Math.max(i.attr("data-progress"),Math.round(14*Math.random()+80))))}function d(e,a,t){var i=this,n=i.el,l=n.closest(".inputSmall");200==e.status?(l.find("[data-progress]").eq(t).attr("data-progress",100),r(i,e,a,t)):p(i,e,a,t)}function s(){var e=this;e.isMultiple&&e.el.attr("name","")}function r(a,t,i,n){var l,d,s,r,p,o;if(l=a.el,d=l.closest(".inputSmall"),p=d.find(".upload-preview").eq(n),o=t.responseText,a.isMultiple)r={},s=l.attr("name"),r.preview=!0,r.inputName=s,r[s]=o,e.ajax({url:window.CONTEXT_PATH+"content/upload",type:"POST",dataType:"html",data:r}).done(function(a){var t=e(a),n=e(t.find("img"));if(n.size()>0){var l=n.attr("src");n.attr("src",""),n.load(function(){p.find(".upload-progress").detach(),n.show(),p.removeClass("loading"),p.append(e("<div/>",{"class":"upload-preview-label"}).text(i.name))}),n.hide(),p.prepend(n),n.attr("src",l)}d.prepend(e("<input />",{type:"hidden",name:s,value:o}))});else{s=l.attr("data-input-name");var c=s+".file.json";r={},r.inputName=s,r.fieldName=d.parent().attr("data-field-name"),r.typeId=l.data("type-id"),r[c]=o,r[s+".action"]="keep",p.removeClass("loading"),e.ajax({url:window.CONTEXT_PATH+"content/field/file",type:"POST",dataType:"html",data:r}).done(function(a){p.detach();var t=e(a);d.replaceWith(t),t.find(".fileSelectorItem:not(.fileSelectorExisting)").hide()})}}function p(e,a,t,i){var n,l,d;n=e.el,l=n.closest(".inputSmall"),d=l.find(".upload-preview").eq(i),d.addClass("error")}function o(e,a){if(window.File&&window.FileReader&&window.FileList){var t=new FileReader;t.onload=function(a){return function(a){e.attr("src",a.target.result),e.closest(".upload-preview").addClass("loading")}}(a),t.readAsDataURL(a)}}function c(a){var t=e(a),i=t.find(".upload-progress").first();t.width(150).height(150),i.width(150).height(150)}function f(){return e("<div/>",{"class":"upload-preview"}).append(e("<div/>",{"class":"upload-progress"}).append(e("<img/>")).append(e("<div/>",{"class":"radial-progress","data-progress":"0"}).append(e("<div/>",{"class":"circle"}).append(e("<div/>",{"class":"mask full"}).append(e("<div/>",{"class":"fill"}))).append(e("<div/>",{"class":"mask half"}).append(e("<div/>",{"class":"fill"})).append(e("<div/>",{"class":"fill fix"})))).append(e("<div/>",{"class":"inset"}).append(e("<div/>",{"class":"percentage"}).append(e("<span/>"))))))}return a.plugin(!1,"bsp","uploader",{_each:function(a){var r=Object.create(t);r.init(e(a),{path:window.UPLOAD_PATH}),r.before=i,r.beforeEach=n,r.progress=l,r.afterEach=d,r.after=s}})});