define(["jquery","v3/spellcheck","codemirror/lib/codemirror","codemirror/addon/hint/show-hint","codemirror/addon/dialog/dialog","codemirror/addon/search/searchcursor","codemirror/addon/search/search"],function($,spellcheckAPI,CodeMirror){var CodeMirrorRte;return CodeMirrorRte={styles:{html:{className:"rte2-style-html",raw:!0},newline:{className:"rte2-style-newline",internal:!0},collapsed:{className:"rte2-style-collapsed"},trackInsert:{className:"rte2-style-track-insert",element:"ins",internal:!0},trackDelete:{className:"rte2-style-track-delete",element:"del",internal:!0,showFinal:!1},trackHideFinal:{className:"rte2-style-track-hide-final",internal:!0},trackDisplay:{className:"rte2-style-track-display",internal:!0},linebreak:{line:!0}},clipboardSanitizeRules:{},clipboardSanitizeFunction:function(e){return e},trackChanges:!1,trackDisplay:!0,newLineRegExp:/^(br)$/,voidElements:{area:!0,base:!0,br:!0,col:!0,command:!0,hr:!0,img:!0,input:!0,keygen:!0,link:!0,meta:!0,param:!0,source:!0},rawAddDataAttribute:!1,rawBr:!0,init:function(e,t){var n;n=this,t&&$.extend(!0,n,t),n.$el=$(e).first(),codeMirrorOptions={lineWrapping:!0,dragDrop:!1,mode:null,extraKeys:n.getKeys()},n.$el.is("textarea")?n.codeMirror=CodeMirror.fromTextArea(n.$el[0],codeMirrorOptions):n.codeMirror=CodeMirror(n.$el[0],codeMirrorOptions),n.classes=n.getClassNameMap(),n.enhancementInit(),n.initListListeners(),n.onClickInit(),n.initEvents(),n.clipboardInit(),n.trackInit(),n.spellcheckInit(),n.modeInit()},initListListeners:function(){var e,t,n,r,o,a,i;i=this,e=i.codeMirror,e.on("beforeChange",function(l,u){var c,s,h;o=i.blockGetListType(u.from.line),a={from:u.from,to:u.from},h={from:u.from,to:u.to},c="",h.from.line>0&&(c=i.blockGetListType(h.from.line-1)),s="",h.to.line<e.lineCount()-1&&(s=i.blockGetListType(h.to.line+1)),t=Boolean(""===c),n=Boolean(""===s),isStartOfLine=Boolean(0===h.from.ch),r=Boolean(""===e.getLine(h.from.line)),$.each(u.text,function(e,t){return t.length>0?(r=!1,!1):void 0})}),e.on("change",function(e,l){var u;o&&(u=i.getRange(),n&&r?i.blockRemoveStyle(o,u):t&&isStartOfLine||(i.blockSetStyle(o,a),i.blockSetStyle(o,u)))})},initEvents:function(){var e,t;t=this,e=t.codeMirror,e.on("cursorActivity",function(e,n){t.$el.trigger("rteCursorActivity",[t])}),e.on("changes",$.debounce(200,function(e,n){t.triggerChange()})),e.on("focus",function(e,n){t.$el.trigger("rteFocus",[t])}),e.on("blur",function(e,n){t.$el.trigger("rteBlur",[t])})},triggerChange:function(){var e;e=this,e.$el.trigger("rteChange",[e])},toggleStyle:function(e,t){var n,r,o;return r=this,o=r.styles[e],o&&(n=o.line?r.blockToggleStyle(e,t):r.inlineToggleStyle(e,t)),n},setStyle:function(e,t){var n,r,o;return r=this,o=r.styles[e],o&&(o.line?r.blockSetStyle(e,t):n=r.inlineSetStyle(e,t)),n},removeStyles:function(e){var t;t=this,e=e||t.getRange(),t.inlineRemoveStyle("",e),(0===e.from.ch&&0===e.to.ch||e.from.line!==e.to.line)&&t.blockRemoveStyle("",e)},inlineToggleStyle:function(e,t){var n,r;return r=this,t=t||r.getRange(),r.inlineIsStyle(e,t)?r.inlineRemoveStyle(e,t):n=r.inlineSetStyle(e,t),n},inlineSetStyle:function(e,t,n){var r,o,a,i,l,u,c,s;return c=this,o=c.codeMirror,t=t||c.getRange(),n=n||{},s="string"==typeof e?c.styles[e]||{}:e,r=s.className,s.singleLine&&t.from.line!==t.to.line&&(i=o.getLine(t.from.line),t.to.line=t.from.line,t.to.ch=i.length),u=$.extend({className:r,startStyle:r+"-start",endStyle:r+"-end",inclusiveRight:!0,addToHistory:!0},n),a=t.from.line===t.to.line&&t.from.ch===t.to.ch,a?(u.addToHistory=!1,u.clearWhenEmpty=!1,u.inclusiveLeft=!0,l=o.markText(t.from,t.to,u)):(l=o.markText(t.from,t.to,u),c.inlineSplitMarkAcrossLines(l)),s.clear&&$.each(s.clear,function(e,n){c.inlineRemoveStyle(n,t)}),s.filterFromHTML&&s.filterFromHTML(l),CodeMirror.signal(o,"cursorActivity"),n.triggerChange!==!1&&c.triggerChange(),l},inlineRemoveStyle:function(e,t,n){var r,o,a,i,l,u,c;l=this,a=l.codeMirror,e&&(r=l.styles[e].className),n=n||{},o=n.deleteText,t=t||l.getRange(),u=t.from,c=t.to,i=u.line,l.inlineCleanup(),a.eachLine(u.line,c.line+1,function(e){var t,s,h;t=i===u.line?u.ch:0,s=i===c.line?c.ch:e.text.length,h=e.markedSpans||[],h.forEach(function(u){var c,h,m,f,d,g,p,A,C;f=!1,r?f=Boolean(u.marker.className===r):(A=l.classes[u.marker.className]||{},f=Boolean(n.includeTrack||A.internal!==!0),u.marker.className===n.except&&(f=!1)),f&&(h=u.marker,h.addToHistory=!1,m=$.extend(!0,{},h),m.inclusiveLeft=m.inclusiveRight=!1,"bookmark"!==h.type&&(C=u.to,c=u.from,null===u.to&&(C=e.text.length),null===u.from&&(c=0),d=t>C||c>s,d||(g=c>=t,p=s>=C,g&&p?o&&(u.marker.shouldDeleteText=!0):g&&!p?(a.markText({line:i,ch:s},{line:i,ch:C},h),o&&(a.markText({line:i,ch:c},{line:i,ch:s},h).shouldDeleteText=!0)):!g&&p?(a.markText({line:i,ch:c},{line:i,ch:t},m),o&&(a.markText({line:i,ch:t},{line:i,ch:C},h).shouldDeleteText=!0)):(a.markText({line:i,ch:s},{line:i,ch:C},h),a.markText({line:i,ch:c},{line:i,ch:t},m),o&&(a.markText({line:i,ch:t},{line:i,ch:s},h).shouldDeleteText=!0)),u.marker.shouldRemove=!0)))}),i++}),a.getAllMarks().forEach(function(e){var t;o&&e.shouldDeleteText&&(t=e.find(),t&&(a.replaceRange("",t.from,t.to,"+brightspotFormatRemoveClass"),n.triggerChange!==!1&&l.triggerChange())),e.shouldRemove&&(e.clear(),n.triggerChange!==!1&&l.triggerChange())}),CodeMirror.signal(a,"cursorActivity")},inlineRemoveStyledText:function(e,t){var n,r,o;o=this,n=o.inlineGetMark(e,t),n&&(r=n.find(),o.codeMirror.replaceRange("",r.from,r.to,"brightspotRemoveStyledText"),n.clear(),o.triggerChange())},inlineIsStyle:function(e,t){var n,r,o;return r=this,n=r.styles[e].className,t=t||r.getRange(),o=r.inlineGetStyles(t),Boolean(o[e])},inlineGetMark:function(e,t){var n,r,o,a;return a=this,r=a.codeMirror,n=a.styles[e].className,t=t||a.getRange(),$.each(r.findMarks(t.from,t.to),function(e,t){return t.className===n?(o=t,!1):void 0}),o},inlineHasStyle:function(e,t){var n,r,o;return n=this,t=t||n.getRange(),r=n.inlineGetStyles(t),o=r[e],Boolean(o===!0||o===!1)},inlineGetStyles:function(e){var t,n,r,o,a,i;return a=this,r=a.codeMirror,e=e||a.getRange(),o=e.from.line,i={},t={},n=!0,r.eachLine(e.from.line,e.to.line+1,function(n){var a,i,l,u;for(l=o===e.from.line?e.from.ch:0,a=o===e.to.line?e.to.ch:n.text.length,u=Boolean(l!==a),i=l;a>=i;i++){var c,s;c={},s=r.findMarksAt({line:o,ch:i}),s.forEach(function(e){var t,n;e.className&&(n=e.find(),t=Boolean(2>a-l),t&&n.from.line===o&&n.from.ch===i&&!e.inclusiveLeft||t&&n.to.line===o&&n.to.ch===i&&!e.inclusiveRight||(c[e.className]=!0))}),o===e.from.line&&i===e.from.ch?t=$.extend({},c):(u&&$.each(t,function(e,n){c[e]||(t[e]=!1)}),$.each(c,function(e){t[e]||(t[e]=!1)}))}o++}),$.each(t,function(e,t){var n;n=a.classes[e],n&&(i[n.key]=t)}),i},inlineCollapse:function(e,t){var n,r,o,a,i;i=this,r=i.codeMirror,n=i.styles[e].className,t=t||i.getRange(),o=[],a=[],$.each(r.findMarks(t.from,t.to),function(e,t){t.className==n?o.push(t):t.collapsed&&a.push(t)}),$.each(o,function(t,n){var o,a,l,u;o=n.markCollapsed,o&&o.find()||(l=$("<span/>",{"class":i.styles.collapsed.className,text:"…"}),u={inclusiveRight:!1,inclusiveLeft:!1,replacedWith:l[0],clearOnEnter:!0},a=n.find(),o=r.markText(a.from,a.to,u),o.collapsed=n,o.styleKey=e,l.on("click",function(){return o.clear(),delete n.markCollapsed,!1}),n.markCollapsed=o)})},inlineUncollapse:function(e,t){var n,r,o;o=this,r=o.codeMirror,n=o.styles[e].className,t=t||o.getRange(),$.each(r.findMarks(t.from,t.to),function(t,n){n.collapsed&&n.styleKey===e&&(n.clear(),delete n.collapsed.markCollapsed)})},inlineToggleCollapse:function(e,t){var n,r,o,a,i,l;l=this,r=l.codeMirror,n=l.styles[e].className,t=t||l.getRange(),a=[],i=[],$.each(r.findMarks(t.from,t.to),function(e,t){t.className==n?a.push(t):t.collapsed&&i.push(t)}),$.each(a,function(e,t){var n;return n=t.markCollapsed,n&&n.find()?void 0:(o=!0,!1)}),a.length&&(o?l.inlineCollapse(e,t):l.inlineUncollapse(e,t))},inlineCleanup:function(){var e,t,n;n=this,t=n.codeMirror,e=t.getDoc(),$.each(t.getAllMarks(),function(e,t){n.inlineSplitMarkAcrossLines(t)}),n.inlineCombineAdjacentMarks()},rawCleanup:function(){var e,t;t=this,e=t.codeMirror,$.each(e.getAllMarks(),function(n,r){var o,a,i,l,u;if(a=t.classes[r.className]||{},a.raw){if(o=r.find()||{},!o.from)return;i=o.from,l=o.to,u=e.findMarks(i,l),u.length>1&&$.each(u,function(e,n){var a;if(n.className!==r.className)return a=n.find()||{},a.from.ch!==o.to.ch&&a.to.ch!==o.from.ch?(t.inlineRemoveStyle("",{from:i,to:l},{includeTrack:!0,except:r.className,triggerChange:!1}),!1):void 0})}})},inlineSplitMarkAcrossLines:function(e){var t,n,r,o,a,i;if(a=this,t=a.codeMirror,e=e.marker?e.marker:e,o=e.find(),o&&o.from&&(i=o.from,n=o.to,n.line!==i.line)){for(r=i.line;r<=n.line;r++){var l,u,c;l=r===i.line?i.ch:0,c=r===n.line?n.ch:t.getLine(r).length,u=t.markText({line:r,ch:l},{line:r,ch:c},e),u.attributes=e.attributes}e.clear()}},inlineCombineAdjacentMarks:function(){var e,t,n;n=this,e=n.codeMirror,t=e.getAllMarks(),t=$.map(t,function(e,t){return"bookmark"===e.type?void 0:e}),t=t.sort(function(e,t){var n,r;return n=e.find(),r=t.find(),n.from.line===r.from.line?n.from.ch-r.from.ch:n.from.line-r.from.line}),marksByClassName={},$.each(t,function(e,t){var r;r=t.className,n.classes[r]&&(n.classes[r].onClick||(marksByClassName[r]||(marksByClassName[r]=[]),marksByClassName[r].push(t)))}),$.each(marksByClassName,function(t,n){var r,o,a,i,l,u;for(r=0;n[r]&&(o=n[r],a=n[r+1]);)l=o.find(),u=a.find(),l.from.line===u.from.line&&u.from.ch<=l.to.ch&&(i=e.markText({line:l.from.line,ch:l.from.ch},{line:l.from.line,ch:Math.max(l.to.ch,u.to.ch)},o),o.clear(),a.clear(),n[r+1]=i),r++})},blockToggleStyle:function(e,t){var n,r;return r=this,t=t||r.getRange(),r.blockIsStyle(e,t)?r.blockRemoveStyle(e,t):n=r.blockSetStyle(e,t),n},blockSetStyle:function(e,t,n){var r,o,a,i,l;for(i=this,o=i.codeMirror,t=t||i.getRange(),n=n||{},l="string"==typeof e?i.styles[e]:e,r=l.className,a=t.from.line;a<=t.to.line;a++)o.addLineClass(a,"text",r);l.clear&&$.each(l.clear,function(e,n){i.blockRemoveStyle(n,t)}),o.refresh(),n.triggerChange!==!1&&i.triggerChange()},blockRemoveStyle:function(e,t){var n,r,o,a,i;for(i=this,r=i.codeMirror,t=t||i.getRange(),e&&(n=i.styles[e].className),a=t.from.line;a<=t.to.line;a++)n?r.removeLineClass(a,"text",n):(o=r.getLineHandle(a),$.each((o.textClass||"").split(" "),function(e,t){r.removeLineClass(a,"text",t)}));r.refresh(),i.triggerChange()},blockIsStyle:function(e,t){var n,r,o;return r=this,n=r.codeMirror,o=r.blockGetStyles(t),Boolean(o[e])},blockGetStyles:function(e){var t,n,r,o;return r=this,n=r.codeMirror,e=e||r.getRange(),n.eachLine(e.from.line,e.to.line+1,function(e){var n,r;n=e.textClass||"",r={},$.each(n.split(" "),function(e,t){t&&(r[t]=!0)}),t?($.each(t,function(e){r[e]||(t[e]=!1)}),$.each(r,function(e){t[e]||(t[e]=!1)})):t=$.extend({},r)}),o={},t&&$.each(t,function(e,t){var n;n=r.classes[e],n&&(o[n.key]=t)}),o},blockGetListType:function(e){var t,n,r,o,a,i;return i=this,n=i.codeMirror,a="",r=n.getLineHandle(e),o=n.lineInfo(r),t=o.textClass||"",$.each(t.split(" "),function(e,t){var n;return n=i.classes[t],n&&n.elementContainer?(a=n.key,!1):void 0}),a},enhancementInit:function(){var e=this;e.enhancementId=0,e.enhancementCache={}},enhancementAdd:function(e,t,n){var r,o,a,i,l;return i=this,r=i.codeMirror,n=n||{},e=$(e)[0],(null===t||"undefined"==typeof t)&&(a=i.getRange(),t=a.from.line),l={widget:e},n.block?(o=r.addLineWidget(t,e,{above:!0}),o.deleteLineFunction=function(){var e,t;e=i.enhancementGetContent(o),t=$(e).detach(),i.enhancementRemove(o),setTimeout(function(){i.enhancementAdd(t[0],null,n)},100)},o.line.on("delete",o.deleteLineFunction)):o=r.setBookmark({line:t,ch:0},l),o.options=n,$(e).data("enhancementMark",o),o.options.id=i.enhancementId++,i.enhancementCache[o.options.id]=o,setTimeout(function(){i.refresh(),o.changed(),i.triggerChange()},100),o},enhancementMove:function(e,t){var n,r,o,a,i,l,u;return u=this,o=u.codeMirror,options=e.options,l=o.lineCount()-1,i=u.enhancementGetLineNumber(e)+t,0>i?e:(i>l&&(a=o.getLine(l).length,o.replaceRange("\n",{line:l,ch:a},"brightspotEnhancementMove")),t=1*Math.sign(t),u.isLineBlank(i)&&!u.isLineBlank(i+t)&&(i+=t),n=u.enhancementGetContent(e),r=$(n).detach(),u.enhancementRemove(e),e=u.enhancementAdd(r[0],i,options))},enhancementRemove:function(e){var t;t=this,delete t.enhancementCache[e.options.id],e.deleteLineFunction&&e.line.off("delete",e.deleteLineFunction),e.clear(),t.codeMirror.removeLineWidget(e),t.triggerChange()},enhancementGetContent:function(e){return e.node||e.replacedWith},enhancementGetLineNumber:function(e){var t,n;return t=void 0,e.line?t=e.line.lineNo():e.find&&(n=e.find(),n&&(t=n.line)),t},enhancementSetInline:function(e,t){var n,r,o,a;return a=this,t=t||{},o=a.enhancementGetLineNumber(e),n=a.enhancementGetContent(e),r=$(n).detach(),a.enhancementRemove(e),a.enhancementAdd(r[0],o,$.extend({},e.options||{},t,{block:!1}))},enhancementSetBlock:function(e,t){var n,r,o,a;return a=this,t=t||{},o=a.enhancementGetLineNumber(e),n=a.enhancementGetContent(e),r=$(n).detach(),a.enhancementRemove(e),a.enhancementAdd(r[0],o,$.extend({},e.options||{},t,{block:!0}))},enhancementFromHTML:function(e,t){var n;n=this,n.enhancementAdd(e,t,{toHTML:function(){return e.html()}})},enhancementGetMark:function(e){return $(e).data("enhancementMark")},onClickInit:function(){var e,t;t=this,e=t.codeMirror,$(e.getWrapperElement()).on("mousedown",function(n){var r,o,a;t.readOnlyGet()||(o=Date.now(),t.doubleClickTimestamp&&o-t.doubleClickTimestamp<500&&(a=e.coordsChar({left:n.pageX,top:n.pageY},"page"),r=e.findMarksAt(a),r=$.map(r,function(e,n){var r;return r=t.classes[e.className],r&&r.onClick?e:null}),1===r.length?t.onClickDoMark(n,r[0]):r.length>1&&(range=t.markGetRange(r[0]),t.codeMirror.setCursor(range.from),setTimeout(function(){t.onClickSelectMark(n,r)},100))),t.doubleClickTimestamp=o)})},onClickDoMark:function(e,t){var n,r,o;r=this,o=r.classes[t.className],o&&o.onClick&&(n=r.markGetRange(t),r.codeMirror.setSelection(n.from,n.to),o.onClick(e,t))},onClickSelectMark:function(e,t){var n,r,o,a;o=this,e.stopPropagation(),e.preventDefault(),n=$("<div/>",{"class":"rte2-onclick-selector"}),$("<h2/>",{text:"Select a mark to edit:"}).appendTo(n),a=$("<ul/>").appendTo(n),$.each(t.reverse(),function(t,n){var r,i,l;l=o.classes[n.className]||{},r=l.enhancementName||n.className,l.getLabel&&(r=l.getLabel(n)),i=$("<li/>",{html:$("<a/>",{text:r})}).on("click",function(t){t.stopPropagation(),t.preventDefault(),$(this).popup("close"),o.onClickDoMark(e,n)}).appendTo(a)}),n.appendTo("body").popup(),r=$("<div/>",{style:"position:absolute;top:0;left:0;height:1px;overflow:hidden;"}).appendTo("body").css({top:e.pageY+12,left:e.pageX}),n.popup("source",r),n.popup("container").on("close",function(){n.remove(),r.remove()}),n.popup("open")},trackInit:function(){var e,t;t=this,e=t.codeMirror,e.on("beforeChange",function(e,n){t.trackBeforeChange(n)}),t.trackDisplayUpdate()},trackSet:function(e){var t;t=this,t.trackChanges=Boolean(e)},trackToggle:function(){var e;e=this,e.trackSet(!e.trackIsOn())},trackIsOn:function(){var e;return e=this,Boolean(e.trackChanges)},trackBeforeChange:function(e){var t,n,r,o,a,i;if(a=this,n=a.codeMirror,a.trackIsOn())switch(r=n.getCursor("anchor"),e.origin){case"+delete":case"cut":case"brightspotCut":if(i=n.getRange(e.from,e.to),"\n"===i)return;if(a.inlineGetStyles(e).trackInsert===!0)return;e.cancel(),r.line===e.from.line&&r.ch===e.from.ch?n.setCursor(e.to):n.setCursor(e.from),a.trackMarkDeleted({from:e.from,to:e.to});break;case"+input":case"paste":case"brightspotPaste":if(e.from.line===e.to.line&&e.from.ch===e.to.ch){if(o=Boolean(""===e.text.join("")))return;a.inlineSetStyle("trackInsert",{from:e.from,to:e.to}),a.inlineRemoveStyle("trackDelete",{from:e.from,to:e.to}),a.trackAfterPaste(e.from,e.to,e.text)}else e.cancel(),a.trackMarkDeleted({from:e.from,to:e.to}),a.inlineRemoveStyle("trackInsert",{from:e.to,to:e.to},{deleteText:!0}),a.inlineRemoveStyle("trackDelete",{from:e.from,to:e.from}),a.inlineSetStyle("trackInsert",{from:e.from,to:e.from},{inclusiveLeft:!0}),"brightspotPaste"===e.origin&&n.replaceRange(e.text,e.from,void 0,"+brightspotTrackInsert");break;case"+brightspotTrackInsert":a.trackAfterPaste(e.from,e.to,e.text)}else if(t=a.inlineGetStyles({from:e.from,to:e.to}),"trackInsert"in t||"trackDelete"in t)switch(e.origin){case"+delete":case"cut":case"+input":case"paste":e.from.line===e.to.line&&e.from.ch===e.to.ch&&(n.replaceRange(" ",e.from,e.to,"brighspotTrackSpace"),e.update(e.from,{line:e.to.line,ch:e.to.ch+1})),a.inlineRemoveStyle("trackInsert",{from:e.from,to:e.to}),a.inlineRemoveStyle("trackDelete",{from:e.from,to:e.to})}},trackAfterPaste:function(e,t,n){var r,o;r=this,o={line:e.line+n.length-1,ch:n[n.length-1].length},o.line==e.line&&(o.ch+=e.ch),setTimeout(function(){r.inlineRemoveStyle("trackDelete",{from:e,to:o},{deleteText:!0,triggerChange:!1})},1)},trackMarkDeleted:function(e){var t,n;n=this,t=n.codeMirror,textOriginal=t.getRange(e.from,e.to),"\n"!==textOriginal&&(n.inlineGetStyles(e).trackInsert!==!0&&n.inlineSetStyle("trackDelete",e),n.inlineRemoveStyle("trackInsert",e,{deleteText:!0}))},trackAcceptRange:function(e){var t,n;n=this,t=n.codeMirror,n.inlineCleanup(),e=e||n.getRange(),$.each(t.findMarks(e.from,e.to),function(e,t){n.trackAcceptMark(t)})},trackRejectRange:function(e){var t,n;n=this,t=n.codeMirror,n.inlineCleanup(),e=e||n.getRange(),$.each(t.findMarks(e.from,e.to),function(e,t){n.trackRejectMark(t)})},trackAcceptMark:function(e){var t,n,r;r=this,t=r.codeMirror,n=e.find(),n&&e.className===r.styles.trackDelete.className&&t.replaceRange("",n.from,n.to,"+brightspotTrackRejectMark"),e.clear(),r.triggerChange()},trackRejectMark:function(e){var t,n,r;r=this,t=r.codeMirror,n=e.find(),n&&e.className===r.styles.trackInsert.className&&t.replaceRange("",n.from,n.to,"+brightspotTrackRejectMark"),e.clear(),r.triggerChange()},trackDisplaySet:function(e){var t;t=this,t.trackDisplay=e,t.trackDisplayUpdate()},trackDisplayToggle:function(){var e;e=this,e.trackDisplaySet(!e.trackDisplayGet())},trackDisplayGet:function(){var e;return e=this,e.trackDisplay},trackDisplayUpdate:function(){var e,t,n,r;n=this,e=n.codeMirror,r=$(e.getWrapperElement()),r.toggleClass(n.styles.trackDisplay.className,n.trackDisplay),$.each(e.getAllMarks(),function(r,o){var a;a=n.classes[o.className]||{},o.className===n.styles.trackHideFinal.className&&o.clear(),a.showFinal!==!1||n.trackDisplay||(t=o.find(),e.markText(t.from,t.to,{className:n.styles.trackHideFinal.className,collapsed:!0}))})},clipboardInit:function(){var e,t,n,r,o;r=this,e=r.codeMirror,o=$(e.getWrapperElement()),o.on("cut copy",function(e){r.clipboardCopy(e.originalEvent)}),o.on("paste",function(e){r.clipboardPaste(e.originalEvent)}),e.on("beforeChange",function(e,t){"paste"==t.origin&&t.cancel()}),t=navigator.userAgent.toLowerCase().indexOf("firefox")>-1,n=navigator.platform.toUpperCase().indexOf("WIN")>-1,t&&n&&(r.clipboardUsePasteWorkaround=!0,r.$clipboardDiv=$("<div/>",{"class":"rte2-clipboard"}).attr("contenteditable","true").appendTo(r.$el).on("paste",function(e){r.clipboardPaste(e.originalEvent)}),o.on("keydown",function(e){(e.ctrlKey||e.metaKey)&&86==e.keyCode&&(r.clipboardX=window.scrollX,r.clipboardY=window.scrollY,r.$clipboardDiv.focus())}))},clipboardPaste:function(e){var t,n,r,o,a,i,l;r=this,n=r.$clipboardDiv&&r.$clipboardDiv.is(e.target),e&&e.clipboardData&&e.clipboardData.getData&&(i=e.clipboardData.getData("text/brightspot-rte2"),a=e.clipboardData.getData("text/html"),l=e.clipboardData.getData("text/plain"),i?o=i:a?(o=r.clipboardSanitize(a),t=!1):l&&!n&&(o=r.htmlEncode(l).replace(/[\n\r]/g,"<br/>"))),o?(r.fromHTML(o,r.getRange(),t),n&&r.focus(),e.stopPropagation(),e.preventDefault()):n&&(r.$clipboardDiv.empty(),setTimeout(function(){o=r.$clipboardDiv.html(),r.$clipboardDiv.empty(),o=r.clipboardSanitize(o),r.fromHTML(o,r.getRange(),!1),r.focus()},1)),n&&setTimeout(function(){window.scrollTo(r.clipboardX,r.clipboardY)},100)},clipboardSanitize:function(e){var t,n,r;return r=this,t=r.htmlParse(e),n=$(t),r.clipboardSanitizeRules&&(n.find("p").after("<br/>"),$.each(r.clipboardSanitizeRules,function(e,t){n.find(e).wrapInner($("<span>",{"data-rte2-sanitize":t}))})),r.clipboardSanitizeFunction&&(n=r.clipboardSanitizeFunction(n)),n[0]},clipboardCopy:function(e){var t,n,r,o,a;o=this,t=o.codeMirror,r=o.getRange(),a=t.getRange(r.from,r.to),n=o.toHTML(r),e&&e.clipboardData&&e.clipboardData.setData&&(e.clipboardData.setData("text/plain",a),e.clipboardData.setData("text/html",n),e.clipboardData.setData("text/brightspot-rte2",n),"cut"===e.type&&t.replaceRange("",r.from,r.to,"brightspotCut"),e.preventDefault())},spellcheckWordSeparator:'\\s!"#$%&()*+,-./:;<=>?@\\[\\]\\\\^_`{|}~↵',spellcheckWordCharacters:/[\u0027\u2019\u0041-\u005A\u0061-\u007A\u00AA\u00B5\u00BA\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02C1\u02C6-\u02D1\u02E0-\u02E4\u02EC\u02EE\u0370-\u0374\u0376\u0377\u037A-\u037D\u0386\u0388-\u038A\u038C\u038E-\u03A1\u03A3-\u03F5\u03F7-\u0481\u048A-\u0527\u0531-\u0556\u0559\u0561-\u0587\u05D0-\u05EA\u05F0-\u05F2\u0620-\u064A\u066E\u066F\u0671-\u06D3\u06D5\u06E5\u06E6\u06EE\u06EF\u06FA-\u06FC\u06FF\u0710\u0712-\u072F\u074D-\u07A5\u07B1\u07CA-\u07EA\u07F4\u07F5\u07FA\u0800-\u0815\u081A\u0824\u0828\u0840-\u0858\u08A0\u08A2-\u08AC\u0904-\u0939\u093D\u0950\u0958-\u0961\u0971-\u0977\u0979-\u097F\u0985-\u098C\u098F\u0990\u0993-\u09A8\u09AA-\u09B0\u09B2\u09B6-\u09B9\u09BD\u09CE\u09DC\u09DD\u09DF-\u09E1\u09F0\u09F1\u0A05-\u0A0A\u0A0F\u0A10\u0A13-\u0A28\u0A2A-\u0A30\u0A32\u0A33\u0A35\u0A36\u0A38\u0A39\u0A59-\u0A5C\u0A5E\u0A72-\u0A74\u0A85-\u0A8D\u0A8F-\u0A91\u0A93-\u0AA8\u0AAA-\u0AB0\u0AB2\u0AB3\u0AB5-\u0AB9\u0ABD\u0AD0\u0AE0\u0AE1\u0B05-\u0B0C\u0B0F\u0B10\u0B13-\u0B28\u0B2A-\u0B30\u0B32\u0B33\u0B35-\u0B39\u0B3D\u0B5C\u0B5D\u0B5F-\u0B61\u0B71\u0B83\u0B85-\u0B8A\u0B8E-\u0B90\u0B92-\u0B95\u0B99\u0B9A\u0B9C\u0B9E\u0B9F\u0BA3\u0BA4\u0BA8-\u0BAA\u0BAE-\u0BB9\u0BD0\u0C05-\u0C0C\u0C0E-\u0C10\u0C12-\u0C28\u0C2A-\u0C33\u0C35-\u0C39\u0C3D\u0C58\u0C59\u0C60\u0C61\u0C85-\u0C8C\u0C8E-\u0C90\u0C92-\u0CA8\u0CAA-\u0CB3\u0CB5-\u0CB9\u0CBD\u0CDE\u0CE0\u0CE1\u0CF1\u0CF2\u0D05-\u0D0C\u0D0E-\u0D10\u0D12-\u0D3A\u0D3D\u0D4E\u0D60\u0D61\u0D7A-\u0D7F\u0D85-\u0D96\u0D9A-\u0DB1\u0DB3-\u0DBB\u0DBD\u0DC0-\u0DC6\u0E01-\u0E30\u0E32\u0E33\u0E40-\u0E46\u0E81\u0E82\u0E84\u0E87\u0E88\u0E8A\u0E8D\u0E94-\u0E97\u0E99-\u0E9F\u0EA1-\u0EA3\u0EA5\u0EA7\u0EAA\u0EAB\u0EAD-\u0EB0\u0EB2\u0EB3\u0EBD\u0EC0-\u0EC4\u0EC6\u0EDC-\u0EDF\u0F00\u0F40-\u0F47\u0F49-\u0F6C\u0F88-\u0F8C\u1000-\u102A\u103F\u1050-\u1055\u105A-\u105D\u1061\u1065\u1066\u106E-\u1070\u1075-\u1081\u108E\u10A0-\u10C5\u10C7\u10CD\u10D0-\u10FA\u10FC-\u1248\u124A-\u124D\u1250-\u1256\u1258\u125A-\u125D\u1260-\u1288\u128A-\u128D\u1290-\u12B0\u12B2-\u12B5\u12B8-\u12BE\u12C0\u12C2-\u12C5\u12C8-\u12D6\u12D8-\u1310\u1312-\u1315\u1318-\u135A\u1380-\u138F\u13A0-\u13F4\u1401-\u166C\u166F-\u167F\u1681-\u169A\u16A0-\u16EA\u1700-\u170C\u170E-\u1711\u1720-\u1731\u1740-\u1751\u1760-\u176C\u176E-\u1770\u1780-\u17B3\u17D7\u17DC\u1820-\u1877\u1880-\u18A8\u18AA\u18B0-\u18F5\u1900-\u191C\u1950-\u196D\u1970-\u1974\u1980-\u19AB\u19C1-\u19C7\u1A00-\u1A16\u1A20-\u1A54\u1AA7\u1B05-\u1B33\u1B45-\u1B4B\u1B83-\u1BA0\u1BAE\u1BAF\u1BBA-\u1BE5\u1C00-\u1C23\u1C4D-\u1C4F\u1C5A-\u1C7D\u1CE9-\u1CEC\u1CEE-\u1CF1\u1CF5\u1CF6\u1D00-\u1DBF\u1E00-\u1F15\u1F18-\u1F1D\u1F20-\u1F45\u1F48-\u1F4D\u1F50-\u1F57\u1F59\u1F5B\u1F5D\u1F5F-\u1F7D\u1F80-\u1FB4\u1FB6-\u1FBC\u1FBE\u1FC2-\u1FC4\u1FC6-\u1FCC\u1FD0-\u1FD3\u1FD6-\u1FDB\u1FE0-\u1FEC\u1FF2-\u1FF4\u1FF6-\u1FFC\u2071\u207F\u2090-\u209C\u2102\u2107\u210A-\u2113\u2115\u2119-\u211D\u2124\u2126\u2128\u212A-\u212D\u212F-\u2139\u213C-\u213F\u2145-\u2149\u214E\u2183\u2184\u2C00-\u2C2E\u2C30-\u2C5E\u2C60-\u2CE4\u2CEB-\u2CEE\u2CF2\u2CF3\u2D00-\u2D25\u2D27\u2D2D\u2D30-\u2D67\u2D6F\u2D80-\u2D96\u2DA0-\u2DA6\u2DA8-\u2DAE\u2DB0-\u2DB6\u2DB8-\u2DBE\u2DC0-\u2DC6\u2DC8-\u2DCE\u2DD0-\u2DD6\u2DD8-\u2DDE\u2E2F\u3005\u3006\u3031-\u3035\u303B\u303C\u3041-\u3096\u309D-\u309F\u30A1-\u30FA\u30FC-\u30FF\u3105-\u312D\u3131-\u318E\u31A0-\u31BA\u31F0-\u31FF\u3400-\u4DB5\u4E00-\u9FCC\uA000-\uA48C\uA4D0-\uA4FD\uA500-\uA60C\uA610-\uA61F\uA62A\uA62B\uA640-\uA66E\uA67F-\uA697\uA6A0-\uA6E5\uA717-\uA71F\uA722-\uA788\uA78B-\uA78E\uA790-\uA793\uA7A0-\uA7AA\uA7F8-\uA801\uA803-\uA805\uA807-\uA80A\uA80C-\uA822\uA840-\uA873\uA882-\uA8B3\uA8F2-\uA8F7\uA8FB\uA90A-\uA925\uA930-\uA946\uA960-\uA97C\uA984-\uA9B2\uA9CF\uAA00-\uAA28\uAA40-\uAA42\uAA44-\uAA4B\uAA60-\uAA76\uAA7A\uAA80-\uAAAF\uAAB1\uAAB5\uAAB6\uAAB9-\uAABD\uAAC0\uAAC2\uAADB-\uAADD\uAAE0-\uAAEA\uAAF2-\uAAF4\uAB01-\uAB06\uAB09-\uAB0E\uAB11-\uAB16\uAB20-\uAB26\uAB28-\uAB2E\uABC0-\uABE2\uAC00-\uD7A3\uD7B0-\uD7C6\uD7CB-\uD7FB\uF900-\uFA6D\uFA70-\uFAD9\uFB00-\uFB06\uFB13-\uFB17\uFB1D\uFB1F-\uFB28\uFB2A-\uFB36\uFB38-\uFB3C\uFB3E\uFB40\uFB41\uFB43\uFB44\uFB46-\uFBB1\uFBD3-\uFD3D\uFD50-\uFD8F\uFD92-\uFDC7\uFDF0-\uFDFB\uFE70-\uFE74\uFE76-\uFEFC\uFF21-\uFF3A\uFF41-\uFF5A\uFF66-\uFFBE\uFFC2-\uFFC7\uFFCA-\uFFCF\uFFD2-\uFFD7\uFFDA-\uFFDC]+/g,spellcheckInit:function(){var e;e=this,e.spellcheckUpdate(),e.$el.on("rteChange",$.debounce(1e3,function(){e.spellcheckUpdate()})),$(e.codeMirror.getWrapperElement()).on("contextmenu",function(t){e.spellcheckShow()&&t.preventDefault()})},spellcheckUpdate:function(){var e,t,n,r,o,a;return e=this,t=e.toText()||"",o=e.spellcheckWordCharacters,(n=t.match(o))?(a={},r=[],$.each(n,function(e,t){a[t]||(r.push(t),a[t]=!0)}),spellcheckAPI.lookup(r).done(function(n){e.spellcheckClear(),$.each(r,function(r,a){var i,l,u,c,s,l,h,m;if(m=a.length,u=n[a],$.isArray(u))for(s=0;(c=t.indexOf(a,s))>-1;)s=c+m,c>0&&(i=t.substr(c-1,1),i.match(o))||c+m<t.length&&(i=t.substr(c+m,1),i.match(o))||(h=t.substring(0,c).split("\n"),line=h.length-1,ch=h[line].length,l={from:{line:line,ch:ch},to:{line:line,ch:ch+m}},e.spellcheckMarkText(l,u))})}).fail(function(t){e.spellcheckClear()})):void e.spellcheckClear()},spellcheckMarkText:function(e,t){var n,r,o;o=this,n=o.codeMirror,r={className:"rte2-style-spelling",inclusiveRight:!1,inclusiveLeft:!1,addToHistory:!1,clearWhenEmpty:!0},mark=n.markText(e.from,e.to,r),mark.spelling=t},spellcheckClear:function(){var e,t;t=this,e=t.codeMirror,e.getAllMarks().forEach(function(e){"rte2-style-spelling"===e.className&&e.clear()})},spellcheckShow:function(e){var t,n,r,e,o,a;if(o=this,t=o.codeMirror,e=e||o.getRange(),n=t.findMarksAt(e.from),$.each(n,function(e,t){return"rte2-style-spelling"===t.className?(r=t.find(),a=t.spelling,!1):void 0}),!r||!a||!a.length)return!1;if(e.from.line!==e.to.line||e.from.ch!==e.to.ch){if(r.from.line!==e.from.line||r.from.ch!==e.from.ch||r.to.line!==e.to.line||r.to.ch!==e.to.ch)return!1;t.setCursor(r.from)}return t.showHint({completeSingle:!1,completeOnSingleClick:!0,hint:function(e,t){return{list:a,from:r.from,to:r.to}}}),!0},modeInit:function(){var e=this;e.mode="rich"},modeGet:function(){var e=this;return"plain"===e.mode?"plain":"rich"},modeToggle:function(){var e,t=this;e=t.modeGet(),"rich"===e?t.modeSetPlain():t.modeSetRich()},modeSetPlain:function(){var e=this,t=e.codeMirror,n=$(t.getWrapperElement());e.mode="plain",n.hide(),e.$el.is("textarea")&&e.$el.show(),e.modeTriggerEvent()},modeSetRich:function(){var e=this,t=e.codeMirror,n=$(t.getWrapperElement());e.mode="rich",e.$el.is("textarea")&&e.$el.hide(),n.show(),e.modeTriggerEvent()},modeTriggerEvent:function(){var e=this;e.$el.trigger("rteModeChange",[e.modeGet()])},caseToggleSmart:function(e){var t,n,r,o;return n=this,e=e||n.getRange(),t=n.codeMirror,r=t.getRange(e.from,e.to)||"",o=r.toUpperCase(),r===o?n.caseToLower(e):n.caseToUpper(e)},caseToLower:function(e){var t,n,r;r=this,e=e||r.getRange(),t=r.toHTML(e),n=r.htmlToLowerCase(t),r.fromHTML(n,e,!0),r.setSelection(e)},caseToUpper:function(e){var t,n,r;r=this,e=e||r.getRange(),t=r.toHTML(e),n=r.htmlToUpperCase(t),r.fromHTML(n,e,!0),r.setSelection(e)},htmlToLowerCase:function(e){var t;return t=this,t.htmlChangeCase(e,!1)},htmlToUpperCase:function(e){var t;return t=this,t.htmlChangeCase(e,!0)},htmlChangeCase:function(e,t){var n,r;return r=this,n=r.htmlParse(e),n&&r.htmlChangeCaseProcessNode(n,t),n},htmlChangeCaseProcessNode:function(e,t){var n,r,o,a;if(a=this,3===e.nodeType)e.nodeValue&&(e.nodeValue=t?e.nodeValue.toUpperCase():e.nodeValue.toLowerCase());else for(n=e.childNodes,o=n.length,r=0;o>r;++r)a.htmlChangeCaseProcessNode(n[r],t)},focus:function(){var e;e=this,e.codeMirror.focus()},isLineBlank:function(e){var t,n,r;return n=this,t=n.codeMirror,r=t.getLine(e)||"",/^\s*$/.test(r)},moveToNonBlank:function(){var e,t,n,r;for(r=this,e=r.codeMirror,t=e.getCursor().line,n=e.lineCount();n>t&&r.isLineBlank(t);)t++;return e.setCursor(t,0),t},getCount:function(){var e;return e=this,e.toText().length},getRange:function(){var e;return e=this,{from:e.codeMirror.getCursor("from"),to:e.codeMirror.getCursor("to")}},setSelection:function(e){var t,n;n=this,t=n.codeMirror,t.setSelection(e.from,e.to)},getRangeAll:function(){var e,t;return e=this,t=e.codeMirror.lineCount(),{from:{line:0,ch:0},to:{line:t-1,ch:e.codeMirror.getLine(t-1).length}}},getClassNameMap:function(){var e,t;return e=this,t={},$.each(e.styles,function(e,n){var r;r=n.className,n.key=e,t[r]=n}),t},getElementMap:function(){var e,t;return e=this,t={},$.each(e.styles,function(e,n){var r;r=n.element,n.key=e,t[r]=t[r]||[],t[r].push(n)}),t},refresh:function(e){var t;t=this,t.codeMirror.refresh()},empty:function(){var e;e=this,$.each(e.enhancementCache,function(t,n){e.enhancementRemove(n)}),e.codeMirror.setValue("")},setCursor:function(e,t){var n;n=this,n.codeMirror.setCursor(e,t)},readOnlyGet:function(){var e;return e=this,e.codeMirror.isReadOnly()},readOnlySet:function(e){var t;t=this,t.codeMirror.setOption("readOnly",e)},markGetRange:function(e){var t,n;return n=this,t={},e.find&&(t=e.find()||{}),t},replaceMarkText:function(e,t){var n,r;r=this,n=r.markGetRange(e),n.from&&(r.codeMirror.replaceRange(t,n.to,n.to),(n.from.line!==n.to.line||n.from.ch!==n.to.ch)&&r.codeMirror.replaceRange("",n.from,n.to))},elementIsContainer:function(e){var t,n;return n=this,t=!1,$.each(n.styles,function(n,r){return e===r.elementContainer?(t=!0,!1):void 0}),t},getKeys:function(){var e,t;return t=this,e={},e["Shift-Enter"]=function(e){t.insert("↵","newline")},e["Ctrl-Space"]=function(e){t.spellcheckShow()},$.each(t.styles,function(n,r){var o;o=r.keymap,o&&($.isArray(r.keymap)||(o=[o]),$.each(o,function(r,o){e[o]=function(e){return t.toggleStyle(n)}}))}),e},toText:function(){var e;return e=this,e.codeMirror.getValue()},toHTML:function(e){function t(e,t){var n="";return t=t||{},e.markToHTML?n=e.markToHTML():e.element&&(n="<"+e.element,$.each($.extend({},e.elementAttr,e.attributes,t),function(e,t){n+=" "+e+'="'+l.htmlEncode(t)+'"'}),l.voidElements[e.element]&&(n+="/"),n+=">"),n}var n,r,o,a,i,l;return l=this,e=e||l.getRangeAll(),l.inlineCleanup(),l.rawCleanup(),o=l.codeMirror.getDoc(),r={},n=[],a={},$.each(l.enhancementCache,function(e,t){var n;n=l.enhancementGetLineNumber(t),void 0!==n&&(a[n]=a[n]||[],a[n].push(t))}),i="",o.eachLine(function(o){var u,c,s,h,m,f,d,g,p,A,C,v,k,y,D;for(v=o.lineNo(),f="",d="",g=[],C=[],s={},e.from.line<=v&&e.to.line>=v&&o.textClass&&$.each(o.textClass.split(" "),function(){var e,o;o=l.classes[this],o&&(e=o.elementContainer,e&&(s[e]=!0,r[e]||(r[e]=!0,f+="<"+e+">")),f+=t(o),n.push(o))}),$.each(r,function(e){s[e]||(delete r[e],e&&(i+="</"+e+">"))}),a[v]&&$.each(a[v],function(t,n){m=v>=e.from.line&&v<=e.to.line,v===e.from.line&&e.from.ch>0&&(m=!1),m&&(enhancementHTML="",n.options.toHTML&&(enhancementHTML=n.options.toHTML()),enhancementHTML&&(i+=enhancementHTML))}),i+=f,u={},c={},o.markedSpans&&$.each(o.markedSpans,function(e,t){var n,r,o,a,i;a=t.from,r=t.to,n=t.marker.className,n&&a!==r&&(i=l.classes[n]||{},(i.element||i.raw)&&(o=t.marker||{},u[a]||(u[a]=[]),c[r]||(c[r]=[]),i.toHTML?u[a].push($.extend(!0,{},i,{markToHTML:function(){return i.toHTML(o)}})):u[a].push($.extend(!0,{},i,{attributes:o.attributes})),c[r].push(i)))}),h=0;h<=o.text.length;h++)m=!0,v===e.from.line&&h<e.from.ch&&(m=!1),v===e.to.line&&h>e.to.ch-1&&(m=!1),m=m&&v>=e.from.line&&v<=e.to.line,v===e.from.line&&h===e.from.ch&&$.each(g,function(e,n){
l.voidElements[n.element]||(C.push(n),i+=t(n))}),(c[h]||v===e.to.line&&e.to.ch<=h)&&($.each(c[h]||[],function(e,t){var n,r;for(t.raw&&(y=!1),p=-1,e=0;e<g.length;e++)g[e].key===t.key&&(p=e);if(p>-1)for(g.splice(p,1),A=p-1;(r=C.pop())&&(n=r.element,n&&!l.voidElements[n]&&(i+="</"+n+">"),r.key!==t.key););}),m&&$.each(g,function(e,n){A>=e||l.voidElements[n.element]||(C.push(n),i+=t(n))})),u[h]&&$.each(u[h],function(e,n){n.raw&&(y=!0),g.push(n),m&&(l.voidElements[n.element]||C.push(n),i+=t(n))}),k=o.text.charAt(h),k&&("↵"===k&&(k="\n"),y?(l.rawAddDataAttribute&&"<"===k&&(k="&raw_lt;"),D=!0):(k=l.htmlEncode(k),D=!1),m&&(i+=k));e.from.line<=v&&e.to.line>=v&&(n.length?($.each(n.reverse(),function(){var e;e=this.element,e&&(i+="</"+e+">")}),n=[]):m&&D&&!l.rawBr?i+="\n":m&&(i+="<br/>"),d&&(i+=d))}),$.each(r,function(e){delete r[e],e&&(i+="</"+e+">")}),l.rawAddDataAttribute&&(i=i.replace(/&raw_lt;(\w+)/g,"<$1 data-rte2-raw").replace(/&raw_lt;/g,"<")),i},fromHTML:function(html,range,allowRaw){function processNode(n,rawParent){var elementAttributes,elementName,elementClose,from,isContainer,matchStyleObj,next,raw,rawChildren,split,to,text;for(next=n.childNodes[0];next;){if(elementAttributes={},3===next.nodeType)text=next.textContent,text=text.replace(/\u200b|\u8203/g,""),allowRaw?text=text.replace(/[\n\r]/g,function(e,t,n){var r,o,a;return o=val.split("\n"),r={line:o.length-1,ch:o[o.length-1].length+t},a={line:r.line,ch:r.ch+1},annotations.push({styleObj:self.styles.newline,from:r,to:a}),"↵"}):(text=text.replace(/[\n\r]/g," ").replace(/\s+/g," "),$(next.parentElement).is("body")&&(text=text.replace(/^\s*|\s*$/g,""))),val+=text;else if(1===next.nodeType){if(elementName=next.tagName.toLowerCase(),elementAttributes=self.getAttributes(next),raw=!1,rawParent?(raw=!0,rawChildren=!0):raw=$(next).is("[data-rte2-raw]"),raw||(matchStyleObj=!1,matchStyleObj=self.styles[$(next).attr("data-rte2-sanitize")],matchArray=map[elementName],matchArray&&!matchStyleObj&&$.each(matchArray,function(e,t){var n;if(!t.elementContainer||t.elementContainer.toLowerCase()===next.parentElement.tagName.toLowerCase())return n={},t.elementAttr?$.each(t.elementAttr,function(e,r){var o;return o=$(next).attr(e),o===r||r===!0&&void 0!==o?(n[e]=!0,void(matchStyleObj=t)):(matchStyleObj=!1,!1)}):matchStyleObj=t,matchStyleObj?!1:void 0})),split=val.split("\n"),from={line:split.length-1,ch:split[split.length-1].length},"table"===elementName||("span"===elementName||"button"===elementName)&&$(next).hasClass("enhancement")){enhancements.push({line:from.line,$content:$(next)}),next=next.nextSibling;continue}if(isContainer=self.elementIsContainer(elementName),isContainer&&$(next).find("li li").length&&(raw=!0,rawChildren=!0),matchStyleObj||isContainer||"br"===elementName||(raw=!0),"br"===elementName&&(raw=!1),raw&&allowRaw&&(matchStyleObj=self.styles.html,val+="<"+elementName,$.each(next.attributes,function(e,t){var n=t.name,r=t.value;"data-rte2-raw"!==n&&(val+=" "+n+'="'+self.htmlEncode(r)+'"')}),self.voidElements[elementName]&&(val+="/"),val+=">",split=val.split("\n"),to={line:split.length-1,ch:split[split.length-1].length},annotations.push({styleObj:matchStyleObj,from:from,to:to}),self.voidElements[elementName]||(elementClose="</"+elementName+">")),processNode(next,rawChildren),elementClose&&(split=val.split("\n"),from={line:split.length-1,ch:split[split.length-1].length},val+=elementClose,elementClose=""),split=val.split("\n"),to={line:split.length-1,ch:split[split.length-1].length},matchStyleObj)if(matchStyleObj.fromHTML)with({matchStyleObj:matchStyleObj,next:next,from:from,to:to})annotations.push({styleObj:$.extend({},matchStyleObj,{filterFromHTML:function(e){matchStyleObj.fromHTML($(next),e)}}),from:from,to:to});else annotations.push({styleObj:matchStyleObj,from:from,to:to,attributes:elementAttributes});(self.newLineRegExp.test(elementName)||matchStyleObj&&matchStyleObj.line)&&(val+="\n")}next=next.nextSibling}}var annotations,editor,enhancements,el,history,map,self,val;self=this,editor=self.codeMirror,allowRaw=allowRaw===!1?!1:!0,map=self.getElementMap(),el=self.htmlParse(html),val="",annotations=[],enhancements=[],processNode(el),val=val.replace(/[\n\r]+$/,"\n"),range?range.from.line===range.to.line&&range.from.ch===range.to.ch?(editor.replaceRange(" ",range.from,range.to,"brightspotRemoveStyles"),self.removeStyles({from:{line:range.from.line,ch:range.from.ch},to:{line:range.from.line,ch:range.from.ch+1}}),editor.undo()):self.removeStyles(range):(self.empty(),range={from:{line:0,ch:0},to:{line:0,ch:0}}),editor.replaceRange(val,range.from,range.to,"brightspotPaste"),history=editor.getHistory(),$.each(annotations.reverse(),function(e,t){var n;n=t.styleObj,(0!==range.from.line||0!==range.from.ch)&&(0===t.from.line&&(t.from.ch+=range.from.ch,0===t.to.line&&(t.to.ch+=range.from.ch)),t.from.line+=range.from.line,t.to.line+=range.from.line),n.line?self.blockSetStyle(n,t,{triggerChange:!1}):self.inlineSetStyle(n,t,{addToHistory:!1,triggerChange:!1,attributes:t.attributes})}),$.each(enhancements,function(e,t){self.enhancementFromHTML(t.$content,t.line)}),editor.setHistory(history),self.triggerChange()},insert:function(e,t){var n,r;r=this,r.codeMirror.replaceSelection(e,"around"),n=r.getRange(),t&&r.setStyle(t,n),r.codeMirror.setCursor(n.to)},htmlEncode:function(e){return String(e).replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&#39;").replace(/</g,"&lt;").replace(/>/g,"&gt;")},htmlParse:function(e){var t,n;return n=this,t="string"===$.type(e)?(new DOMParser).parseFromString(e,"text/html").body:e},historyClear:function(){var e;e=this,e.codeMirror.clearHistory()},find:function(){var e;e=this,e.codeMirror.execCommand("find")},replace:function(){var e;e=this,e.codeMirror.execCommand("replace")},getAttributes:function(e){var t,n,r;return r=this,t={},n=$(e),n.length&&$.each(n.get(0).attributes,function(e,r){var o;o=r.nodeName||r.name,e=n.attr(o),void 0!==e&&e!==!1&&(t[o]=e)}),t}}});