define(["jquery","jquery.extra","wysihtml5-0.3.0"],function(e){function t(){return++s,"contentEnhancement-"+s}var n,a=window,o=e(a),r=a.document,i=e(r),s=0,l="​";e.each(CSS_CLASS_GROUPS,function(){var t="cms-"+this.internalName,n=t+"-",a=new RegExp(n+"[0-9a-z-]+","g");wysihtml5.commands[t]={exec:function(t,o,r){var i=r?e.parseJSON(r):{},s=i.tag||"span",l="span"===s?"formatInline":"formatBlock";return wysihtml5.commands[l].exec(t,o,s,n+i.internalName,a)},state:function(t,o,r){var i=r?e.parseJSON(r):{},s=i.tag||"span",l="span"===s?"formatInline":"formatBlock";return wysihtml5.commands[l].state(t,o,s,n+i.internalName,a)}}});var c,d,m=function(t){var n=e("<span/>",{"class":"rte-group","data-group-name":t}),a=e("<span/>",{"class":"rte-group-label",text:t}),o=e("<span/>",{"class":"rte-group-buttons"});return n.append(a),n.append(o),n},p=function(t,n){return e("<span/>",{"class":"rte-button rte-button-"+n,"data-wysihtml5-command":n,text:t})},f=function(t,n,o,r){var i=e("<div/>",{"class":"rte-toolbar-container"}),s=e("<div/>",{"class":"rte-toolbar"});i.append(s);var l=m("Font");if(s.append(l),l=l.find(".rte-group-buttons"),l.append(p("Bold","bold")),l.append(p("Italic","italic")),l.append(p("Underline","underline")),l.append(p("Strike","strike")),l.append(p("Superscript","superscript")),l.append(p("Subscript","subscript")),e.each(CSS_CLASS_GROUPS,function(){var t=m(this.displayName),n="cms-"+this.internalName;this.dropDown&&t.addClass("rte-group-dropDown"),t.addClass("rte-group-cssClass"),t.addClass("rte-group-cssClass-"+this.internalName),s.append(t),t=t.find(".rte-group-buttons"),e.each(this.cssClasses,function(){var e=p(this.displayName,n);e.attr("data-wysihtml5-command-value",JSON.stringify(this)),t.append(e)})}),!n){var c=m("Alignment");s.append(c),c=c.find(".rte-group-buttons"),c.append(p("Justify Left","textAlign").attr("data-wysihtml5-command-value","left")),c.append(p("Justify Center","textAlign").attr("data-wysihtml5-command-value","center")),c.append(p("Justify Right","textAlign").attr("data-wysihtml5-command-value","right"));var d=m("List");s.append(d),d=d.find(".rte-group-buttons"),d.append(p("Unordered List","insertUnorderedList")),d.append(p("Ordered List","insertOrderedList"))}var f=m("Enhancement");if(s.append(f),f=f.find(".rte-group-buttons"),f.append(p("Link","link")),n||(f.append(p("Enhancement","insertEnhancement")),f.append(p("Marker","insertMarker"))),a.cmsRteImportOptions&&a.cmsRteImportOptions.length>0){var u=m("Import");u.addClass("rte-group-dropDown"),s.append(u),u=u.find(".rte-group-buttons"),e.each(a.cmsRteImportOptions,function(n,a){u.append(e("<span/>",{"class":"rte-button rte-button-import",text:a.name,click:function(){e(this);google.load("picker","1",{callback:function(){(new google.picker.PickerBuilder).enableFeature(google.picker.Feature.NAV_HIDDEN).setAppId(a.clientId).setOAuthToken(a.accessToken).addView(google.picker.ViewId.DOCUMENTS).setCallback(function(n){n[google.picker.Response.ACTION]===google.picker.Action.PICKED&&e.ajax({method:"get",url:"/social/googleDriveFile",data:{id:n[google.picker.Response.DOCUMENTS][0][google.picker.Document.ID]},cache:!1,success:function(e){t.composer.setValue(e,!0),t.composer.parent.updateOverlay()}})}).build().setVisible(!0)}})}}))})}var h=m("Changes");s.append(h),h=h.find(".rte-group-buttons"),h.append(p("Track","changesTrack")),h.append(p("Accept","changesAccept")),h.append(p("Reject","changesReject")),h.append(p("Preview","changesPreview"));var g=m("Comments");s.append(g),g=g.find(".rte-group-buttons"),g.append(p("Comment","commentAdd")),g.append(p("Collapse","commentCollapse")),g.append(p("Remove","commentRemove"));var v=m("Misc");return s.append(v),v=v.find(".rte-group-buttons"),v.append(e("<span/>",{"class":"rte-button rte-button-html","data-wysihtml5-action":"change_view",text:"HTML"})),v.append(p("Fullscreen","fullscreen")),i[0]},u=function(t,n){return e("<span/>",{"class":"rte-button rte-button-"+n,"data-action":n,text:t})},h=function(n){var a=e("<div/>",{"class":"rte-enhancement"}),o=e("<div/>",{"class":"rte-toolbar"});a.append(o);var r=m("Position");o.append(r),r.append(u("Move Up","moveUp")),r.append(u("Move Down","moveDown")),r.append(u("Move Left","moveLeft")),r.append(u("Move Center","moveCenter")),r.append(u("Move Right","moveRight"));var i=m("Image Size");i.addClass("rte-group-dropDown"),o.append(i),i=i.find(".rte-group-buttons");var s=e(n.container).closest(".inputContainer").attr("data-standard-image-sizes");s&&(s=" "+s+" "),i.append(u("None","imageSize-")),e.each(STANDARD_IMAGE_SIZES,function(){s.indexOf(" "+this.internalName+" ")>-1&&i.append(u(this.displayName,"imageSize-"+this.internalName))});var l=m("Misc");o.append(l);var c,d,p;return c=e("form.contentForm").attr("action")||"",d=(/id=([^&]+)/.exec(c)||[])[1]||"",p=(/typeId=([^&]+)/.exec(c)||[])[1]||"",l.append(e("<span/>",{"class":"rte-button rte-button-enhancementSelect",html:e("<a/>",{href:CONTEXT_PATH+"/enhancementSelect?pt="+encodeURIComponent(d)+"&py="+encodeURIComponent(p),target:t(),text:"Select"})})),l.append(e("<span/>",{"class":"rte-button rte-button-enhancementEdit",html:e("<a/>",{href:CONTEXT_PATH+"/content/enhancement.jsp",target:t(),text:"Edit"})})),l.append(u("Remove","remove")),l.append(u("Restore","restore")),l.append(u("Remove Completely","removeCompletely")),a.append(e("<div/>",{"class":"rte-enhancement-label"})),a[0]},g=function(){var n=e("<div/>",{"class":"rte-enhancement rte-marker"}),a=e("<div/>",{"class":"rte-toolbar"});n.append(a);var o=m("Position");a.append(o),o.append(u("Move Up","moveUp")),o.append(u("Move Down","moveDown"));var r=m("Misc");a.append(r);var i,s,l;return i=e("form.contentForm").attr("action")||"",s=(/id=([^&]+)/.exec(i)||[])[1]||"",l=(/typeId=([^&]+)/.exec(i)||[])[1]||"",r.append(e("<span/>",{"class":"rte-button rte-button-selectMarker",html:e("<a/>",{href:CONTEXT_PATH+"/content/marker.jsp?pt="+encodeURIComponent(s)+"&py="+encodeURIComponent(l),target:t(),text:"Select"})})),r.append(u("Remove","remove")),r.append(u("Restore","restore")),r.append(u("Really Remove","removeCompletely")),n.append(e("<div/>",{"class":"rte-enhancement-label"})),n[0]},v=[];!function(){var t=0;c=function(n){var a=e.data(n,"rte-enhancement-id");return a||(++t,a="rte-enhancement-"+t,e.data(n,"rte-enhancement-id",a)),a}}();var b=wysihtml5.Editor.extend({constructor:function(t,n){function a(){var t,n;if(e(i.composer.element).hasClass("rte-changesTracking")){if(t=u.parent("ins"),t.length>0&&(n=t.prev("del"),n.length>0&&n.text()===u.text()))return t.after(u.html()),t.remove(),void n.remove();n=e("<del/>"),u.after(n),n.append(u),n.after(e("<ins/>",{html:u.html()}))}else u.after(u.html()),u.remove()}var i=this,s="true"===e(t).attr("data-first-draft"),c="true"===e(t).attr("data-final-draft"),m=this.container=r.createElement("div");m.className="rte-container",t.parentNode.insertBefore(m,t);var p=this.overlay=r.createElement("div");p.className="rte-overlay",p.style.position="relative",p.style.left="0px",p.style.top="0px",m.appendChild(p),function(){var e=i.focus;i.focus=function(){var t=o.scrollTop();e.apply(i,arguments),o.scrollTop(t)}}(),e(p).on("click",function(){i.focus()}),"function"==typeof n.toolbar&&(n.toolbar=n.toolbar(i,n.inline,s,c),m.appendChild(n.toolbar)),e(p).delegate("[data-action]","click",function(){var t,n,a,r=e(this),s=r.closest(".rte-enhancement"),l=s.data("$rte-placeholder"),c=s.find(".rte-button-editEnhancement a"),d=r.attr("data-action");if(0===d.indexOf("imageSize-")){var m=d.substring(10);t=e.parseJSON(l.attr("data-reference")||"{}"),m?(s.attr("data-image-size",m),t.imageSize=m):(s.removeAttr("data-image-size"),delete t.imageSize),n=JSON.stringify(t),l.attr("data-reference",n)}else if("remove"==d)s.addClass("state-removing"),l.addClass("state-removing");else if("restore"==d)s.removeClass("state-removing"),l.removeClass("state-removing");else if("removeCompletely"==d)s.remove(),l.remove();else if("moveCenter"===d||"moveLeft"===d||"moveRight"===d)l.removeAttr("data-alignment"),"moveCenter"===d?l.removeAttr("data-alignment"):"moveLeft"===d?l.attr("data-alignment","left"):"moveRight"===d&&l.attr("data-alignment","right"),t=e.parseJSON(l.attr("data-reference")||"{}"),"moveCenter"===d?delete t.alignment:"moveLeft"===d?t.alignment="left":"moveRight"===d&&(t.alignment="right"),n=JSON.stringify(t),l.attr("data-reference",n),c&&(a=c.attr("href"),a=(a+"&").replace(/([?&])reference=[^&]*[&]/,"$1"),a+="reference="+(n||""),c.attr("href",a));else{var p=l.offset().top;if("moveDown"===d)l.closest("body").find("br + br, div, h1, h2, h3, h4, h5, h6, p, button").each(function(){return l[0].compareDocumentPosition(this)&Node.DOCUMENT_POSITION_FOLLOWING?(e(this).after(l),!1):void 0}),o.scrollTop(o.scrollTop()+l.offset().top-p);else if("moveUp"===d){var f,u=[];l.closest("body").find("br + br, div, h1, h2, h3, h4, h5, h6, p, button").each(function(){l[0].compareDocumentPosition(this)&Node.DOCUMENT_POSITION_PRECEDING&&u.push(this)}),f=u.length,f>=2?e(u[f-2]).after(l):l.closest("body").prepend(l),o.scrollTop(o.scrollTop()+l.offset().top-p)}}return i.updateOverlay(),!1});var f=(e("<div/>",{"class":"rte-dialogs",css:{left:0,position:"relative",top:0}}),e('<div><h2>Link</h2><div class="rte-dialogLine"><input type="text" class="rte-dialogLinkHref"><input type="hidden" class="rte-dialogLinkId"><a class="rte-dialogLinkContent" target="linkById" href="'+CONTEXT_PATH+'/content/linkById.jsp?p=true">Content</a></div><div class="rte-dialogLine"><select class="rte-dialogLinkTarget"><option value="">Same Window</option><option value="_blank">New Window</option></select> <select class="rte-dialogLinkRel"><option value="">Relation</option><option value="nofollow">nofollow</option></select></div><a class="rte-dialogLinkSave">Save</a> <a class="rte-dialogLinkOpen" target="_blank">Open</a> <a class="rte-dialogLinkUnlink">Unlink</a></div>')),u=e();f.on("click",".rte-dialogLinkSave",function(){var e=f.find(".rte-dialogLinkId").val(),t=f.find(".rte-dialogLinkHref").val()||"",n=f.find(".rte-dialogLinkTarget").val(),a=f.find(".rte-dialogLinkRel").val();e?(u.attr("data-cms-id",e),u.attr("data-cms-href",t)):(u.removeAttr("data-cms-id"),u.removeAttr("data-cms-href")),u.attr("href",t),n?u.attr("target",n):u.removeAttr("target"),a?u.attr("rel",a):u.removeAttr("rel"),f.popup("close")}),f.on("keydown",".rte-dialogLinkHref",function(e){return 13===e.which?(f.find(".rte-dialogLinkSave").click(),!1):!0}),f.on("input",".rte-dialogLinkHref",function(t){f.find(".rte-dialogLinkOpen").attr("href",e(t.target).val())}),f.on("click",".rte-dialogLinkUnlink",function(){a(),f.popup("close")}),e(r.body).append(f),f.popup(),f.popup("close"),f.popup("container").bind("close",function(){u.attr("href")||a()});var h=function(t){var n,a,o,s,l=e(i.composer.iframe).offset(),c=f.find(".rte-dialogLinkHref"),d=t.offset();u=t,f.popup("open"),c.val(t.attr("href")||"http://"),f.find(".rte-dialogLinkId").val(t.attr("data-cms-id")||""),f.find(".rte-dialogLinkTarget").val(t.attr("target")||""),f.find(".rte-dialogLinkRel").val(t.attr("rel")||""),f.find(".rte-dialogLinkOpen").attr("href",c.val()),c.focus(),n=f.popup("container"),a=n.outerWidth(),o=d.left+(t.outerWidth()-a)/2,35>o?o=35:(s=o+a-e(r).width()+35,s>0&&(o-=s)),n.css({left:o,"margin-left":0,position:"absolute",top:l.top+t.offset().top+t.outerHeight()})};!function(){var t=0;e(n.toolbar).find(".rte-button-link").click(function(){var n,a,o,r;if(n=i.composer.selection,o=e(n.getSelectedNode()).closest("a"),o.length>0)return void h(o);if(!n.getRange().collapsed){if(++t,a="rte-link-temp-"+t,wysihtml5.commands.createLink.exec(i.composer,"createLink",{"class":a}),o=e("a."+a,i.composer.element),o.removeClass(a),e(i.composer.element).hasClass("rte-changesTracking")){if(o.parent("ins").length>0)return void h(o);o.before(e("<del/>",{html:o.html()})),r=e("<ins/>"),o.after(r),r.append(o)}return h(o),!1}})}(),m.appendChild(t),t.className+=" rte-textarea",v[v.length]=this,this.base(t,n);var g=function(){var t,n=i.composer.selection.getRange(),a=i.composer.selection.getSelectedNode();if(n.collapsed&&3==a.nodeType&&a.length==n.endOffset&&(t=e(a.nextSibling),t.is("code, del, ins")))return t;for(;!a.tagName;)a=a.parentNode;return e(a)};this.observe("show:dialog",function(t){var n=g(),a=n.offset(),o=e(t.dialogContainer);o.css({left:a.left,position:"absolute",top:a.top+n.outerHeight()+10})}),this.observe("load",function(){function t(t){t.find("del, ins").each(function(){var t=e(this);t.after(t.html()),t.remove()})}e(i.composer.element).on("cut",function(n){if(e(i.composer.element).hasClass("rte-changesTracking")){var a=c.selection.getRange(),o=e("<del/>");o.append(a.nativeRange.cloneContents()),t(o),setTimeout(function(){i.composer.selection.getRange().nativeRange.insertNode(o[0])},0)}});var n;e(i.composer.element).on("paste",function(t){e(i.composer.element).hasClass("rte-changesTracking")&&(n=c.selection.getRange().nativeRange)}),i.on("paste",function(){if(e(i.composer.element).hasClass("rte-changesTracking")&&n){var a=c.selection.getRange(),o=e("<ins/>");n.setEnd(a.endContainer,a.endOffset),o.append(n.extractContents()),t(o),c.selection.getRange().nativeRange.insertNode(o[0]),n=null}}),window.sessionStorage.getItem("bsp.rte.changesTracking."+e(i.textarea.element).closest(".inputContainer").attr("data-name"))&&(wysihtml5.commands.changesTrack.exec(i.composer),i.toolbar._updateLinkStates());var a,o=function(e,t,n,a){var r=e.childNodes;if(e.childNodes)for(var i=r.length,s=0;i>s;++s){var l=r[s];if(l&&l.tagName&&l.tagName===t&&wysihtml5.dom.hasClass(l,"enhancement")){for(var c=e.ownerDocument.createElement(n),d=l.attributes,m=d.length,p=0;m>p;++p){var f=d[p];c.setAttribute(f.name,f.value)}a&&a(c),e.insertBefore(c,l),e.removeChild(l)}else o(l,t,n,a)}},r=this.textarea;e(r.element).val()||e(r.element).val("<br>"),r._originalGetValue=r.getValue,r.getValue=function(e){var t,n=this._originalGetValue(e);return a===n?n.replace(l,""):(a=n,t=wysihtml5.dom.getAsDom(n,this.element.ownerDocument),o(t,"SPAN","BUTTON"),t.innerHTML.replace(l,""))};var s,c=this.composer;c._originalGetValue=c.getValue,c.getValue=function(e){var t=this._originalGetValue(e);return s===t?t:(s=t,dom=wysihtml5.dom.getAsDom(t,this.element.ownerDocument),o(dom,"BUTTON","SPAN",function(e){e.innerHTML="Enhancement"}),dom.innerHTML)},c.setValue(r.getValue()),c.iframe.style.overflow="hidden",c.iframe.contentDocument.body.style.overflow="hidden",c.iframe.contentDocument.body.className+=" rte-loaded",r.element.className+=" rte-source",this.on("focus",function(){e(r.element).parentsUntil("form").addClass("state-focus");for(var t=0,n=v.length;n>t;++t){var a=v[t];e(a.container).css("padding-top",0),e(a.config.toolbar).attr("style",a._toolbarOldStyle),e(a.overlay).css("top",0),a._toolbarOldStyle=null}e(this.overlay).css("top",e(this.config.toolbar).outerHeight()),d()}),this.on("focus",function(){e(r.element).trigger("rtefocus")}),this.on("blur",function(){e(r.element).trigger("rteblur")}),e(c.iframe.contentWindow).on("focus",function(){i.focus()}),this.on("blur",function(){e(r.element).parentsUntil("form").removeClass("state-focus"),e(r.element).trigger("change")}),e(c.element).on("click","a",function(){return!1}),e(c.element).on("dblclick","a",function(t){h(e(t.target).closest("a"))}),function(){function t(t){var n,a;return wysihtml5.commands.formatInline.state(c,null,t)||(++s,n="rte-wrap-temp-"+s,wysihtml5.commands.formatInline.exec(c,null,t,n,/foobar/g),a=e(t+"."+n,c.element),a.length>0&&a.removeClass(n)),a}function n(){var t,n=e(c.element);n.find("ins del").remove(),n.find("del ins").each(function(){var t=e(this),n=t.closest("del");n.after(t)}),n.find("del:has(del), ins:has(ins)").each(function(){var t=e(this);t.text(t.text())}),n.find("del, ins").each(function(){var t=e(this),n=t.text()[0];n&&65279!==n.charCodeAt(0)||t.remove()});do t=!1,n.find("del, ins").each(function(){var n,a,o,r=e(this);if(e.contains(c.element,r[0]))for(n=this.tagName,a=this;(a=a.nextSibling)&&1===a.nodeType&&a.tagName===n;)t=!0,o=e(a),r.append(o.html()),o.remove()});while(t)}var a,o,r=!1,i=-1,s=0;e(c.element).bind("keydown",function(s){function d(a){var o,r,i=p.getSelection();p.getRange().collapsed&&i.nativeSelection.modify("extend",a,"character"),t("del"),"forward"===a?(i.collapseToEnd(),o=p.getRange(),r=o.endContainer,r.nextSibling||r.nodeType!==Node.TEXT_NODE||o.endOffset!==r.data.length||(p.setAfter(e(r).closest("del")[0]),p.getSelection().nativeSelection.modify("move","backward","character"),p.getSelection().nativeSelection.modify("move","forward","character"))):(i.collapseToStart(),o=p.getRange(),r=o.startContainer,r.previousSibling||r.nodeType!==Node.TEXT_NODE||0!==o.startOffset||(p.setBefore(e(r).closest("del")[0]),p.getSelection().nativeSelection.modify("move","forward","character"),p.getSelection().nativeSelection.modify("move","backward","character"))),n()}var m,p,f,u,h,g,v,b,y,C,k;return s.metaKey?!0:(m=s.which,p=c.selection,f=e(p.getRange().commonAncestorContainer).closest(".rte-comment"),f.length>0?(13===m&&(u=c.doc.createTextNode(" "),f.after(u),p.setBefore(u)),!0):(h=8===m,g=46===m,(h||g)&&(v=p.getRange(),v.collapsed&&(b=v.startContainer,y=null,h?(C=e(b).closest("del, ins"),C.length>0&&0===v.startOffset?y=C[0].previousSibling:b.nodeType===Node.TEXT_NODE&&(0===v.startOffset||1===v.startOffset&&b.nodeValue.substring(0,1)===l)&&(y=b.previousSibling)):b.nodeType===Node.TEXT_NODE&&b.nodeValue.length===v.startOffset&&(y=b.nextSibling),y&&y.nodeType===Node.ELEMENT_NODE&&(f=e(y),f.hasClass("rte-comment"))))?(f.remove(),!1):e(c.element).hasClass("rte-changesTracking")?h?(d("backward"),!1):g?(d("forward"),!1):(r||(r=!0,a=p.getRange().cloneRange(),i=e(c.element).text().length,o=a.collapsed?null:a.cloneContents()),!0):(C=e(p.getSelectedNode()).closest("del, ins"),C.length>0&&(k=C[0].ownerDocument.createTextNode(l),C.after(k),p.setAfter(k)),!0)))}),e(c.element).bind("keyup",function(s){var l,d,m,p;!r||s.metaKey||!e(c.element).hasClass("rte-changesTracking")||e(c.selection.getRange().commonAncestorContainer).closest(".rte-comment").length>0||(e(c.element).text().length!==i&&(l=c.selection,d=l.getRange(),o&&d.collapsed&&(m=e("<del/>",c.iframe.contentDocument),m.append(o),d.insertNode(m[0])),l.executeAndRestore(function(){d.setStart(a.startContainer,a.startOffset),l.setSelection(d),p=t("ins")}),p&&(m=p.closest("del"),m.length>0&&(m.after(p),l.setAfter(p[0])))),r=!1,a=null,i=-1,o=null,n())})}(),setInterval(function(){i.updateOverlay()},100),setInterval(function(){e(i.composer.element).find(".rte-comment").each(function(){var t,n=e(this),a=this.nextSibling;a?a.nodeType===Node.TEXT_NODE&&(t=a.nodeValue,t.length>0&&t.substring(0,1)!==l&&n.after(l)):n.after(l)}),e(i.composer.element).find("a[href]").each(function(){for(var t,n=e(this),a=n.prop("href"),o=!1,r=n.text(),i=this.nextSibling;i&&(t=e(i),a===t.prop("href"));)o=!0,r+=t.text(),i=i.nextSibling,t.remove();o&&n.text(r)})},100)})},updateOverlay:function(){var t,n,a,o=this,r=o.textarea,i=o.currentView===r,s=e(o.overlay),l=o.composer,d=l.iframe,m=d.contentWindow;if(m&&e(i?r:d).is(":visible")){if(i)return void s.hide();t=e(r.element),n=t.val(),n&&""!==n&&"<br>"!==n.trim().toLowerCase()?e(l.element).removeAttr("data-placeholder"):e(l.element).attr("data-placeholder",t.attr("placeholder")),s.show(),a=e(m.document.body),e(d).css("min-height",Math.max(28,a.outerHeight(!0))),e(m).scrollTop(0),s.children().each(function(){e.data(this,"rte-visited",!1)}),a.find("button.enhancement").each(function(){var t,n,a,r,i,l=e(this),d=l.hasClass("marker"),m=c(this),p=e("#"+m),f=l.offset();0===p.length&&(p=e(o.config[d?"marker":"enhancement"](o)),p.attr("id",m),p.css("position","absolute"),e.data(p[0],"$rte-placeholder",l),s.append(p),p.find(".rte-button-enhancementSelect a").each(function(){var n=e(this),a=l.attr("data-id");n.attr("href",e.addQueryParameters(n.attr("href"),"id",a)),a?p.find(".rte-button-enhancementEdit a").each(function(){var t=e(this);t.closest(".rte-group").addClass("rte-group-enhancementSet"),t.attr("href",e.addQueryParameters(t.attr("href"),"id",a,"reference",l.attr("data-reference")))}):t=n})),e.data(p[0],"rte-visited",!0),n=p.find(".rte-enhancement-label"),i=e.parseJSON(l.attr("data-reference")||"{}"),a=i.label,r=i.preview,r?(n.find("figure img").attr("src")!==r&&n.html(e("<figure/>",{html:[e("<img/>",{src:r}),e("<figcaption/>")]})),n.find("figure img").attr("alt",a),n.find("figure figcaption").text(a)):(a||(a="Empty "+(d?"Marker":"Enhancement")),n.text(a)),p.css("height",""),l.height(p.height()),p.height(l.height()),p.width(l.width()),p.css({left:f.left,top:f.top}),t&&t.click()}),s.children().each(function(){e.data(this,"rte-visited")||e(this).remove()})}}});wysihtml5.commands.strike={exec:function(e,t){return wysihtml5.commands.formatInline.exec(e,t,"strike")},state:function(e,t){return wysihtml5.commands.formatInline.state(e,t,"strike")}};var y=/cms-textAlign-[0-9a-z\-]+/g;wysihtml5.commands.textAlign={exec:function(e,t,n){return wysihtml5.commands.formatBlock.exec(e,t,null,"cms-textAlign-"+n,y)},state:function(e,t,n){return wysihtml5.commands.formatBlock.state(e,t,null,"cms-textAlign-"+n,y)}},delete wysihtml5.commands.insertImage;var C=function(t,n){var a=t.selection,o=e(a.getSelectedNode());if(o.is("body"))e(o[0].childNodes[a.getRange().startOffset]).after(n);else{var r=a.getRange();if(r.collapsed){var i=o[0].childNodes[r.startOffset];i&&e(i).is("br")&&(a.getSelection().nativeSelection.modify("move","forward","character"),o=e(a.getSelectedNode()))}var s=[];o.closest("body").find("br + br, h1, h2, h3, h4, h5, h6, p, button").each(function(){o[0].compareDocumentPosition(this)&Node.DOCUMENT_POSITION_PRECEDING&&s.push(this)});var l=s.length;l>=1?e(s[l-1]).after(n):o.closest("body").prepend(n)}};wysihtml5.commands.link={exec:function(){},state:function(t){var n=t.selection;return!n.getRange().collapsed||e(n.getSelectedNode()).closest("a").length>0}},wysihtml5.commands.insertEnhancement={exec:function(e,t,n){var a=e.doc,o=a.createElement("BUTTON");if(n)for(var r in n)o.setAttribute(r,n[r]);o.setAttribute("class","enhancement"),C(e,o)},state:function(e){return!1}},wysihtml5.commands.insertMarker={exec:function(e,t,n){var a=e.doc,o=a.createElement("BUTTON");if(n)for(var r in n)o.setAttribute(r,n[r]);o.setAttribute("class","enhancement marker"),C(e,o)},state:function(e){return!1}},wysihtml5.commands.allComments={exec:function(t){e(t.element).toggleClass("rte-allComments")},state:function(t){return e(t.element).hasClass("rte-allComments")}},function(){function t(t,n,a){var o=t.selection,r=o.getRange();e(r.collapsed?e(r.commonAncestorContainer).closest(n):r.getNodes([Node.ELEMENT_NODE])).each(function(){e(this).is(n)&&a.call(this)})}function n(n,a){return{exec:function(o){t(o,"del, ins",function(){var t=e(this);t.is(n)?t.remove():t.is(a)&&(t.after(t.html()),t.remove())})},state:function(t){var n=t.selection.getRange();return!n.collapsed||e(n.commonAncestorContainer).closest("del, ins").length>0}}}e.extend(wysihtml5.commands,{changesTrack:{exec:function(t){e(t.element).toggleClass("rte-changesTracking")},state:function(t){return e(t.element).hasClass("rte-changesTracking")}},changesAccept:n("del","ins"),changesReject:n("ins","del"),changesPreview:{exec:function(t){e(t.element).toggleClass("rte-changesPreview")},state:function(t){return e(t.element).hasClass("rte-changesPreview")}},commentAdd:{exec:function(t){var n=t.selection,a=e(n.getRange().commonAncestorContainer).closest(".rte-comment");0===a.length&&wysihtml5.commands.formatInline.exec(t,null,"span","rte rte-comment")},state:function(t){var n=t.selection.getRange();return e(t.config.toolbar).toggleClass("rte-toolbarContainer-inComment",!n.collapsed||e(n.commonAncestorContainer).closest(".rte-comment").length>0),!1}},commentCollapse:{exec:function(n){t(n,".rte-comment",function(){var t=e(this),n=t.attr("data-comment");n?(t.text(n),t.removeAttr("data-comment")):(t.attr("data-comment",t.text()),t.text("…"))})},state:function(t){return!!e(t.selection.getRange().commonAncestorContainer).closest(".rte-comment").attr("data-comment")}},commentRemove:{exec:function(n){t(n,".rte-comment",function(){e(this).remove()})},state:function(t){return e(t.selection.getRange().commonAncestorContainer).closest(".rte-comment-removed").length>0}}})}(),wysihtml5.commands.fullscreen={exec:function(t){e(".toolBroadcast").toggle(),e(".toolHeader").toggle(),e(t.parent.container).toggleClass("rte-fullscreen"),e(t.element).toggleClass("rte-fullscreen"),e(r.body).toggleClass("rte-fullscreen")},state:function(t){return e(t.element).hasClass("rte-fullscreen")}};var k;!function(){e.ajax({url:CONTEXT_PATH+"/style/v3/rte-content.jsp",cache:!1,async:!1,success:function(e){k=e}})}();var w=e();e.plugin2("rte",{_defaultOptions:{enhancement:h,iframeHtml:k,marker:g,placeholder:"",style:!1,toolbar:f,useLineBreaks:!RTE_LEGACY_HTML,parserRules:RTE_LEGACY_HTML?{}:{tags:{font:{rename_tag:"span"},style:{remove:!0}}}},_create:function(t){var n=this.option();if(e.data(t,"rte-options",e.extend(!0,{},n)),n.initImmediately){var a,o=e(this);"true"===o.attr("data-inline")&&(n.inline=!0),a=new b(t,n),o.bind("input-disable",function(e,t){o.closest(".rte-container").toggleClass("state-disabled",t),a[t?"disable":"enable"]()}),o.parent().trigger("create")}else w=w.add(e(t))},enable:function(){var t=this.$caller[0];return t&&e.each(v,function(){var n=this.textareaElement;n&&e.contains(t,n)&&this.enable()}),this},enhancement:function(t){var a=this.$caller.closest(".rte-enhancement"),o=a.data("$rte-placeholder");o&&e.each(t,function(e,t){var a="data-"+e;null===t||t===n?o.removeAttr(a):o.attr(a,t)});var r=e.parseJSON(t.reference||"{}"),i=r.label;return i&&a.find(".rte-enhancement-label").text(i),this},wysihtml5:function(){var t,n=this.$caller[0];return e.each(v,function(){return n===this.textareaElement||n===this.composer.iframe||n.ownerDocument===this.composer.element.ownerDocument?void(t=this):void 0}),t}}),setInterval(function(){w.each(function(){var t,n=e(this),a=e.data(this,"rte-options");n.is(":visible")&&(w=w.not(n),"true"===n.attr("data-inline")&&(a.inline=!0),t=new b(this,a),n.bind("input-disable",function(e,a){n.closest(".rte-container").toggleClass("state-disabled",a),t[a?"disable":"enable"]()}),n.parent().trigger("create"))})},100),o.bind("resize.rte scroll.rte",d=e.throttle(150,function(){var t=e(".toolHeader"),n=t.offset().top+t.outerHeight()-("fixed"===t.css("position")?o.scrollTop():0),a=o.scrollTop()+n,r=window.requestAnimationFrame;e.each(v,function(){var t,o,i,s,l,c,d=e(this.container);d.is(":visible")&&(t=e(this.overlay),o=e(this.config.toolbar),i=d.offset().top,s=o.outerHeight(),i>a?r(function(){d.css("padding-top",0),t.css("top",s),o.attr("style",this._toolbarOldStyle),this._toolbarOldStyle=null}):(this._toolbarOldStyle=this._toolbarOldStyle||o.attr("style")||" ",r(function(){d.css("padding-top",s),t.css("top",0)}),a<i+d.height()?(l=o.offset().left,c=o.width(),r(function(){o.css({left:l,position:"fixed",top:n,width:c})})):r(function(){o.css({top:-1e4,position:"fixed"})})))})})),i.on("click","[data-enhancement]",function(t){var n=e(this),a=n.popup("source"),o=a.closest(".rte-group"),r=o.find(".rte-button-enhancementEdit a"),i=n.attr("data-enhancement"),s=e.parseJSON(i);o.addClass("rte-group-enhancementSet"),a.text("Change"),a.rte("enhancement",{id:s.record._ref,label:s.label,preview:s.preview,reference:i}),r.length>0&&r.attr("href",e.addQueryParameters(r.attr("href"),"id",s.record._ref)),n.popup("close"),t.preventDefault(),t.stopImmediatePropagation()}),i.on("close",'.popup[name ^= "contentEnhancement-"]',function(){var t,n,a=e(this).popup("source").closest(".rte-group");a.hasClass("rte-group-enhancementSet")||(t=a.closest(".rte-enhancement"),n=t.data("$rte-placeholder"),t.remove(),n&&n.remove())}),i.on("submit","form",function(){for(var t,n=e(this),a=window.sessionStorage,o=0,r=a.length;r>o;++o)t=a.key(o),0===t.indexOf("bsp.rte.changesTracking.")&&a.removeItem(t);n.find(".wysihtml5-sandbox").each(function(){e(this.contentDocument.body).hasClass("rte-changesTracking")&&a.setItem("bsp.rte.changesTracking."+e(this).closest(".inputContainer").attr("data-name"),"1")})})});