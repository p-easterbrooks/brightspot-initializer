define(["jquery","v3/rtc"],function(t,e){e.receive("com.psddev.cms.tool.page.content.EditFieldUpdateBroadcast",function(n){var a=n.userId,i=n.userName,o=n.fieldNamesByObjectId;if(t('.inputPending[data-user-id="'+a+'"]').each(function(){var e=t(this);e.closest(".inputContainer").removeClass("inputContainer-pending"),e.remove()}),o){var d=n.contentId;t.each(o,function(n,c){var r=t('form[data-rtc-content-id="'+d+'"] .objectInputs[data-id="'+n+'"]');0!==r.length&&t.each(c,function(n,d){var c=r.find('> .inputContainer[data-field-name="'+d+'"]'),u=!1;c.find(".objectInputs").each(function(){return o[t(this).attr("data-id")]?(u=!0,!1):void 0}),u||(c.addClass("inputContainer-pending"),c.find("> .inputLabel").after(t("<div/>",{"class":"inputPending","data-user-id":a,html:["Pending edit from "+i+" - ",t("<a/>",{text:"Unlock",click:function(){return confirm("Are you sure you want to forcefully unlock this field?")&&e.execute("com.psddev.cms.tool.page.content.EditFieldUpdateAction",{contentId:c.closest("form").attr("data-rtc-content-id"),unlockObjectId:c.closest(".objectInputs").attr("data-id"),unlockFieldName:c.attr("data-field-name")}),!1}})]})))})})}}),e.receive("com.psddev.cms.tool.page.content.PublishBroadcast",function(e){function n(){var e=t(this);e.closest(".inputContainer").removeClass("inputContainer-updated"),e.remove()}function a(i,o,d){t.each(o,function(o,s){var l=s?s._id:null,f=d[o];if(l)a(l,s,f);else if(JSON.stringify(s)!==JSON.stringify(f)){var p=t('[data-rtc-content-id="'+c+'"] .objectInputs[data-id="'+i+'"] > .inputContainer[data-field-name="'+o+'"]'),m=p.closest("form");m.length>0&&!t.data(m[0],"content-edit-submit")&&(p.addClass("inputContainer-updated"),p.find("> .inputLabel").after(t("<div/>",{"class":"inputUpdated","data-user-id":r,html:["Updated by "+u+" at "+new Date(e.date)+" - ",t("<a/>",{text:"Ignore",click:function(){return confirm("Are you sure you want to ignore updates to this field and edit it anyway?")&&t(this).closest(".inputUpdated").each(n),!1}})]})))}})}var i=e.values,o=i._id,d=t('input[name="'+o+'/oldValues"]').val();if(d){var c=e.contentId,r=e.userId,u=e.userName;t('.inputUpdated[data-user-id="'+r+'"]').each(n),a(o,t.parseJSON(d),i)}}),t(".contentForm").each(function(){function n(){var n={};a.find(".inputContainer.state-changed, .inputContainer.state-focus").each(function(){var e=t(this),a=e.closest(".objectInputs").attr("data-id");(n[a]=n[a]||[]).push(e.attr("data-field-name"))}),n&&e.execute("com.psddev.cms.tool.page.content.EditFieldUpdateAction",{contentId:i,fieldNamesByObjectId:n})}var a=t(this),i=a.attr("data-rtc-content-id");e.restore("com.psddev.cms.tool.page.content.EditFieldUpdateState",{contentId:i},n);var o;t(document).on("blur focus change",".contentForm :input",function(){o&&clearTimeout(o),o=setTimeout(function(){o=null,n()},50)}),a.on("submit",function(){t.data(a[0],"content-edit-submit",!0)}),t(document).on("keydown",".contentForm :text, .contentForm textarea",function(e){if(9===e.which){var n=t(this).closest(".inputContainer"),a=n.next(".inputContainer").find("> .inputSmall > .rte2-wrapper").data("rte2");if(a)return a.rte.focus(),!1}return!0})})});