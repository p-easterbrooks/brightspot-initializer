define(["jquery","bsp-utils","diff"],function(e,t,n){t.onDomInsert(document,".contentDiff",{insert:function(t){function i(e){return e.find(":input, select, textarea").serialize().replace(new RegExp("(^|&)[^%]+%2F","g"),"$1%2F")}var a,d,f,s=e(t),c=s.find("> .contentDiffLeft"),o=s.find("> .contentDiffRight");a=e("<ul/>",{"class":"tabs"}),d=e("<li/>",{html:e("<a/>",{text:"Edit",click:function(){return s.trigger("contentDiff-edit"),!1}})}),f=e("<li/>",{html:e("<a/>",{text:"Side By Side",click:function(){return s.trigger("contentDiff-sideBySide"),!1}})}),s.bind("contentDiff-edit",function(){s.removeClass("contentDiff-sideBySide").addClass("contentDiff-edit"),a.find("li").removeClass("state-selected"),d.addClass("state-selected");var e=c.add(o);e.find(".inputContainer").css("height","")}),s.bind("contentDiff-sideBySide",function(){s.removeClass("contentDiff-edit").addClass("contentDiff-sideBySide"),a.find("li").removeClass("state-selected"),f.addClass("state-selected"),s.resize()});var r=e.throttle(100,function(){s.find(".contentDiffLeft .inputContainer").each(function(){var t=e(this),n=s.find('.contentDiffRight .inputContainer[data-name="'+t.attr("data-name")+'"]'),i=t.add(n);i.css("height",""),i.css("height",Math.max(t.height(),n.height()))})});s.bind("resize",r),setInterval(r,500),c.find("> .objectInputs > .inputContainer").each(function(){var t=e(this),n=o.find('> .objectInputs > .inputContainer[data-field="'+t.attr("data-field")+'"]');i(t)===i(n)&&(t.addClass("contentDiffSame"),n.addClass("contentDiffSame"))}),c.find("> .objectInputs > .inputContainer > .inputSmall > textarea").each(function(){var t=e(this),i=o.find('> .objectInputs > .inputContainer[data-field="'+t.closest(".inputContainer").attr("data-field")+'"] textarea'),a=t.val().replace(new RegExp("[\\r\\n]","g")," ").replace(new RegExp("<br[^>]*/?>","ig"),"\n"),d=i.val().replace(new RegExp("[\\r\\n]","g")," ").replace(new RegExp("<br[^>]*/?>","ig"),"\n"),f=n.diffWords(a,d),s=e("<div/>",{"class":"contentDiffCopy"}),c=e("<div/>",{"class":"contentDiffCopy"});e.each(f,function(t,n){n.added||s.append(n.removed?e("<span/>",{"class":"contentDiffRemoved",text:n.value}):e("<span/>",{text:n.value}))}),e.each(f,function(t,n){n.removed||c.append(n.added?e("<span/>",{"class":"contentDiffAdded",text:n.value}):e("<span/>",{text:n.value}))}),t.addClass("contentDiffText"),t.before(s),i.addClass("contentDiffText"),i.before(c)}),a.append(d),a.append(f),s.prepend(a),s.trigger(o.is(".contentDiffCurrent")?"contentDiff-sideBySide":"contentDiff-edit"),s.closest("form").submit(function(){c.is(".contentDiffCurrent")?c.find(":input").prop("disabled",!0):o.find(":input").prop("disabled",!0)})}})});