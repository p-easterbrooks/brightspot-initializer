define(["jquery","bsp-utils"],function(t,e){var n=t(window);e.onDomInsert(document,".widget-publishing",{insert:function(e){var n,i=t(e),s=i.find(".dateInput"),a=i.find('select[name="newSchedule"]'),o=i.find('[name="action-publish"]'),c=o.text(),d=s.val();0===s.length?(o.addClass("schedule"),o.text("Schedule")):(n=function(){s.val()?(o.addClass("schedule"),o.text(d&&!a.val()?"Reschedule":"Schedule")):(o.removeClass("schedule"),o.text(c))},n(),s.change(n),a.change(n));var l=i.find('button[name="action-draft"]');if(l.length>0&&(t(document).on("keydown",function(t){83===t.which&&(t.ctrlKey||t.metaKey)&&(l.click(),t.preventDefault(),t.stopPropagation())}),l.closest(".message").length>0)){var r,u=!1;l.click(function(e){if(u)return e.preventDefault(),void e.stopPropagation();u=!0;var n="saveDraft",i=l.closest("form"),s=t("<iframe/>",{name:n,css:{display:"none"}}),a=t(".toolMessage");0===a.length&&(a=t("<div/>",{"class":"toolMessage"}),t(document.body).append(a)),a.html(t("<div/>",{"class":"message message-info",text:"Saving..."})),r&&clearTimeout(r),a.fadeIn("fast"),t(document.body).append(s),i.attr("target",n),s.load(function(){var e=t(".contentForm-main > .widget-content > .message",this.contentDocument);e.length>0?a.html(e.clone()):a.html(t("<div/>",{"class":"message message-error",text:"Save failed with an unknown error!"})),r=setTimeout(function(){r=null,a.fadeOut("fast")},5e3),u=!1,i.find("input, textarea").each(function(){var e=t(this);e.prop("defaultValue",e.val())}),i.find("option").each(function(){var e=t(this);e.prop("defaultSelected",e.prop("selected"))}),i.find(".state-changed").removeClass("state-changed"),i.find(".toBeRemoved").remove(),i.removeAttr("target"),s.remove(),t.removeData(i[0],"bsp-publish-submitting")})})}}}),e.onDomInsert(document,".widget-publishing",{insert:function(e){var i,s,a,o=t(e),c=o.find(".widget-publishingWorkflow"),d=o.find(".widget-publishingPublish");0!==c.length&&0!==d.length&&(i=t("<ul/>",{"class":"tabs"}),s=t("<li/>",{html:t("<a/>",{text:"Workflow",click:function(){return c.show(),s.addClass("state-selected"),d.hide(),a.removeClass("state-selected"),n.resize(),!1}})}),a=t("<li/>",{html:t("<a/>",{text:"Publish",click:function(){return c.hide(),s.removeClass("state-selected"),d.show(),a.addClass("state-selected"),n.resize(),!1}})}),i.append(s),i.append(a),c.before(i),s.find("a").click())}}),function(){var e="bsp-publish-submitting";t(document).on("submit",".contentForm",function(n){t.data(t(n.target)[0],e,!0)}),t(document).on("click",".widget-publishing button, .widget-publishing :submit",function(n){return!t.data(t(n.target).closest(".contentForm")[0],e)})}(),function(){function i(){a=t(".toolHeader").outerHeight(!0),t(".contentForm-aside").each(function(){var e=this,i=t(e);if(!(i.closest('.popup[data-popup-source-class="objectId-select"]').length>0)){var s=i.find("> .widget-publishing");t.data(s[0],o,s.outerHeight()<.4*n.height());var a=i.css("top");i.css("top",""),t.data(e,c,i.offset()),i.css("top",a);var r=i.width(),u=i.find(".widget-publishing"),p=u[0];t.data(p,d,u.outerHeight(!0)),t.data(p,l,"border-box"===u.css("box-sizing")?r:r-(u.outerWidth()-u.width()))}})}function s(){var e=n.scrollTop();t(".contentForm-aside").each(function(){var n=this,i=t(n);if(!(i.closest('.popup[data-popup-source-class="objectId-select"]').length>0)){var s=t.data(n,c),r=i.find("> .contentWidgets"),u=i.find("> .widget-publishing"),p=u[0];if(t.data(p,o)&&s.top-e<=a){r.css({"padding-top":t.data(p,d)}),u.css({left:s.left,position:"fixed",top:a,width:t.data(p,l),"z-index":1});var h=i.closest(".popup").length>0?parseInt(i.css("top"),10)||0:0,f=e-s.top-h+a+20+"px",g="inset("+f+" 0 0 0)";r.css({"-webkit-clip-path":g,"clip-path":g})}else r.css({"-webkit-clip-path":"","clip-path":"","padding-top":""}),u.css({left:"",position:"",top:"",width:"","z-index":""})}})}var a,o="cp-fixed",c="cp-offset",d="cp-height",l="cp-width";i(),s(),n.resize(e.throttle(50,function(){i(),s()})),n.scroll(s)}()});