define(["jquery","bsp-utils"],function(t,a){a.onDomInsert(document,".message",{insert:function(a){var e=t(a);""===e.text()&&e.find("[data-dynamic-html], [data-dynamic-text]").length>0&&e.hide()}}),a.onDomInsert(document,".contentForm, .enhancementForm, .standardForm",{insert:function(a){function e(){if(c.find(".repeatableForm:not(.plugin-repeatable),.repeatableInputs:not(.plugin-repeatable),.repeatableLayout:not(.plugin-repeatable),.repeatableObjectId:not(.plugin-repeatable),.repeatableText:not(.plugin-repeatable)").length>0)return void setTimeout(e,100);if(n)return void(d=!0);n=!0;var a=c.attr("action"),i=a.indexOf("?"),o=(+new Date+1e3,c.find('[data-dynamic-text][data-dynamic-text != ""],[data-dynamic-html][data-dynamic-html != ""],[data-dynamic-placeholder][data-dynamic-placeholder != ""],[data-dynamic-predicate][data-dynamic-predicate != ""]'));o=o.filter(function(){return 0===t(this).closest(".collapsed").length}),r||c.find('[data-dynamic-predicate][data-dynamic-predicate != ""]').each(function(){t(this).removeClass("state-loaded")}),t.ajax({type:"post",url:CONTEXT_PATH+"contentState?idle="+!!r+(i>-1?"&"+a.substring(i+1):""),cache:!1,dataType:"json",data:c.serialize()+o.map(function(){var a=t(this);return"&_dti="+(a.closest("[data-object-id]").attr("data-object-id")||"")+"&_dtt="+(a.attr("data-dynamic-text")||a.attr("data-dynamic-html")||a.attr("data-dynamic-placeholder")||"")+"&_dtf="+(a.attr("data-dynamic-field-name")||"")+"&_dtq="+(a.attr("data-dynamic-predicate")||"")}).get().join(""),success:function(a){c.trigger("cms-updateContentState",[a]),o.each(function(e){var n=t(this),d=a._dynamicTexts[e],i=a._dynamicPredicates[e];n.is("[data-dynamic-predicate]")&&(n.attr("data-additional-query",i),n.trigger("refresh.objectId"),n.addClass("state-loaded")),null!==d&&""!==d&&(n.closest(".message").toggle(""!==d),n.is("[data-dynamic-text]")?n.text(d):n.is("[data-dynamic-html]")?n.html(d):n.is("[data-dynamic-placeholder]")&&n.prop("placeholder",d))}),c.resize()},complete:function(){d?setTimeout(function(){n=!1,d=!1,r=!1,e()},1e3):(n=!1,r=!1)}})}var n,d,i,c=t(a),r=!0;c.bind("create change input",function(){e(),clearTimeout(i),i=setTimeout(function(){r=!0,e()},5e3)}),e()}})});