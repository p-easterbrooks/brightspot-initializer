!function(e,t,i){var a=e(t),o=0,n={addButtonText:"Add",removeButtonText:"Remove",restoreButtonText:"Restore",sortableOptions:{delay:300}};require(["v3/input/carousel"],function(t){e.plugin2("repeatable",{_defaultOptions:n,_create:function(t){var a,o=this,n=e(t),r=o.option();a=Object.create(i),a.init(n,r)},add:function(e){var t=this,i=t.$caller;return i.closest(".addButton").trigger("click",[e]),i}});var i={defaults:n,templateEdit:'<div class="carousel-target"><div class="carousel-target-nav carousel-target-prev"><a href="#">Previous</a></div><div class="carousel-target-items"></div><div class="carousel-target-nav carousel-target-next"><a href="#">Next</a></div></div>',init:function(t,i){var a=this;a.$element=e(t).first(),a.dom={},a.options=e.extend(!0,{},a.defaults,i),a.initDOM(),a.initInputDisable(),a.initSortable(),a.initMode(),a.modePreviewInit(),a.dom.$list.find("> li").each(function(){a.initItem(this)}),a.modePreviewUpdateCarousel(),a.initAddButton()},initDOM:function(){var t,i=this,a=e();t=i.$element.find("> ul, > ol").first(),i.dom.$list=t,t.find('> li.template, > script[type="text/template"]').each(function(){var t=e(this);a=t.is("li.template")?a.add(t):a.add(e(t.text())),t.remove()}),i.dom.$templates=a},initInputDisable:function(){var t=this;t.$element.addClass("event-input-disable"),t.$element.bind("input-disable",function(t,i){e(t.target).closest(".inputContainer").toggleClass("state-disabled",i)})},initSortable:function(){var e=this;e.dom.$list.is("ol")&&e.dom.$list.sortable(e.options.sortableOptions)},initMode:function(){var e,t=this;return t.mode="form",t.$element.hasClass("repeatableObjectId")&&(t.mode="object"),e=t.dom.$templates.find(":input").not(':input[name$=".toggle"]'),t.options.addButtonText||1!==t.dom.$templates.length||1!==e.length?t.$element.hasClass("repeatableForm-previewable")?void(t.mode="preview"):void 0:void(t.mode="single")},initAddButton:function(){var t,i=this;t=i.$element.find(".addButtonContainer"),t.length||(t=e("<div/>",{"class":"addButtonContainer"}).appendTo(i.$element)),i.dom.$addButtonContainer=t,i.modeSingleInitAddButton();i.dom.$templates.each(function(){var a,o=e(this),n=o.attr("data-type")||"Item";a=n,i.options.addButtonText&&(a=i.options.addButtonText+" "+a),e("<span/>",{"class":"addButton",text:a}).on("click",function(e,t){return i.addItem(o,t),!1}).appendTo(t)})},initItem:function(t){var i=this,a=e(t);i.modePreviewInitItem(a),i.initItemLabel(a),0!==a.find(".message-error").length||0!==a.find("> .layouts").length||i.modeIsPreview()||i.modeIsObject()||i.itemCollapse(a),a.find(':input[name$=".toggle"]').hide(),i.initItemRemove(a)},initItemLabel:function(t){var i,a,o,n=this,r=e(t),d=r.attr("data-type"),l=r.attr("data-label");d&&(n.modeIsPreview()||(o=d,l&&(o+=": "+l),i=e("<div/>",{"class":"repeatableLabel",text:o,"data-object-id":r.find('> input[type="hidden"][name$=".id"]').val(),"data-dynamic-text":"${content.state.getType().label}: ${content.label}"}).on("click",function(){n.itemToggle(r)}),a=r.find(" > .repeatableLabel"),a.length&&(a.removeClass("repeatableLabel").appendTo(i),i.find(":input").click(function(e){e.stopPropagation()})),r.prepend(i)))},initItemRemove:function(t){var i=this,a=e(t);e("<span/>",{"class":"removeButton",text:i.options.removeButtonText}).on("click",function(){i.removeItemToggle(a)}).appendTo(a)},addItem:function(t,i){var n,r,d,l,s=this,c=e(t);return s.modeIsSingle()&&!s.dom.$singleInput.val()?!1:(s.$element.find(".objectId-placeholder").hide(),n=c.clone(),n.removeClass("template"),n.find(':input[name$=".toggle"]').attr("checked","checked"),d=n.find("a").attr("href"),l=n.find(":input"),d&&0===l.length?(++o,r=e.ajax({cache:!1,url:d,data:{_nonce:o}}).always(function(e){var t="string"==typeof e?e:e.responseText;n.html(t)})):r=e.Deferred().resolve().promise(),r.always(function(){s.dom.$list.append(n),i&&i.call(n[0]),s.initItem(n),s.itemUncollapse(n),s.modeIsSingle()&&(n.find(':input:not([name$=".toggle"])').val(s.dom.$singleInput.val()),s.dom.$singleInput.val("")),n.find("*[id]").attr("id",function(e,t){var i;return s.idIndex+=1,i=t+"r"+s.idIndex,n.find("*[for="+t+"]").attr("for",i),n.find("*[data-show=#"+t+"]").attr("data-show","#"+i),i}),n.trigger("create"),s.modePreviewAddItem(n),n.trigger("change"),a.resize()}),r)},modeIsObject:function(){var e=this;return"object"===e.mode},modeIsForm:function(){var e=this;return"form"===e.mode},modeIsSingle:function(){var e=this;return"single"===e.mode},modeIsPreview:function(){var e=this;return"preview"===e.mode},itemToggle:function(t,i){var a=this,o=e(t);o.toggleClass("collapsed",i),a.modeIsPreview()||a.itemIsCollapsed(o)||a.itemLoad(o).always(function(){o.resize(),o.find(":input:first").change()})},itemCollapse:function(e){var t=this;t.itemToggle(e,!0)},itemUncollapse:function(e){var t=this;t.itemToggle(e,!1)},itemIsCollapsed:function(t){var i=e(t);return i.hasClass("collapsed")},itemLoad:function(t,i){var a,o,n,r=this,d=e(t),l=i?e(i):d,s=e.Deferred().resolve().promise();return a=d.find("> input[data-form-fields-url]"),a.length>0&&(o=a.attr("data-form-fields-url"),n=a.val(),a.removeAttr("data-form-fields-url"),a.val(""),s=e.ajax({type:"POST",cache:!1,url:o,data:{data:n}}).always(function(t){var i="string"==typeof t?t:t.responseText;e(i).appendTo(l),r.itemIsRemoved(d)&&r.removeItem(d),l.trigger("create"),l.trigger("load")})),s},removeItemToggle:function(t,i){var a,o=this,n=e(t),r=n.find(".removeButton"),d=n.index()+1,l=o.carousel,s=e();s=s.add(n),l&&(s=s.add(l.getTileContent(d)),s=s.add(n.data("editContainer"))),a=s.find(":input"),void 0===i&&(i=!n.is(".toBeRemoved")),i?(s.addClass("toBeRemoved"),a.attr("disabled","disabled"),o.options.restoreButtonText&&r.text(o.options.restoreButtonText)):(s.removeClass("toBeRemoved"),a.removeAttr("disabled"),o.options.removeButtonText&&r.text(o.options.removeButtonText)),n.change()},removeItem:function(e){var t=this;t.removeItemToggle(e,!0)},restoreItem:function(e){var t=this;t.removeItemToggle(e,!1)},itemIsRemoved:function(t){return e(t).hasClass("toBeRemoved")},modeSingleInitAddButton:function(){var t,i,a,o=this,n=o.dom.$addButtonContainer;o.modeIsSingle()&&(i=o.dom.$templates.find(':input[name$=".toggle"]'),t=o.dom.$templates.find(":input").not(i),a=t.clone(),a.removeAttr("id"),a.keydown(function(e){return 13==e.which?(n.find(".addButton").trigger("click"),!1):void 0}),e("<input/>",{name:i.attr("name"),type:"hidden",value:i.attr("value")}).appendTo(n),a.appendTo(n),o.dom.$singleInput=a)},modePreviewInit:function(){var i,a,o,n,r,d,l,s=this,c=s.$element;s.modeIsPreview()&&(l=e("<div/>",{"class":"repeatablePreviewControls"}).prependTo(c),c.find("> .action-upload").appendTo(l),e("<span/>",{"class":"addButtonContainer"}).appendTo(l),d=e('<span class="view-switcher"><a href="#" class="view-switcher-active view-switcher-grid">Grid</a> | <a href="#" class="view-switcher-gallery">Gallery</a></span>').appendTo(l),s.dom.$viewSwitcher=d,a=s.dom.$list,s.dom.$viewGrid=a,o=e("<div/>",{"class":"viewCarousel"}).insertAfter(s.dom.$list).hide(),s.dom.$viewCarousel=o,r=e("<div/>",{"class":"carousel-container"}).appendTo(o),n=e(s.templateEdit).appendTo(o).hide(),s.dom.$carouselTarget=n,s.dom.$carouselTargetItems=n.find(".carousel-target-items"),s.dom.$carouselTargetPrev=n.find(".carousel-target-prev").on("click",function(e){e.preventDefault(),s.modePreviewEditNext(-1)}),s.dom.$carouselTargetNext=n.find(".carousel-target-next").on("click",function(e){e.preventDefault(),s.modePreviewEditNext()}),i=Object.create(t),i.init(r,{numbered:!0}),s.carousel=i,r.on("carousel.tile",function(t,i){var a;a=e(i.tile).data("item"),a&&s.modePreviewEdit(a,!1)}),d.on("click",".view-switcher-grid",function(e){return s.modePreviewShowGrid(),!1}),d.on("click",".view-switcher-gallery",function(e){return s.modePreviewShowCarousel(),!1}),s.dom.$list.on("sortable.end",function(t,i){var a,o=e(i),n=o.index()+1,r=o.data("carouselTile");r&&(a=s.carousel.getTileIndex(r)||0,s.carousel.repositionTile(a,n))}))},modePreviewInitItem:function(t){var i,a,o,n,r=this,d=e(t),l=d.find('> input[type="hidden"][name$=".id"]').val(),s=d.attr("data-type")||"Title",c=d.attr("data-label")||"[Empty Title]";r.modeIsPreview()&&(i=d.attr("data-preview")||"",e("<img/>",{"class":"previewable-image",src:i,alt:""}).on("click",function(){return r.modePreviewEdit(d),!1}).appendTo(d),a=e("<div/>",{"class":"previewable-label",html:e("<span/>",{"class":"previewable-label-prefix",text:s+": "})}).appendTo(d),e("<a/>",{href:"#",text:c,"data-object-id":l,"data-dynamic-text":"${content.label}"}).on("click",function(){return r.modePreviewEdit(d),!1}).appendTo(a),o=e("<div/>",{"class":"previewable-controls"}).appendTo(d),e("<span/>",{"class":"previewable-control-edit",text:""}).on("click",function(e){return r.modePreviewEdit(d),!1}).appendTo(o),r.modePreviewInitItemCarousel(d),n=r.modePreviewCreateEditContainer(d),d.find(".objectInputs").appendTo(n),n.find(".message-error").length&&(r.modePreviewMarkError(d),r.modePreviewEdit(d)))},modePreviewInitItemCarousel:function(t){var i,a=this,o=e(t),n=a.carousel,r=o.attr("data-preview"),d=o.attr("data-label");n&&(i=e("<figure/>"),e("<img/>",{"class":"carousel-tile-content-image",src:r||"",alt:""}).appendTo(i),e("<figcaption/>",{text:d||"[Empty Tile]","data-object-id":o.find('> input[type="hidden"][name$=".id"]').val(),"data-dynamic-text":"${content.label}"}).appendTo(i),e("<span/>",{"class":"removeButton",text:a.options.removeButtonText}).on("click",function(){a.removeItemToggle(o)}).appendTo(i),o.data("carouselTile",i),i.data("item",o),a.carousel.addTile(i))},modePreviewAddItem:function(t){var i,a=this,o=e(t);a.modeIsPreview()&&(i=a.modePreviewCreateEditContainer(o),o.find("> .objectInputs").appendTo(i),i.trigger("create"),i.find(":input").trigger("change"),a.carousel.update(),a.modePreviewEdit(o))},modePreviewEdit:function(t,i){var a,o=this,n=e(t);o.modeIsPreview()&&(o.dom.$carouselTarget.show(),a=o.modePreviewCreateEditContainer(n),o.itemLoad(n,a).always(function(){var t,r,d;o.modePreviewShowCarousel(),o.carousel.setActive(n.index()+1),i!==!1&&(o.carousel.goToActiveTile(),t=o.$element.closest(".inputContainer").offset(),d=t.top,r=e(".toolHeader").height(),r&&(d=d-r-6),d<e(window).scrollTop()&&window.scrollTo(0,d)),o.dom.$carouselTarget.find(".itemEdit").hide(),o.modePreviewUpdateEditContainer(),a.show()}))},modePreviewEditNext:function(e){var t,i=this;e=e&&0>e?-1:1,t=i.carousel.getActive()+e,1>t||t>i.dom.$list.find("> li").length||(i.carousel.setActive(t),i.carousel.goToActiveTile(),i.carousel.doTile(t),i.modePreviewUpdateEditContainer())},modePreviewCreateEditContainer:function(t){var i,a=this,o=e(t),n=o.find('> input[type="hidden"][name$=".id"]').val();return i=o.data("editContainer"),i||(i=e("<div/>",{"class":"itemEdit"}).on("change",function(t){var i,r,d,l;setTimeout(function(){a.modePreviewMarkAsChanged(o)},1),r=e(t.target).closest("[data-preview]"),i=r.attr("data-preview"),d=r.attr("name"),l=o.attr("data-preview-field")||"",l=l.replace(/(.*)\/.*/,"$1"),l=n+"/"+l,i&&d===l&&a.modePreviewSetThumbnail(o,i)}).appendTo(a.dom.$carouselTargetItems),o.data("editContainer",i)),i},modePreviewUpdateEditContainer:function(){var e=this,t=e.carousel.getActive(),i=e.dom.$list.find("> li").length;e.dom.$carouselTargetPrev.toggleClass("carousel-target-nav-hide",!Boolean(t>1)),e.dom.$carouselTargetNext.toggleClass("carousel-target-nav-hide",!Boolean(i>t))},modePreviewShowGrid:function(){var e=this;e.modeIsPreview()&&(e.dom.$viewSwitcher.find("a").removeClass("view-switcher-active").filter(".view-switcher-grid").addClass("view-switcher-active"),e.dom.$viewGrid.show(),e.dom.$viewCarousel.hide())},modePreviewShowCarousel:function(){var e=this;e.modeIsPreview()&&(e.dom.$viewSwitcher.find("a").removeClass("view-switcher-active").filter(".view-switcher-gallery").addClass("view-switcher-active"),e.dom.$viewGrid.hide(),e.dom.$viewCarousel.show(),e.carousel.update(),e.modePreviewUpdateEditContainer(),e.carousel.goToActiveTile())},modePreviewUpdateCarousel:function(){var e=this;e.carousel&&e.carousel.update()},modePreviewSetThumbnail:function(t,i){var a=e(t),o=a.find(".previewable-image"),n=e(t).data("carouselTile");n&&(o=o.add(n.find(".carousel-tile-content-image"))),o.attr("src",i)},modePreviewMarkAsChanged:function(t){var i=e(t),a=i.data("carouselTile"),o=i.data("editContainer"),n=Boolean(o.find(".state-changed").length>0);i.add(a).toggleClass("state-changed",n)},modePreviewMarkError:function(t){var i=this,a=e(t),o=a.find(".previewable-image"),n=e(t).data("carouselTile"),r=i.carousel;r&&n&&r.toggleTileError(r.getTileIndex(n),!0),o.closest("li").addClass("state-error")}}})}(jQuery,window);