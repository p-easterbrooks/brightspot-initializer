/*
 * Copyright 2015 Async-IO.org
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

!function(e,n){"function"==typeof define&&define.amd?define(n):e.atmosphere=n()}(this,function(){"use strict";var e,n="2.2.11-javascript",t={},o=!1,r=[],a=[],i=0,s=Object.prototype.hasOwnProperty;return t={onError:function(e){},onClose:function(e){},onOpen:function(e){},onReopen:function(e){},onMessage:function(e){},onReconnect:function(e,n){},onMessagePublished:function(e){},onTransportFailure:function(e,n){},onLocalMessage:function(e){},onFailureToReconnect:function(e,n){},onClientTimeout:function(e){},onOpenAfterResume:function(e){},WebsocketApiAdapter:function(e){var n,o;return e.onMessage=function(e){o.onmessage({data:e.responseBody})},e.onMessagePublished=function(e){o.onmessage({data:e.responseBody})},e.onOpen=function(e){o.onopen(e)},o={close:function(){n.close()},send:function(e){n.push(e)},onmessage:function(e){},onopen:function(e){},onclose:function(e){},onerror:function(e){}},n=new t.subscribe(e),o},AtmosphereRequest:function(e){function r(){ye=!0,ke=!1,Te=0,me=null,he=null,be=null,ve=null}function s(){p(),r()}function c(e){return"debug"==e?"debug"===pe.logLevel:"info"==e?"info"===pe.logLevel||"debug"===pe.logLevel:"warn"==e?"warn"===pe.logLevel||"info"===pe.logLevel||"debug"===pe.logLevel:"error"==e?"error"===pe.logLevel||"warn"===pe.logLevel||"info"===pe.logLevel||"debug"===pe.logLevel:!1}function l(e){c("debug")&&t.util.debug(new Date+" Atmosphere: "+e)}function u(e,n){return""===ge.partialMessage&&"streaming"===n.transport&&e.responseText.length>n.maxStreamingLength?!0:!1}function d(){if(pe.enableProtocol&&!pe.firstMessage){var e="X-Atmosphere-Transport=close&X-Atmosphere-tracking-id="+pe.uuid;t.util.each(pe.headers,function(n,o){var r=t.util.isFunction(o)?o.call(this,pe,pe,ge):o;null!=r&&(e+="&"+encodeURIComponent(n)+"="+encodeURIComponent(r))});var n=pe.url.replace(/([?&])_=[^&]*/,e);n+=n===pe.url?(/\?/.test(pe.url)?"&":"?")+e:"";var o={connected:!1},r=new t.AtmosphereRequest(o);r.connectTimeout=pe.connectTimeout,r.attachHeadersAsQueryString=!1,r.dropHeaders=!0,r.url=n,r.contentType="text/plain",r.transport="polling",r.method="GET",r.data="",r.heartbeat=null,pe.enableXDR&&(r.enableXDR=pe.enableXDR),r.async=pe.closeAsync,K("",r)}}function f(){c("debug")&&t.util.debug("Closing"),ke=!0,pe.reconnectId&&(clearTimeout(pe.reconnectId),delete pe.reconnectId),pe.heartbeatTimer&&clearTimeout(pe.heartbeatTimer),pe.reconnect=!1,ge.request=pe,ge.state="unsubscribe",ge.responseBody="",ge.status=408,ge.partialMessage="",le(),d(),p()}function p(){ge.partialMessage="",pe.id&&clearTimeout(pe.id),pe.heartbeatTimer&&clearTimeout(pe.heartbeatTimer),pe.reconnectId&&(clearTimeout(pe.reconnectId),delete pe.reconnectId),null!=ve&&(ve.close(),ve=null),null!=we&&(we.abort(),we=null),null!=be&&(be.abort(),be=null),null!=me&&(me.canSendMessage&&me.close(),me=null),null!=he&&(he.close(),he=null),g()}function g(){null!=ue&&(clearInterval(de),document.cookie=fe+"=; expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/",ue.signal("close",{reason:"",heir:ke?(ue.get("children")||[])[0]:Ie}),ue.close()),null!=xe&&xe.close()}function m(e){s(),pe=t.util.extend(pe,e),pe.mrequest=pe.reconnect,pe.reconnect||(pe.reconnect=!0)}function h(){return null!=pe.webSocketImpl||window.WebSocket||window.MozWebSocket}function b(){var e=t.util.getAbsoluteURL(pe.url.toLowerCase()),n=/^([\w\+\.\-]+:)(?:\/\/([^\/?#:]*)(?::(\d+))?)?/.exec(e),o=!(!n||n[1]==window.location.protocol&&n[2]==window.location.hostname&&(n[3]||("http:"===n[1]?80:443))==(window.location.port||("http:"===window.location.protocol?80:443)));return window.EventSource&&(!o||!t.util.browser.safari||t.util.browser.vmajor>=7)}function v(){if(pe.shared){if(xe=w(pe),null!=xe&&(c("debug")&&t.util.debug("Storage service available. All communication will be local"),xe.open(pe)))return;c("debug")&&t.util.debug("No Storage service available."),xe=null}pe.firstMessage=0==i?!0:!1,pe.isOpen=!1,pe.ctime=t.util.now(),0===pe.uuid&&(pe.uuid=i),ge.closedByClientTimeout=!1,"websocket"!==pe.transport&&"sse"!==pe.transport?P(pe):"websocket"===pe.transport?h()?I(!1):U("Websocket is not supported, using request.fallbackTransport ("+pe.fallbackTransport+")"):"sse"===pe.transport&&(b()?x(!1):U("Server Side Events(SSE) is not supported, using request.fallbackTransport ("+pe.fallbackTransport+")"))}function w(e){function n(e,n){var t,o=e.length;for(t=0;o>t;t++)e[t]===n&&e.splice(t,1);return o!==e.length}function o(n){var o=t.util.parseJSON(n),r=o.data;if("c"===o.target)switch(o.type){case"open":T("opening","local",pe);break;case"close":s||(s=!0,"aborted"===r.reason?f():r.heir===Ie?v():setTimeout(function(){v()},100));break;case"message":re(r,"messageReceived",200,e.transport);break;case"localMessage":oe(r)}}function r(){var e=new RegExp("(?:^|; )("+encodeURIComponent(c)+")=([^;]*)").exec(document.cookie);return e?t.util.parseJSON(decodeURIComponent(e[2])):void 0}var a,i,s,c="atmosphere-"+e.url,l={storage:function(){function r(e){e.key===c&&e.newValue&&o(e.newValue)}if(t.util.storage){var a=window.localStorage,i=function(e){return t.util.parseJSON(a.getItem(c+"-"+e))},s=function(e,n){a.setItem(c+"-"+e,t.util.stringifyJSON(n))};return{init:function(){return s("children",i("children").concat([Ie])),t.util.on(window,"storage",r),i("opened")},signal:function(e,n){a.setItem(c,t.util.stringifyJSON({target:"p",type:e,data:n}))},close:function(){var o=i("children");t.util.off(window,"storage",r),o&&n(o,e.id)&&s("children",o)}}}},windowref:function(){var e=window.open("",c.replace(/\W/g,""));if(e&&!e.closed&&e.callbacks)return{init:function(){return e.callbacks.push(o),e.children.push(Ie),e.opened},signal:function(n,o){!e.closed&&e.fire&&e.fire(t.util.stringifyJSON({target:"p",type:n,data:o}))},close:function(){s||(n(e.callbacks,o),n(e.children,Ie))}}}};return a=r(),!a||t.util.now()-a.ts>1e3||!(i=l.storage()||l.windowref())?void 0:{open:function(){var n;return de=setInterval(function(){var e=a;a=r(),a&&e.ts!==a.ts||o(t.util.stringifyJSON({target:"c",type:"close",data:{reason:"error",heir:e.heir}}))},1e3),n=i.init(),n&&setTimeout(function(){T("opening","local",e)},50),n},send:function(e){i.signal("send",e)},localSend:function(e){i.signal("localSend",t.util.stringifyJSON({id:Ie,event:e}))},close:function(){ke||(clearInterval(de),i.signal("close"),i.close())}}}function y(){function e(e){var n=t.util.parseJSON(e),o=n.data;if("p"===n.target)switch(n.type){case"send":G(o);break;case"localSend":oe(o);break;case"close":f()}}function n(){document.cookie=fe+"="+encodeURIComponent(t.util.stringifyJSON({ts:t.util.now()+1,heir:(o.get("children")||[])[0]}))+"; path=/"}var o,r="atmosphere-"+pe.url,a={storage:function(){function n(n){n.key===r&&n.newValue&&e(n.newValue)}if(t.util.storage){var o=window.localStorage;return{init:function(){t.util.on(window,"storage",n)},signal:function(e,n){o.setItem(r,t.util.stringifyJSON({target:"c",type:e,data:n}))},get:function(e){return t.util.parseJSON(o.getItem(r+"-"+e))},set:function(e,n){o.setItem(r+"-"+e,t.util.stringifyJSON(n))},close:function(){t.util.off(window,"storage",n),o.removeItem(r),o.removeItem(r+"-opened"),o.removeItem(r+"-children")}}}},windowref:function(){var n,o=r.replace(/\W/g,""),a=document.getElementById(o);return a||(a=document.createElement("div"),a.id=o,a.style.display="none",a.innerHTML='<iframe name="'+o+'" />',document.body.appendChild(a)),n=a.firstChild.contentWindow,{init:function(){n.callbacks=[e],n.fire=function(e){var t;for(t=0;t<n.callbacks.length;t++)n.callbacks[t](e)}},signal:function(e,o){!n.closed&&n.fire&&n.fire(t.util.stringifyJSON({target:"c",type:e,data:o}))},get:function(e){return n.closed?null:n[e]},set:function(e,t){n.closed||(n[e]=t)},close:function(){}}}};Ce=function(e){o.signal("message",e)},o=a.storage()||a.windowref(),o.init(),c("debug")&&t.util.debug("Installed StorageService "+o),o.set("children",[]),null==o.get("opened")||o.get("opened")||o.set("opened",!1),fe=encodeURIComponent(r),n(),de=setInterval(n,1e3),ue=o}function T(e,n,t){if(pe.shared&&"local"!==n&&y(),null!=ue&&ue.set("opened",!0),t.close=function(){f()},Te>0&&"re-connecting"===e)t.isReopen=!0,X(ge);else if(null==ge.error){ge.request=t;var o=ge.state;ge.state=e;var r=ge.transport;ge.transport=n;var a=ge.responseBody;le(),ge.responseBody=a,ge.state=o,ge.transport=r}}function S(e){e.transport="jsonp";var n,o=pe;null!=e&&"undefined"!=typeof e&&(o=e),we={open:function(){function r(){o.lastIndex=0,o.openId&&clearTimeout(o.openId),o.heartbeatTimer&&clearTimeout(o.heartbeatTimer),o.reconnect&&Te++<o.maxReconnectOnClose?(T("re-connecting",o.transport,o),H(we,o,e.reconnectInterval),o.openId=setTimeout(function(){D(o)},o.reconnectInterval+1e3)):B(0,"maxReconnectOnClose reached")}function a(){var t=o.url;null!=o.dispatchUrl&&(t+=o.dispatchUrl);var a=o.data;o.attachHeadersAsQueryString&&(t=q(o),""!==a&&(t+="&X-Atmosphere-Post-Body="+encodeURIComponent(a)),a="");var s=document.head||document.getElementsByTagName("head")[0]||document.documentElement;n=document.createElement("script"),n.src=t+"&jsonpTransport="+i,n.clean=function(){n.clean=n.onerror=n.onload=n.onreadystatechange=null,n.parentNode&&n.parentNode.removeChild(n),2===++e.scriptCount&&(e.scriptCount=1,r())},n.onload=n.onreadystatechange=function(){l("jsonp.onload"),(!n.readyState||/loaded|complete/.test(n.readyState))&&n.clean()},n.onerror=function(){l("jsonp.onerror"),e.scriptCount=1,n.clean()},s.insertBefore(n,s.firstChild)}var i="atmosphere"+ ++Ie;window[i]=function(n){if(l("jsonp.window"),e.scriptCount=0,o.reconnect&&-1===o.maxRequest||o.requestCount++<o.maxRequest){if(o.executeCallbackBeforeReconnect||H(we,o,o.pollingInterval),null!=n&&"string"!=typeof n)try{n=n.message}catch(r){}var a=M(n,o,ge);a||re(ge.responseBody,"messageReceived",200,o.transport),o.executeCallbackBeforeReconnect&&H(we,o,o.pollingInterval),L(o)}else t.util.log(pe.logLevel,["JSONP reconnect maximum try reached "+pe.requestCount]),B(0,"maxRequest reached")},setTimeout(function(){a()},50)},abort:function(){n&&n.clean&&n.clean()}},we.open()}function R(e){return null!=pe.webSocketImpl?pe.webSocketImpl:window.WebSocket?new WebSocket(e):new MozWebSocket(e)}function k(){return q(pe,t.util.getAbsoluteURL(pe.webSocketUrl||pe.url)).replace(/^http/,"ws")}function C(){var e=q(pe);return e}function x(e){ge.transport="sse";var n=C();if(c("debug")&&(t.util.debug("Invoking executeSSE"),t.util.debug("Using URL: "+n)),e&&!pe.reconnect)return void(null!=he&&p());try{he=new EventSource(n,{withCredentials:pe.withCredentials})}catch(o){return B(0,o),void U("SSE failed. Downgrading to fallback transport and resending")}pe.connectTimeout>0&&(pe.id=setTimeout(function(){e||p()},pe.connectTimeout)),he.onopen=function(n){l("sse.onopen"),L(pe),c("debug")&&t.util.debug("SSE successfully opened"),pe.enableProtocol?pe.isReopen&&(pe.isReopen=!1,T("re-opening",pe.transport,pe)):e?T("re-opening","sse",pe):T("opening","sse",pe),e=!0,"POST"===pe.method&&(ge.state="messageReceived",he.send(pe.data))},he.onmessage=function(e){if(l("sse.onmessage"),L(pe),!pe.enableXDR&&e.origin&&e.origin!==window.location.protocol+"//"+window.location.host)return void t.util.log(pe.logLevel,["Origin was not "+window.location.protocol+"//"+window.location.host]);ge.state="messageReceived",ge.status=200,e=e.data;var n=M(e,pe,ge);n||(le(),ge.responseBody="",ge.messages=[])},he.onerror=function(n){l("sse.onerror"),clearTimeout(pe.id),pe.heartbeatTimer&&clearTimeout(pe.heartbeatTimer),ge.closedByClientTimeout||(ce(e),p(),ke?t.util.log(pe.logLevel,["SSE closed normally"]):e?pe.reconnect&&"sse"===ge.transport&&(Te++<pe.maxReconnectOnClose?(T("re-connecting",pe.transport,pe),pe.reconnectInterval>0?pe.reconnectId=setTimeout(function(){x(!0)},pe.reconnectInterval):x(!0),ge.responseBody="",ge.messages=[]):(t.util.log(pe.logLevel,["SSE reconnect maximum try reached "+Te]),B(0,"maxReconnectOnClose reached"))):U("SSE failed. Downgrading to fallback transport and resending"))}}function I(e){ge.transport="websocket";var n=k(pe.url);if(c("debug")&&(t.util.debug("Invoking executeWebSocket"),t.util.debug("Using URL: "+n)),e&&!pe.reconnect)return void(null!=me&&p());me=R(n),null!=pe.webSocketBinaryType&&(me.binaryType=pe.webSocketBinaryType),pe.connectTimeout>0&&(pe.id=setTimeout(function(){if(e);else{var n={code:1002,reason:"",wasClean:!1};me.onclose(n);try{p()}catch(t){}}},pe.connectTimeout)),me.onopen=function(n){l("websocket.onopen"),L(pe),o=!1,c("debug")&&t.util.debug("Websocket successfully opened");var r=e;null!=me&&(me.canSendMessage=!0),pe.enableProtocol||(e=!0,r?T("re-opening","websocket",pe):T("opening","websocket",pe)),null!=me&&"POST"===pe.method&&(ge.state="messageReceived",me.send(pe.data))},me.onmessage=function(n){l("websocket.onmessage"),L(pe),pe.enableProtocol&&(e=!0),ge.state="messageReceived",ge.status=200,n=n.data;var t="string"==typeof n;if(t){var o=M(n,pe,ge);o||(le(),ge.responseBody="",ge.messages=[])}else{if(n=O(pe,n),""===n)return;ge.responseBody=n,le(),ge.responseBody=null}},me.onerror=function(e){l("websocket.onerror"),clearTimeout(pe.id),pe.heartbeatTimer&&clearTimeout(pe.heartbeatTimer)},me.onclose=function(n){if(l("websocket.onclose"),clearTimeout(pe.id),"closed"!==ge.state){var r=n.reason;if(""===r)switch(n.code){case 1e3:r="Normal closure; the connection successfully completed whatever purpose for which it was created.";break;case 1001:r="The endpoint is going away, either because of a server failure or because the browser is navigating away from the page that opened the connection.";break;case 1002:r="The endpoint is terminating the connection due to a protocol error.";break;case 1003:r="The connection is being terminated because the endpoint received data of a type it cannot accept (for example, a text-only endpoint received binary data).";break;case 1004:r="The endpoint is terminating the connection because a data frame was received that is too large.";break;case 1005:r="Unknown: no status code was provided even though one was expected.";break;case 1006:r="Connection was closed abnormally (that is, with no close frame being sent)."}if(c("warn")&&(t.util.warn("Websocket closed, reason: "+r),t.util.warn("Websocket closed, wasClean: "+n.wasClean)),ge.closedByClientTimeout||o)return void(pe.reconnectId&&(clearTimeout(pe.reconnectId),delete pe.reconnectId));ce(e),ge.state="closed",ke?t.util.log(pe.logLevel,["Websocket closed normally"]):e?pe.reconnect&&"websocket"===ge.transport&&(p(),Te++<pe.maxReconnectOnClose?(T("re-connecting",pe.transport,pe),pe.reconnectInterval>0?pe.reconnectId=setTimeout(function(){ge.responseBody="",ge.messages=[],I(!0)},pe.reconnectInterval):(ge.responseBody="",ge.messages=[],I(!0))):(t.util.log(pe.logLevel,["Websocket reconnect maximum try reached "+pe.requestCount]),c("warn")&&t.util.warn("Websocket error, reason: "+n.reason),B(0,"maxReconnectOnClose reached"))):U("Websocket failed. Downgrading to Comet and resending")}};var r=navigator.userAgent.toLowerCase(),a=r.indexOf("android")>-1;a&&void 0===me.url&&me.onclose({reason:"Android 4.1 does not support websockets.",wasClean:!1})}function O(e,n){var o=n;if("polling"===e.transport)return o;if(e.enableProtocol&&e.firstMessage&&0!==t.util.trim(n).length){var r=e.trackMessageLength?1:0,a=n.split(e.messageDelimiter);if(a.length<=r+1)return o;if(e.firstMessage=!1,e.uuid=t.util.trim(a[r]),a.length<=r+2&&t.util.log("error",["Protocol data not sent by the server. If you enable protocol on client side, be sure to install JavascriptProtocol interceptor on server side.Also note that atmosphere-runtime 2.2+ should be used."]),Se=parseInt(t.util.trim(a[r+1]),10),Re=a[r+2],"long-polling"!==e.transport&&D(e),i=e.uuid,o="",r=e.trackMessageLength?4:3,a.length>r+1)for(var s=r;s<a.length;s++)o+=a[s],s+1!==a.length&&(o+=e.messageDelimiter);0!==e.ackInterval&&setTimeout(function(){G("...ACK...")},e.ackInterval)}else e.enableProtocol&&e.firstMessage&&t.util.browser.msie&&+t.util.browser.version.split(".")[0]<10?t.util.log(pe.logLevel,["Receiving unexpected data from IE"]):D(e);return o}function L(e){clearTimeout(e.id),e.timeout>0&&"polling"!==e.transport&&(e.id=setTimeout(function(){A(e),d(),p()},e.timeout))}function A(e){ge.closedByClientTimeout=!0,ge.state="closedByClient",ge.responseBody="",ge.status=408,ge.messages=[],le()}function B(e,n){p(),clearTimeout(pe.id),ge.state="error",ge.reasonPhrase=n,ge.responseBody="",ge.status=e,ge.messages=[],le()}function M(e,n,t){if(e=O(n,e),0===e.length)return!0;if(t.responseBody=e,n.trackMessageLength){e=t.partialMessage+e;var o=[],r=e.indexOf(n.messageDelimiter);if(-1!=r){for(;-1!==r;){var a=e.substring(0,r),i=+a;if(isNaN(i))throw new Error('message length "'+a+'" is not a number');r+=n.messageDelimiter.length,r+i>e.length?r=-1:(o.push(e.substring(r,r+i)),e=e.substring(r+i,e.length),r=e.indexOf(n.messageDelimiter))}return t.partialMessage=e,0!==o.length?(t.responseBody=o.join(n.messageDelimiter),t.messages=o,!1):(t.responseBody="",t.messages=[],!0)}}return t.responseBody=e,t.messages=[e],!1}function U(e){t.util.log(pe.logLevel,[e]),"undefined"!=typeof pe.onTransportFailure?pe.onTransportFailure(e,pe):"undefined"!=typeof t.util.onTransportFailure&&t.util.onTransportFailure(e,pe),pe.transport=pe.fallbackTransport;var n=-1===pe.connectTimeout?0:pe.connectTimeout;pe.reconnect&&"none"!==pe.transport||null==pe.transport?(pe.method=pe.fallbackMethod,ge.transport=pe.fallbackTransport,pe.fallbackTransport="none",n>0?pe.reconnectId=setTimeout(function(){v()},n):v()):B(500,"Unable to reconnect with fallback transport")}function q(e,o){var r=pe;return null!=e&&"undefined"!=typeof e&&(r=e),null==o&&(o=r.url),r.attachHeadersAsQueryString?-1!==o.indexOf("X-Atmosphere-Framework")?o:(o+=-1!==o.indexOf("?")?"&":"?",o+="X-Atmosphere-tracking-id="+r.uuid,o+="&X-Atmosphere-Framework="+n,o+="&X-Atmosphere-Transport="+r.transport,r.trackMessageLength&&(o+="&X-Atmosphere-TrackMessageSize=true"),null!==r.heartbeat&&null!==r.heartbeat.server&&(o+="&X-Heartbeat-Server="+r.heartbeat.server),""!==r.contentType&&(o+="&Content-Type="+("websocket"===r.transport?r.contentType:encodeURIComponent(r.contentType))),r.enableProtocol&&(o+="&X-atmo-protocol=true"),t.util.each(r.headers,function(n,a){var i=t.util.isFunction(a)?a.call(this,r,e,ge):a;null!=i&&(o+="&"+encodeURIComponent(n)+"="+encodeURIComponent(i))}),o):o}function D(e){if(e.isOpen)if(e.isReopen)e.isReopen=!1,T("re-opening",e.transport,e);else{if("messageReceived"!==ge.state||"jsonp"!==e.transport&&"long-polling"!==e.transport)return;F(ge)}else e.isOpen=!0,T("opening",e.transport,e);E(e)}function E(e){if(null!=e.heartbeatTimer&&clearTimeout(e.heartbeatTimer),!isNaN(Se)&&Se>0){var n=function(){c("debug")&&t.util.debug("Sending heartbeat"),G(Re),e.heartbeatTimer=setTimeout(n,Se)};e.heartbeatTimer=setTimeout(n,Se)}}function P(e){var n=pe;if((null!=e||"undefined"!=typeof e)&&(n=e),n.lastIndex=0,n.readyState=0,"jsonp"===n.transport||n.enableXDR&&t.util.checkCORSSupport())return void S(n);if(t.util.browser.msie&&+t.util.browser.version.split(".")[0]<10){if("streaming"===n.transport)return void(n.enableXDR&&window.XDomainRequest?J(n):$(n));if(n.enableXDR&&window.XDomainRequest)return void J(n)}var o=function(t){n.lastIndex=0,t||n.reconnect&&Te++<n.maxReconnectOnClose?(ge.ffTryingReconnect=!0,T("re-connecting",e.transport,e),H(a,n,e.reconnectInterval)):B(0,"maxReconnectOnClose reached")},r=function(){ge.errorHandled=!0,p(),o(!1)};if(n.force||n.reconnect&&(-1===n.maxRequest||n.requestCount++<n.maxRequest)){n.force=!1;var a=t.util.xhr();a.hasData=!1,j(a,n,!0),n.suspend&&(be=a),"polling"!==n.transport&&(ge.transport=n.transport,a.onabort=function(){l("ajaxrequest.onabort"),ce(!0)},a.onerror=function(){l("ajaxrequest.onerror"),ge.error=!0,ge.ffTryingReconnect=!0;try{ge.status=XMLHttpRequest.status}catch(e){ge.status=500}ge.status||(ge.status=500),ge.errorHandled||(p(),o(!1))}),a.onreadystatechange=function(){if(l("ajaxRequest.onreadystatechange, new state: "+a.readyState),!ke){ge.error=null;var i=!1,s=!1;if("streaming"===n.transport&&n.readyState>2&&4===a.readyState)return p(),void o(!1);if(n.readyState=a.readyState,"streaming"===n.transport&&a.readyState>=3?s=!0:"long-polling"===n.transport&&4===a.readyState&&(s=!0),L(pe),"polling"!==n.transport){var c=200;if(4===a.readyState&&(c=a.status>1e3?0:a.status),!n.reconnectOnServerError&&c>=300&&600>c)return void B(c,a.statusText);if(c>=300||0===c)return void r();n.enableProtocol&&e.firstMessage||2!==a.readyState||(t.util.browser.mozilla&&ge.ffTryingReconnect?(ge.ffTryingReconnect=!1,setTimeout(function(){ge.ffTryingReconnect||D(n)},500)):D(n))}else 4===a.readyState&&(s=!0);if(s){var d=a.responseText;if(ge.errorHandled=!1,"long-polling"===n.transport&&0===t.util.trim(d).length)return void(a.hasData?a.hasData=!1:o(!0));if(a.hasData=!0,ae(a,pe),"streaming"===n.transport)if(t.util.browser.opera)t.util.iterate(function(){if(500!==ge.status&&a.responseText.length>n.lastIndex){try{ge.status=a.status,ge.headers=t.util.parseHeaders(a.getAllResponseHeaders()),ae(a,pe)}catch(e){ge.status=404}L(pe),ge.state="messageReceived";var o=a.responseText.substring(n.lastIndex);if(n.lastIndex=a.responseText.length,i=M(o,n,ge),i||le(),u(a,n))return void N(a,n)}else if(ge.status>400)return n.lastIndex=a.responseText.length,!1},0);else{var f=d.substring(n.lastIndex,d.length);if(i=M(f,n,ge),n.lastIndex=d.length,i)return}else i=M(d,n,ge);var g=u(a,n);try{ge.status=a.status,ge.headers=t.util.parseHeaders(a.getAllResponseHeaders()),ae(a,n)}catch(m){ge.status=404}n.suspend?ge.state=0===ge.status?"closed":"messageReceived":ge.state="messagePublished";var h=!g&&"streaming"!==e.transport&&"polling"!==e.transport;h&&!n.executeCallbackBeforeReconnect&&H(a,n,n.pollingInterval),0===ge.responseBody.length||i||le(),h&&n.executeCallbackBeforeReconnect&&H(a,n,n.pollingInterval),g&&N(a,n)}}};try{a.send(n.data),ye=!0}catch(i){t.util.log(n.logLevel,["Unable to connect to "+n.url]),B(0,i)}}else"debug"===n.logLevel&&t.util.log(n.logLevel,["Max re-connection reached."]),B(0,"maxRequest reached")}function N(e,n){ge.messages=[],n.isReopen=!0,f(),ke=!1,H(e,n,500)}function j(e,o,r){var a=o.url;null!=o.dispatchUrl&&"POST"===o.method&&(a+=o.dispatchUrl),a=q(o,a),a=t.util.prepareURL(a),r&&(e.open(o.method,a,o.async),o.connectTimeout>0&&(o.id=setTimeout(function(){0===o.requestCount&&(p(),re("Connect timeout","closed",200,o.transport))},o.connectTimeout))),pe.withCredentials&&"websocket"!==pe.transport&&"withCredentials"in e&&(e.withCredentials=!0),pe.dropHeaders||(e.setRequestHeader("X-Atmosphere-Framework",n),e.setRequestHeader("X-Atmosphere-Transport",o.transport),null!==o.heartbeat&&null!==o.heartbeat.server&&e.setRequestHeader("X-Heartbeat-Server",e.heartbeat.server),o.trackMessageLength&&e.setRequestHeader("X-Atmosphere-TrackMessageSize","true"),e.setRequestHeader("X-Atmosphere-tracking-id",o.uuid),t.util.each(o.headers,function(n,a){var i=t.util.isFunction(a)?a.call(this,e,o,r,ge):a;null!=i&&e.setRequestHeader(n,i)})),""!==o.contentType&&e.setRequestHeader("Content-Type",o.contentType)}function H(e,n,t){if(!ge.closedByClientTimeout&&(n.reconnect||n.suspend&&ye)){var o=0;e&&e.readyState>1&&(o=e.status>1e3?0:e.status),ge.status=0===o?204:o,ge.reason=0===o?"Server resumed the connection or down.":"OK",clearTimeout(n.id),n.reconnectId&&(clearTimeout(n.reconnectId),delete n.reconnectId),t>0?pe.reconnectId=setTimeout(function(){P(n)},t):P(n)}}function X(e){e.state="re-connecting",ie(e)}function F(e){e.state="openAfterResume",ie(e),e.state="messageReceived"}function J(e){"polling"!==e.transport?(ve=W(e),ve.open()):W(e).open()}function W(e){var n=pe;null!=e&&"undefined"!=typeof e&&(n=e);var o=n.transport,r=0,a=new window.XDomainRequest,i=function(){"long-polling"===n.transport&&n.reconnect&&(-1===n.maxRequest||n.requestCount++<n.maxRequest)&&(a.status=200,J(n))},s=n.rewriteURL||function(e){var n=/(?:^|;\s*)(JSESSIONID|PHPSESSID)=([^;]*)/.exec(document.cookie);switch(n&&n[1]){case"JSESSIONID":return e.replace(/;jsessionid=[^\?]*|(\?)|$/,";jsessionid="+n[2]+"$1");case"PHPSESSID":return e.replace(/\?PHPSESSID=[^&]*&?|\?|$/,"?PHPSESSID="+n[2]+"&").replace(/&$/,"")}return e};a.onprogress=function(){c(a)},a.onerror=function(){"polling"!==n.transport&&(p(),Te++<n.maxReconnectOnClose?n.reconnectInterval>0?n.reconnectId=setTimeout(function(){T("re-connecting",e.transport,e),J(n)},n.reconnectInterval):(T("re-connecting",e.transport,e),J(n)):B(0,"maxReconnectOnClose reached"))},a.onload=function(){};var c=function(e){clearTimeout(n.id);var a=e.responseText;if(a=a.substring(r),r+=a.length,"polling"!==o){L(n);var s=M(a,n,ge);if("long-polling"===o&&0===t.util.trim(a).length)return;n.executeCallbackBeforeReconnect&&i(),s||re(ge.responseBody,"messageReceived",200,o),n.executeCallbackBeforeReconnect||i()}};return{open:function(){var e=n.url;null!=n.dispatchUrl&&(e+=n.dispatchUrl),e=q(n,e),a.open(n.method,s(e)),"GET"===n.method?a.send():a.send(n.data),n.connectTimeout>0&&(n.id=setTimeout(function(){0===n.requestCount&&(p(),re("Connect timeout","closed",200,n.transport))},n.connectTimeout))},close:function(){a.abort()}}}function $(e){ve=z(e),ve.open()}function z(e){var n=pe;null!=e&&"undefined"!=typeof e&&(n=e);var o,r=new window.ActiveXObject("htmlfile");r.open(),r.close();var a=n.url;return null!=n.dispatchUrl&&(a+=n.dispatchUrl),"polling"!==n.transport&&(ge.transport=n.transport),{open:function(){var e=r.createElement("iframe");a=q(n),""!==n.data&&(a+="&X-Atmosphere-Post-Body="+encodeURIComponent(n.data)),a=t.util.prepareURL(a),e.src=a,r.body.appendChild(e);var i=e.contentDocument||e.contentWindow.document;o=t.util.iterate(function(){try{if(!i.firstChild)return;var e=i.body?i.body.lastChild:i,a=function(){var n=e.cloneNode(!0);n.appendChild(i.createTextNode("."));var t=n.innerText;return t=t.substring(0,t.length-1)};if(!i.body||!i.body.firstChild||"pre"!==i.body.firstChild.nodeName.toLowerCase()){var s=i.head||i.getElementsByTagName("head")[0]||i.documentElement||i,c=i.createElement("script");c.text="document.write('<plaintext>')",s.insertBefore(c,s.firstChild),s.removeChild(c),e=i.body.lastChild}return n.closed&&(n.isReopen=!0),o=t.util.iterate(function(){var t=a();if(t.length>n.lastIndex){L(pe),ge.status=200,ge.error=null,e.innerText="";var o=M(t,n,ge);if(o)return"";re(ge.responseBody,"messageReceived",200,n.transport)}return n.lastIndex=0,"complete"===i.readyState?(ce(!0),T("re-connecting",n.transport,n),n.reconnectInterval>0?n.reconnectId=setTimeout(function(){$(n)},n.reconnectInterval):$(n),!1):void 0},null),!1}catch(l){return ge.error=!0,T("re-connecting",n.transport,n),Te++<n.maxReconnectOnClose?n.reconnectInterval>0?n.reconnectId=setTimeout(function(){$(n)},n.reconnectInterval):$(n):B(0,"maxReconnectOnClose reached"),r.execCommand("Stop"),r.close(),!1}})},close:function(){o&&o(),r.execCommand("Stop"),ce(!0)}}}function G(e){null!=xe?Q(e):null!=be||null!=he?_(e):null!=ve?Y(e):null!=we?Z(e):null!=me?te(e):(B(0,"No suspended connection available"),t.util.error("No suspended connection available. Make sure atmosphere.subscribe has been called and request.onOpen invoked before trying to push data"))}function K(e,n){n||(n=ne(e)),n.transport="polling",n.method="GET",n.withCredentials=!1,n.reconnect=!1,n.force=!0,n.suspend=!1,n.timeout=1e3,P(n)}function Q(e){xe.send(e)}function V(e){if(0!==e.length)try{xe?xe.localSend(e):ue&&ue.signal("localMessage",t.util.stringifyJSON({id:Ie,event:e}))}catch(n){t.util.error(n)}}function _(e){var n=ne(e);P(n)}function Y(e){if(pe.enableXDR&&t.util.checkCORSSupport()){var n=ne(e);n.reconnect=!1,S(n)}else _(e)}function Z(e){_(e)}function ee(e){var n=e;return"object"==typeof n&&(n=e.data),n}function ne(e){var n=ee(e),o={connected:!1,timeout:6e4,method:"POST",url:pe.url,contentType:pe.contentType,headers:pe.headers,reconnect:!0,callback:null,data:n,suspend:!1,maxRequest:-1,logLevel:"info",requestCount:0,withCredentials:pe.withCredentials,async:pe.async,transport:"polling",isOpen:!0,attachHeadersAsQueryString:!0,enableXDR:pe.enableXDR,uuid:pe.uuid,dispatchUrl:pe.dispatchUrl,enableProtocol:!1,messageDelimiter:"|",trackMessageLength:pe.trackMessageLength,maxReconnectOnClose:pe.maxReconnectOnClose,heartbeatTimer:pe.heartbeatTimer,heartbeat:pe.heartbeat};return"object"==typeof e&&(o=t.util.extend(o,e)),o}function te(e){var n,o=t.util.isBinary(e)?e:ee(e);try{if(n=null!=pe.dispatchUrl?pe.webSocketPathDelimiter+pe.dispatchUrl+pe.webSocketPathDelimiter+o:o,!me.canSendMessage)return void t.util.error("WebSocket not connected.");me.send(n)}catch(r){me.onclose=function(e){},p(),U("Websocket failed. Downgrading to Comet and resending "+e),_(e)}}function oe(e){var n=t.util.parseJSON(e);n.id!==Ie&&("undefined"!=typeof pe.onLocalMessage?pe.onLocalMessage(n.event):"undefined"!=typeof t.util.onLocalMessage&&t.util.onLocalMessage(n.event))}function re(e,n,t,o){ge.responseBody=e,ge.transport=o,ge.status=t,ge.state=n,le()}function ae(e,n){if(n.readResponsesHeaders)try{var t=e.getResponseHeader("X-Atmosphere-tracking-id");t&&null!=t&&(n.uuid=t.split(" ").pop())}catch(o){}else n.enableProtocol||(n.uuid=Ie)}function ie(e){se(e,pe),se(e,t.util)}function se(e,n){switch(e.state){case"messageReceived":l("Firing onMessage"),Te=0,"undefined"!=typeof n.onMessage&&n.onMessage(e),"undefined"!=typeof n.onmessage&&n.onmessage(e);break;case"error":l("Firing onError"),"undefined"!=typeof n.onError&&n.onError(e),"undefined"!=typeof n.onerror&&n.onerror(e);break;case"opening":delete pe.closed,l("Firing onOpen"),"undefined"!=typeof n.onOpen&&n.onOpen(e),"undefined"!=typeof n.onopen&&n.onopen(e);break;case"messagePublished":l("Firing messagePublished"),"undefined"!=typeof n.onMessagePublished&&n.onMessagePublished(e);break;case"re-connecting":l("Firing onReconnect"),"undefined"!=typeof n.onReconnect&&n.onReconnect(pe,e);break;case"closedByClient":l("Firing closedByClient"),"undefined"!=typeof n.onClientTimeout&&n.onClientTimeout(pe);break;case"re-opening":delete pe.closed,l("Firing onReopen"),"undefined"!=typeof n.onReopen&&n.onReopen(pe,e);break;case"fail-to-reconnect":l("Firing onFailureToReconnect"),"undefined"!=typeof n.onFailureToReconnect&&n.onFailureToReconnect(pe,e);break;case"unsubscribe":case"closed":var t="undefined"!=typeof pe.closed?pe.closed:!1;t?l("Closed but not firing onClose"):(l("Firing onClose"),"undefined"!=typeof n.onClose&&n.onClose(e),"undefined"!=typeof n.onclose&&n.onclose(e)),pe.closed=!0;break;case"openAfterResume":"undefined"!=typeof n.onOpenAfterResume&&n.onOpenAfterResume(pe)}}function ce(e){"closed"!==ge.state&&(ge.state="closed",ge.responseBody="",ge.messages=[],ge.status=e?200:501,le())}function le(){var e=function(e,n){n(ge)};null==xe&&null!=Ce&&Ce(ge.responseBody),pe.reconnect=pe.mrequest;for(var n="string"==typeof ge.responseBody,o=n&&pe.trackMessageLength?ge.messages.length>0?ge.messages:[""]:new Array(ge.responseBody),r=0;r<o.length;r++)if(!(o.length>1&&0===o[r].length||(ge.responseBody=n?t.util.trim(o[r]):o[r],null==xe&&null!=Ce&&Ce(ge.responseBody),(0===ge.responseBody.length||n&&Re===ge.responseBody)&&"messageReceived"===ge.state))){if(ie(ge),a.length>0){c("debug")&&t.util.debug("Invoking "+a.length+" global callbacks: "+ge.state);try{t.util.each(a,e)}catch(i){t.util.log(pe.logLevel,["Callback exception"+i])}}if("function"==typeof pe.callback){c("debug")&&t.util.debug("Invoking request callbacks");try{pe.callback(ge)}catch(i){t.util.log(pe.logLevel,["Callback exception"+i])}}}}var ue,de,fe,pe={timeout:3e5,method:"GET",headers:{},contentType:"",callback:null,url:"",data:"",suspend:!0,maxRequest:-1,reconnect:!0,maxStreamingLength:1e7,lastIndex:0,logLevel:"info",requestCount:0,fallbackMethod:"GET",fallbackTransport:"streaming",transport:"long-polling",webSocketImpl:null,webSocketBinaryType:null,dispatchUrl:null,webSocketPathDelimiter:"@@",enableXDR:!1,rewriteURL:!1,attachHeadersAsQueryString:!0,executeCallbackBeforeReconnect:!1,readyState:0,withCredentials:!1,trackMessageLength:!1,messageDelimiter:"|",connectTimeout:-1,reconnectInterval:0,dropHeaders:!0,uuid:0,async:!0,shared:!1,readResponsesHeaders:!1,maxReconnectOnClose:5,enableProtocol:!0,pollingInterval:0,heartbeat:{client:null,
server:null},ackInterval:0,closeAsync:!1,reconnectOnServerError:!0,onError:function(e){},onClose:function(e){},onOpen:function(e){},onMessage:function(e){},onReopen:function(e,n){},onReconnect:function(e,n){},onMessagePublished:function(e){},onTransportFailure:function(e,n){},onLocalMessage:function(e){},onFailureToReconnect:function(e,n){},onClientTimeout:function(e){},onOpenAfterResume:function(e){}},ge={status:200,reasonPhrase:"OK",responseBody:"",messages:[],headers:[],state:"messageReceived",transport:"polling",error:null,request:null,partialMessage:"",errorHandled:!1,closedByClientTimeout:!1,ffTryingReconnect:!1},me=null,he=null,be=null,ve=null,we=null,ye=!0,Te=0,Se=0,Re=" ",ke=!1,Ce=null,xe=null,Ie=t.util.now();m(e),this.subscribe=function(e){m(e),v()},this.execute=function(){v()},this.close=function(){f()},this.disconnect=function(){d()},this.getUrl=function(){return pe.url},this.push=function(e,n){if(null!=n){var t=pe.dispatchUrl;pe.dispatchUrl=n,G(e),pe.dispatchUrl=t}else G(e)},this.getUUID=function(){return pe.uuid},this.pushLocal=function(e){V(e)},this.enableProtocol=function(e){return pe.enableProtocol},this.init=function(){r()},this.request=pe,this.response=ge}},t.subscribe=function(e,n,o){"function"==typeof n&&t.addCallback(n),"string"!=typeof e?o=e:o.url=e,i="undefined"!=typeof o&&"undefined"!=typeof o.uuid?o.uuid:0;var a=new t.AtmosphereRequest(o);return a.execute(),r[r.length]=a,a},t.unsubscribe=function(){if(r.length>0)for(var e=[].concat(r),n=0;n<e.length;n++){var t=e[n];t.close(),clearTimeout(t.response.request.id),t.heartbeatTimer&&clearTimeout(t.heartbeatTimer)}r=[],a=[]},t.unsubscribeUrl=function(e){var n=-1;if(r.length>0)for(var t=0;t<r.length;t++){var o=r[t];if(o.getUrl()===e){o.close(),clearTimeout(o.response.request.id),o.heartbeatTimer&&clearTimeout(o.heartbeatTimer),n=t;break}}n>=0&&r.splice(n,1)},t.addCallback=function(e){-1===t.util.inArray(e,a)&&a.push(e)},t.removeCallback=function(e){var n=t.util.inArray(e,a);-1!==n&&a.splice(n,1)},t.util={browser:{},parseHeaders:function(e){for(var n,t=/^(.*?):[ \t]*([^\r\n]*)\r?$/gm,o={};n=t.exec(e);)o[n[1]]=n[2];return o},now:function(){return(new Date).getTime()},isArray:function(e){return"[object Array]"===Object.prototype.toString.call(e)},inArray:function(e,n){if(!Array.prototype.indexOf){for(var t=n.length,o=0;t>o;++o)if(n[o]===e)return o;return-1}return n.indexOf(e)},isBinary:function(e){return/^\[object\s(?:Blob|ArrayBuffer|.+Array)\]$/.test(Object.prototype.toString.call(e))},isFunction:function(e){return"[object Function]"===Object.prototype.toString.call(e)},getAbsoluteURL:function(e){var n=document.createElement("div");return n.innerHTML='<a href="'+e+'"/>',encodeURI(decodeURI(n.firstChild.href))},prepareURL:function(e){var n=t.util.now(),o=e.replace(/([?&])_=[^&]*/,"$1_="+n);return o+(o===e?(/\?/.test(e)?"&":"?")+"_="+n:"")},trim:function(e){return String.prototype.trim?e.toString().trim():e.toString().replace(/(?:(?:^|\n)\s+|\s+(?:$|\n))/g,"").replace(/\s+/g," ")},param:function(e){function n(e,n){n=t.util.isFunction(n)?n():null==n?"":n,a.push(encodeURIComponent(e)+"="+encodeURIComponent(n))}function o(e,r){var a;if(t.util.isArray(r))t.util.each(r,function(t,r){/\[\]$/.test(e)?n(e,r):o(e+"["+("object"==typeof r?t:"")+"]",r)});else if("[object Object]"===Object.prototype.toString.call(r))for(a in r)o(e+"["+a+"]",r[a]);else n(e,r)}var r,a=[];for(r in e)o(r,e[r]);return a.join("&").replace(/%20/g,"+")},storage:function(){try{return!(!window.localStorage||!window.StorageEvent)}catch(e){return!1}},iterate:function(e,n){var t;return n=n||0,function o(){t=setTimeout(function(){e()!==!1&&o()},n)}(),function(){clearTimeout(t)}},each:function(e,n,o){if(e){var r,a=0,i=e.length,s=t.util.isArray(e);if(o){if(s)for(;i>a&&(r=n.apply(e[a],o),r!==!1);a++);else for(a in e)if(r=n.apply(e[a],o),r===!1)break}else if(s)for(;i>a&&(r=n.call(e[a],a,e[a]),r!==!1);a++);else for(a in e)if(r=n.call(e[a],a,e[a]),r===!1)break;return e}},extend:function(e){var n,t,o;for(n=1;n<arguments.length;n++)if(null!=(t=arguments[n]))for(o in t)e[o]=t[o];return e},on:function(e,n,t){e.addEventListener?e.addEventListener(n,t,!1):e.attachEvent&&e.attachEvent("on"+n,t)},off:function(e,n,t){e.removeEventListener?e.removeEventListener(n,t,!1):e.detachEvent&&e.detachEvent("on"+n,t)},log:function(e,n){if(window.console){var t=window.console[e];"function"==typeof t&&t.apply(window.console,n)}},warn:function(){t.util.log("warn",arguments)},info:function(){t.util.log("info",arguments)},debug:function(){t.util.log("debug",arguments)},error:function(){t.util.log("error",arguments)},xhr:function(){try{return new window.XMLHttpRequest}catch(e){try{return new window.ActiveXObject("Microsoft.XMLHTTP")}catch(n){}}},parseJSON:function(e){return e?window.JSON&&window.JSON.parse?window.JSON.parse(e):new Function("return "+e)():null},stringifyJSON:function(e){function n(e){return'"'+e.replace(o,function(e){var n=r[e];return"string"==typeof n?n:"\\u"+("0000"+e.charCodeAt(0).toString(16)).slice(-4)})+'"'}function t(e){return 10>e?"0"+e:e}var o=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,r={"\b":"\\b","	":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"};return window.JSON&&window.JSON.stringify?window.JSON.stringify(e):function a(e,o){var r,i,c,l,u=o[e],d=typeof u;switch(u&&"object"==typeof u&&"function"==typeof u.toJSON&&(u=u.toJSON(e),d=typeof u),d){case"string":return n(u);case"number":return isFinite(u)?String(u):"null";case"boolean":return String(u);case"object":if(!u)return"null";switch(Object.prototype.toString.call(u)){case"[object Date]":return isFinite(u.valueOf())?'"'+u.getUTCFullYear()+"-"+t(u.getUTCMonth()+1)+"-"+t(u.getUTCDate())+"T"+t(u.getUTCHours())+":"+t(u.getUTCMinutes())+":"+t(u.getUTCSeconds())+'Z"':"null";case"[object Array]":for(c=u.length,l=[],r=0;c>r;r++)l.push(a(r,u)||"null");return"["+l.join(",")+"]";default:l=[];for(r in u)s.call(u,r)&&(i=a(r,u),i&&l.push(n(r)+":"+i));return"{"+l.join(",")+"}"}}}("",{"":e})},checkCORSSupport:function(){if(t.util.browser.msie&&!window.XDomainRequest&&+t.util.browser.version.split(".")[0]<11)return!0;if(t.util.browser.opera&&+t.util.browser.version.split(".")<12)return!0;if("KreaTVWebKit/531"===t.util.trim(navigator.userAgent).slice(0,16))return!0;if("kreatel"===t.util.trim(navigator.userAgent).slice(-7).toLowerCase())return!0;var e=navigator.userAgent.toLowerCase(),n=e.indexOf("android")>-1;return n?!0:!1}},e=t.util.now(),function(){var e=navigator.userAgent.toLowerCase(),n=/(chrome)[ \/]([\w.]+)/.exec(e)||/(opera)(?:.*version|)[ \/]([\w.]+)/.exec(e)||/(msie) ([\w.]+)/.exec(e)||/(trident)(?:.*? rv:([\w.]+)|)/.exec(e)||e.indexOf("android")<0&&/version\/(.+) (safari)/.exec(e)||e.indexOf("compatible")<0&&/(mozilla)(?:.*? rv:([\w.]+)|)/.exec(e)||[];"safari"===n[2]&&(n[2]=n[1],n[1]="safari"),t.util.browser[n[1]||""]=!0,t.util.browser.version=n[2]||"0",t.util.browser.vmajor=t.util.browser.version.split(".")[0],t.util.browser.trident&&(t.util.browser.msie=!0),(t.util.browser.msie||t.util.browser.mozilla&&1===+t.util.browser.version.split(".")[0])&&(t.util.storage=!1)}(),t.util.on(window,"unload",function(e){t.util.debug(new Date+" Atmosphere: unload event"),t.unsubscribe()}),t.util.on(window,"beforeunload",function(e){t.util.debug(new Date+" Atmosphere: beforeunload event")}),t.util.on(window,"keypress",function(e){(27===e.charCode||27===e.keyCode)&&e.preventDefault&&e.preventDefault()}),t.util.on(window,"offline",function(){if(o=!0,r.length>0)for(var e=[].concat(r),n=0;n<e.length;n++){var t=e[n];t.close(),clearTimeout(t.response.request.id),t.heartbeatTimer&&clearTimeout(t.heartbeatTimer)}}),t.util.on(window,"online",function(){if(r.length>0)for(var e=0;e<r.length;e++)r[e].init(),r[e].execute();o=!1}),t});