/*!
Copyright (c) 2014 Dominik Moritz

This file is part of the leaflet locate control. It is licensed under the MIT license.
You can find the project at: https://github.com/domoritz/leaflet-locatecontrol
*/

!function(t,o){"function"==typeof define&&define.amd?define(["leaflet"],t):"object"==typeof exports&&(module.exports=t(require("leaflet"))),"undefined"!=typeof o&&o.L&&(o.L.Locate=t(L))}(function(t){return t.Control.Locate=t.Control.extend({options:{position:"topleft",drawCircle:!0,follow:!1,stopFollowingOnDrag:!1,remainActive:!1,markerClass:t.circleMarker,circleStyle:{color:"#136AEC",fillColor:"#136AEC",fillOpacity:.15,weight:2,opacity:.5},markerStyle:{color:"#136AEC",fillColor:"#2A93EE",fillOpacity:.7,weight:2,opacity:.9,radius:5},followCircleStyle:{},followMarkerStyle:{},icon:"fa fa-map-marker",iconLoading:"fa fa-spinner fa-spin",circlePadding:[0,0],metric:!0,onLocationError:function(t){alert(t.message)},onLocationOutsideMapBounds:function(t){t.stop(),alert(t.options.strings.outsideMapBoundsMsg)},setView:!0,keepCurrentZoomLevel:!1,showPopup:!0,strings:{title:"Show me where I am",popup:"You are within {distance} {unit} from this point",outsideMapBoundsMsg:"You seem located outside the boundaries of the map"},locateOptions:{maxZoom:1/0,watch:!0}},initialize:function(o){t.Map.addInitHook(function(){this.options.locateControl&&(this.locateControl=t.control.locate(),this.addControl(this.locateControl))});for(var i in o)"object"==typeof this.options[i]?t.extend(this.options[i],o[i]):this.options[i]=o[i];t.extend(this.options.locateOptions,{setView:!1})},_activate:function(){this.options.setView&&(this._locateOnNextLocationFound=!0),this._active||this._map.locate(this.options.locateOptions),this._active=!0,this.options.follow&&this._startFollowing(this._map)},_deactivate:function(){this._map.stopLocate(),this._map.off("dragstart",this._stopFollowing),this.options.follow&&this._following&&this._stopFollowing(this._map)},drawMarker:function(o){void 0===this._event.accuracy&&(this._event.accuracy=0);var i=this._event.accuracy;this._locateOnNextLocationFound&&(this._isOutsideMapBounds()?this.options.onLocationOutsideMapBounds(this):o.fitBounds(this._event.bounds,{padding:this.options.circlePadding,maxZoom:this.options.keepCurrentZoomLevel?o.getZoom():this.options.locateOptions.maxZoom}),this._locateOnNextLocationFound=!1);var s,e;if(this.options.drawCircle)if(s=this._following?this.options.followCircleStyle:this.options.circleStyle,this._circle){this._circle.setLatLng(this._event.latlng).setRadius(i);for(e in s)this._circle.options[e]=s[e]}else this._circle=t.circle(this._event.latlng,i,s).addTo(this._layer);var n,a;this.options.metric?(n=i.toFixed(0),a="meters"):(n=(3.2808399*i).toFixed(0),a="feet");var l;l=this._following?this.options.followMarkerStyle:this.options.markerStyle,this._marker?this.updateMarker(this._event.latlng,l):this._marker=this.createMarker(this._event.latlng,l).addTo(this._layer);var r=this.options.strings.popup;this.options.showPopup&&r&&this._marker.bindPopup(t.Util.template(r,{distance:n,unit:a}))._popup.setLatLng(this._event.latlng),this._toggleContainerStyle()},createMarker:function(t,o){return this.options.markerClass(t,o)},updateMarker:function(t,i){this._marker.setLatLng(t);for(o in i)this._marker.options[o]=i[o]},removeMarker:function(){this._layer.clearLayers(),this._marker=void 0,this._circle=void 0},onAdd:function(o){var i=t.DomUtil.create("div","leaflet-control-locate leaflet-bar leaflet-control");this._layer=new t.LayerGroup,this._layer.addTo(o),this._event=void 0;var s={};return t.extend(s,this.options.markerStyle,this.options.followMarkerStyle),this.options.followMarkerStyle=s,s={},t.extend(s,this.options.circleStyle,this.options.followCircleStyle),this.options.followCircleStyle=s,this._link=t.DomUtil.create("a","leaflet-bar-part leaflet-bar-part-single",i),this._link.href="#",this._link.title=this.options.strings.title,this._icon=t.DomUtil.create("span",this.options.icon,this._link),t.DomEvent.on(this._link,"click",t.DomEvent.stopPropagation).on(this._link,"click",t.DomEvent.preventDefault).on(this._link,"click",function(){var t=void 0===this._event||this._map.getBounds().contains(this._event.latlng)||!this.options.setView||this._isOutsideMapBounds();!this.options.remainActive&&this._active&&t?this.stop():this.start()},this).on(this._link,"dblclick",t.DomEvent.stopPropagation),this._resetVariables(),this.bindEvents(o),i},bindEvents:function(t){t.on("locationfound",this._onLocationFound,this),t.on("locationerror",this._onLocationError,this),t.on("unload",this.stop,this)},start:function(){this._activate(),this._event?this.drawMarker(this._map):this._setClasses("requesting")},stop:function(){this._deactivate(),this._cleanClasses(),this._resetVariables(),this.removeMarker()},_onLocationError:function(t){3==t.code&&this.options.locateOptions.watch||(this._deactivate(this),this.options.onLocationError(t))},_onLocationFound:function(t){this._event&&this._event.latlng.lat===t.latlng.lat&&this._event.latlng.lng===t.latlng.lng&&this._event.accuracy===t.accuracy||this._active&&(this._event=t,this.options.follow&&this._following&&(this._locateOnNextLocationFound=!0),this.drawMarker(this._map))},_startFollowing:function(){this._map.fire("startfollowing",this),this._following=!0,this.options.stopFollowingOnDrag&&this._map.on("dragstart",this._stopFollowing,this)},_stopFollowing:function(){this._map.fire("stopfollowing",this),this._following=!1,this.options.stopFollowingOnDrag&&this._map.off("dragstart",this._stopFollowing),this._toggleContainerStyle()},_isOutsideMapBounds:function(){return void 0===this._event?!1:this._map.options.maxBounds&&!this._map.options.maxBounds.contains(this._event.latlng)},_toggleContainerStyle:function(){this._container&&(this._following?this._setClasses("following"):this._setClasses("active"))},_setClasses:function(o){"requesting"==o?(t.DomUtil.removeClasses(this._container,"active following"),t.DomUtil.addClasses(this._container,"requesting"),t.DomUtil.removeClasses(this._icon,this.options.icon),t.DomUtil.addClasses(this._icon,this.options.iconLoading)):"active"==o?(t.DomUtil.removeClasses(this._container,"requesting following"),t.DomUtil.addClasses(this._container,"active"),t.DomUtil.removeClasses(this._icon,this.options.iconLoading),t.DomUtil.addClasses(this._icon,this.options.icon)):"following"==o&&(t.DomUtil.removeClasses(this._container,"requesting"),t.DomUtil.addClasses(this._container,"active following"),t.DomUtil.removeClasses(this._icon,this.options.iconLoading),t.DomUtil.addClasses(this._icon,this.options.icon))},_cleanClasses:function(){t.DomUtil.removeClass(this._container,"requesting"),t.DomUtil.removeClass(this._container,"active"),t.DomUtil.removeClass(this._container,"following")},_resetVariables:function(){this._active=!1,this._locateOnNextLocationFound=this.options.setView,this._following=!1}}),t.Map.addInitHook(function(){this.options.locateControl&&(this.locateControl=t.control.locate(),this.addControl(this.locateControl))}),t.control.locate=function(o){return new t.Control.Locate(o)},function(){var o=function(o,i,s){s=s.split(" "),s.forEach(function(s){t.DomUtil[o].call(this,i,s)})};t.DomUtil.addClasses=function(t,i){o("addClass",t,i)},t.DomUtil.removeClasses=function(t,i){o("removeClass",t,i)}}(),t.Control.Locate},window);