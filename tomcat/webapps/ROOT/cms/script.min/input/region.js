define(["jquery","jquery.extra","input/leaflet"],function(e){e.plugin2("regionMap",{_create:function(r){var o=L.map(r,{scrollWheelZoom:!1});(new L.TileLayer.MapQuestOpenOSM).addTo(o);var t=e(r).find(".regionMapZoom"),a=e(r).find(".regionMapCenter"),n=e(r).find(".regionMapGeoJson"),i=e.parseJSON(e(n).val()),l={color:"#3a87ad",opacity:1,weight:4,fillColor:"#3a87ad",fillOpacity:.5},c=t.val(),s=e.parseJSON(a.val());o.setView([s.lat,s.lng],c);var d=new L.FeatureGroup;o.addLayer(d),i.geometries&&i.geometries.forEach(function(e){"Circle"==e.type&&(e.type="Point",Array.isArray(e.coordinates)&&e.coordinates.length>0&&Array.isArray(e.coordinates[0])&&e.coordinates[0].length>1&&(e.coordinates=[e.coordinates[0][1],e.coordinates[0][0]]))});var g=L.GeoJSON.geometryToLayer(i,function(e,r){return e.geometry&&"Point"==e.geometry.type&&e.geometry.radius>0?new L.Circle(r,e.geometry.radius):new L.Marker(r)});for(x in g.getLayers()){var y=g.getLayers()[x];if(y instanceof L.MultiPolygon){var p=y.getLatLngs();for(x in p){var u=new L.Polygon(p[x],{shapeOptions:l});d.addLayer(u)}}else y.setStyle&&y.setStyle(l),d.addLayer(y)}d.setStyle(l);var f=new L.Control.Draw({draw:{polyline:!1,rectangle:!1,marker:!1,polygon:{allowIntersection:!1,shapeOptions:l},circle:{shapeOptions:l}},edit:{featureGroup:d,remove:!0}});o.addControl(f),new L.Control.GeoSearch({zoomLevel:16,provider:new L.GeoSearch.Provider.OpenStreetMap}).addTo(o),e("#leaflet-control-geosearch-qry").keypress(function(e){13===e.which&&e.preventDefault()}),L.control.locate({drawCircle:!1,markerClass:L.marker,icon:"icon icon-map-marker",iconLoading:"icon icon-rss",strings:{title:"Set marker to your current location",popup:"<b>Current location</b><br/>(within {distance} {unit})"}}).addTo(o);var v=L.Circle.prototype.toGeoJSON;L.Circle.include({toGeoJSON:function(){var e=v.call(this);return e.geometry={type:"Circle",coordinates:[[this.getLatLng().lat,this.getLatLng().lng]],radius:this.getRadius()},e}});var m=function(e){var r=d.toGeoJSON();n.val(JSON.stringify(r))};o.on("dragend",function(e){t.val(o.getZoom()),a.val(JSON.stringify(o.getCenter()))}),o.on("zoomend",function(e){t.val(o.getZoom()),a.val(JSON.stringify(o.getCenter()))}),o.on("draw:created",function(e){d.addLayer(e.layer),m(e)}),o.on("draw:edited",m),o.on("draw:deleted",m)}})});