define(["jquery","bsp-utils"],function(t,e){var a,i=t(window);!function(){var e=Math.random(),i=.618033988749895;a=function(a){var r=t.data(a[0],"workflow-transitionColor");return r||(e+=i,e%=1,r="hsl("+360*e+", 50%, 50%)",t.data(a[0],"workflow-transitionColor",r)),r}}(),e.onDomInsert(document,".workflow",{insert:function(e){var r,o,n,s,d,l,p,f,u,c=t(e),w=t.parseJSON(c.val())||{},g={},h=0;r=t("<div/>",{"class":"workflowVisual"}),o=function(t,e,a,i,r){var o,n,s,d,l,p,f,u,c,w,g=a.position(),h=g.left;return"undefined"==typeof r&&(p=i,f=p.position(),i=f.left,r=f.top),h>i?(o=g.top+.9*a.outerHeight(),u=-1,c=1,p&&(i+=p.outerWidth(),r+=.9*p.outerHeight())):(h+=a.outerWidth(),o=g.top+.1*a.outerHeight(),u=1,c=-1,p&&(r+=.1*p.outerHeight())),s=h+100*u,n=o,l=i+100*c,d=r,t.strokeStyle=e,t.fillStyle=e,t.lineWidth=1,t.beginPath(),t.moveTo(h,o),t.bezierCurveTo(s,n,l,d,i,r),t.stroke(),w=i>l?5:-5,t.beginPath(),t.moveTo(i,r),t.lineTo(i-2*w,r-w),t.lineTo(i-2*w,r+w),t.closePath(),t.fill(),{sourceX:h,sourceY:o,targetX:i,targetY:r}},r.append(n=t("<canvas/>",{css:{left:0,position:"absolute",top:0,"z-index":-1}})),n.bind("redraw",function(e,i,s,d){var l,p,f,u,h=this.getContext("2d"),v=n.outerWidth(),k=n.outerHeight();w={states:[],transitions:[]},h.clearRect(0,0,r.width(),r.height()),r.find(".workflowState").each(function(){var e=t(this),i=e.attr("data-id"),s=e.position(),d=t.data(this,"workflow-targets");"initial"!==i&&"final"!==i&&(f=parseFloat(s.left/v),l=parseFloat((v-e.outerWidth())/v),u=parseFloat(s.top/k),p=parseFloat((k-e.outerHeight())/k),w.states.push({id:i,displayName:e.find(':input[type="text"]').val(),name:e.find(':input[type="hidden"]').val()||e.find(':input[type="text"]').val(),left:f,top:u}),f>l&&e.css("left",100*l+"%"),u>p&&e.css("top",100*p+"%")),d&&t.each(d,function(s,d){var l,p,f,u,c,v,k=d.target,m=r.find('[data-id="'+k+'"]');0!==m.length&&(l=i+"/"+k,p=g[l],p||(p=t("<div/>",{"class":"workflowTransition"}),p.append(t("<input/>",{type:"text","class":"expandable workflowTransitionName",value:d.displayName||d.name||""})),p.append(t("<input/>",{type:"hidden",value:d.name||""})),p.append(t("<a/>",{"class":"workflowTransitionRemove",text:"Remove",click:function(){var a=t.data(e[0],"workflow-targets");return a&&t.data(e[0],"workflow-targets",t.map(a,function(t){return t.source===i&&t.target===k?null:t})),g[l]=void 0,p.remove(),n.trigger("redraw"),!1}})),r.append(p),g[l]=p,r.trigger("create")),f=p.find(':input[type="text"]'),u=a(p),c=o(h,u,e,m),v=c.sourceX<c.targetX?.3:.7,p.css({left:(c.sourceX+c.targetX-f.outerWidth())/2,top:(c.sourceY+c.targetY-f.outerHeight())/2}),f.css({"border-color":u}),w.transitions.push({displayName:f.val(),name:p.find(':input[type="hidden"]').val()||f.val(),source:i,target:k}))})}),c.val(JSON.stringify(w)),i&&o(h,"black",i,s,d)}),r.delegate(":input","input",function(){n.trigger("redraw")}),s=function(e){var a,i=r.find('[data-id="'+e.source+'"]');i.length>0&&(a=t.data(i[0],"workflow-targets")||[],a.push(e),t.data(i[0],"workflow-targets",a))},d=function(e){e.append(t("<a/>",{"class":"workflowTransitionAdd",text:"Add "+(c.attr("data-transition-label")||"Transition"),click:function(){return r.is(".workflowVisual-addingTransition")?!0:(r.addClass("workflowVisual-addingTransition"),i.bind("mousemove.workflows",t.throttle(50,function(t){var a=r.offset();n.trigger("redraw",[e,t.pageX-a.left,t.pageY-a.top])})),i.bind("click.workflows",function(a){var o=t(a.target).closest(".workflowState");return o.length>0&&s({source:e.attr("data-id"),target:o.attr("data-id")}),r.removeClass("workflowVisual-addingTransition"),i.unbind(".workflows"),n.trigger("redraw"),!1}),!1)}}))},l=function(e){var a;return r.prepend(a=t("<div/>",{"class":"workflowState","data-id":e.id,css:{left:Math.min(100*e.left,99.9)+"%",top:Math.min(100*e.top,99.9)+"%"},mousedown:function(e){t.drag(this,e,function(t,e){e.delta=a.position(),e.delta.left-=t.pageX,e.delta.top-=t.pageY},function(t,e){a.css({left:t.pageX+e.delta.left,top:t.pageY+e.delta.top}),n.trigger("redraw")},function(t){})}})),a.append(t("<input/>",{type:"text","class":"expandable workflowStateName",value:e.displayName||e.name||""})),a.append(t("<input/>",{type:"hidden",value:e.name||""})),a.append(t("<a/>",{"class":"workflowStateRemove",text:"Remove",click:function(){return a.remove(),n.trigger("redraw"),!1}})),d(a),r.css("height",100*r.find(".workflowState").length),n.attr({width:r.width(),height:r.height()}),a},r.append(p=t("<a/>",{"class":"workflowStateAdd",text:"Add "+(c.attr("data-state-label")||"State"),click:function(){return l({id:h,left:.3,top:.01}),++h,n.trigger("redraw"),!1}})),r.append(f=t("<div/>",{"class":"workflowState","data-id":"initial",text:c.attr("data-state-initial")||"Initial State"})),d(f),r.append(u=t("<div/>",{"class":"workflowState","data-id":"final",text:c.attr("data-state-final")||"Final State"})),w.states&&t.each(w.states,function(){var t=parseInt(this.id,10);l(this),t>=h&&(h=t+1)}),c.after(r),r.trigger("create"),c.hide(),n.attr({width:r.width(),height:r.height()}),w.transitions&&(t.each(w.transitions,function(){s(this)}),n.trigger("redraw"))}})});